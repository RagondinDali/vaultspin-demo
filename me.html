<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>VaultSpin â€“ Mon profil</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    *{ box-sizing:border-box; margin:0; padding:0; }
    body{
      min-height:100vh;
      background: radial-gradient(circle at top, #101827, #020617 60%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color:#e5e7eb;
      overflow-x:hidden; /* âœ… anti scroll horizontal */
    }
    .wrap{
      width:100%;
      max-width:1200px;
      margin:0 auto;
      padding:90px 16px 50px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .top-bar{
      position:fixed; top:16px; left:50%; transform:translateX(-50%);
      width:100%; max-width:1200px;
      display:flex; justify-content:space-between; align-items:center;
      padding:0 16px; z-index:40;
      pointer-events:none;
    }
    .top-left,.top-right{ pointer-events:auto; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .top-logo{ font-size:12px; letter-spacing:.22em; text-transform:uppercase; color:#9ca3af; }
    .top-link{
      font-size:12px; padding:6px 10px; height:34px;
      display:inline-flex; align-items:center; justify-content:center;
      border-radius:999px; border:1px solid rgba(148,163,184,.45);
      color:#e5e7eb; text-decoration:none;
      letter-spacing:.14em; text-transform:uppercase;
      background:rgba(15,23,42,.85);
      cursor:pointer;
    }
    .top-link:hover{ border-color:#a5b4fc; box-shadow:0 0 10px rgba(129,140,248,.4); }
    .top-link.glow{ border-color: rgba(165,180,252,.75); box-shadow: 0 0 14px rgba(129,140,248,.28); }

    .btn{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.22);
      background: rgba(15,23,42,.55);
      padding:9px 12px;
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:#e5e7eb;
      cursor:pointer;
      transition: box-shadow .15s ease-out, transform .15s ease-out, border-color .15s ease-out, opacity .15s ease-out;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(165,180,252,.7); box-shadow: 0 0 12px rgba(129,140,248,.25); }
    .btn.primary{ border:none; background: radial-gradient(circle at top left, #a855f7, #4f46e5); box-shadow: 0 0 18px rgba(168,85,247,.35); }
    .btn.primary:hover{ box-shadow: 0 0 22px rgba(168,85,247,.55); }

    .panel{
      background: radial-gradient(circle at top left, #020617, #020617 70%);
      border-radius:26px;
      border:1px solid rgba(148,163,184,.20);
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:14px;
      overflow:hidden;
    }

    .header{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap; }
    .identity{ display:flex; gap:12px; align-items:center; min-width:0; }
    .avatar{
      width:44px; height:44px; border-radius:14px;
      border:1px solid rgba(148,163,184,.22);
      background: rgba(15,23,42,.45);
      display:flex; align-items:center; justify-content:center;
      font-size:20px;
      flex:0 0 auto;
    }
    .id-meta{ min-width:0; }
    h1{
      font-size:18px; font-weight:900;
      letter-spacing:.10em; text-transform:uppercase; color:#f9fafb;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width:min(720px, 80vw);
    }
    .sub{ margin-top:4px; font-size:13px; color:#9ca3af; line-height:1.4; }

    .row-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .stats-row{ display:flex; flex-wrap:wrap; gap:10px; }
    .stat{
      border-radius:18px; border:1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.28);
      padding:12px;
      min-width:200px;
      flex:1;
    }
    .stat .k{ font-size:10px; letter-spacing:.16em; text-transform:uppercase; color:#9ca3af; }
    .stat .v{ margin-top:6px; font-size:18px; font-weight:900; color:#f9fafb; }
    .stat .s{ margin-top:3px; font-size:12px; color:#9ca3af; }

    .chip{
      display:inline-flex; align-items:center; gap:10px;
      border-radius:999px; border:1px solid rgba(148,163,184,.20);
      background: rgba(15,23,42,.40);
      padding:8px 12px;
      font-size:11px; color:#e5e7eb;
      width:fit-content;
    }
    .chip strong{ color:#f9fafb; }

    /* Toggle */
    .toggle{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.16);
      background: rgba(2,6,23,.28);
      width:fit-content;
    }
    .switch{
      width:46px; height:26px; border-radius:999px;
      border:1px solid rgba(148,163,184,.20);
      background: rgba(15,23,42,.55);
      position:relative; cursor:pointer;
    }
    .knob{
      position:absolute; top:3px; left:3px;
      width:20px; height:20px; border-radius:999px;
      background:#cbd5e1;
      transition: transform .15s ease;
    }
    .switch.on{ border-color: rgba(34,197,94,.55); box-shadow: 0 0 12px rgba(34,197,94,.18); }
    .switch.on .knob{ transform: translateX(20px); background:#22c55e; }
    .toggle label{
      font-size:11px; letter-spacing:.14em; text-transform:uppercase; color:#e5e7eb;
    }

    /* Cards list (stacks) */
    .grid{ display:flex; flex-direction:column; gap:12px; }
    .card{
      border-radius:20px; border:1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.28);
      padding:10px;
      display:flex; flex-direction:row; gap:12px; align-items:stretch;
      transition: transform .15s ease-out, box-shadow .15s ease-out, border-color .15s ease-out;
      cursor:default; user-select:none;
      overflow:hidden;
    }
    .card:hover{ transform: translateY(-2px); border-color: rgba(165,180,252,.55); box-shadow: 0 0 16px rgba(129,140,248,.18); }
    .thumb{
      width:92px; flex:0 0 auto;
      aspect-ratio: 3 / 4;
      border-radius:16px; overflow:hidden;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.55);
    }
    .thumb img{ width:100%; height:100%; object-fit:contain; object-position:center; display:block; padding:6px; }
    .meta{
      flex:1; display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      min-width:0;
    }
    .name{
      font-size:11px; letter-spacing:.10em; text-transform:uppercase;
      font-weight:900; color:#f9fafb; line-height:1.2; min-width:0;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width:100%;
    }
    .ct{ font-size:11px; color:#9ca3af; margin-top:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .price{ margin-top:6px; font-size:11px; color:#cbd5e1; letter-spacing:.06em; }
    .badges{ display:flex; flex-direction:column; gap:8px; align-items:flex-end; flex:0 0 auto; }
    .tag{
      font-size:10px; letter-spacing:.14em; text-transform:uppercase; font-weight:900;
      padding:6px 9px; border-radius:999px;
      border:1px solid rgba(148,163,184,.16);
      background: rgba(2,6,23,.35);
      white-space:nowrap;
    }
    .tag.epic{ color:#38bdf8; }
    .tag.ultra{ color:#a855f7; }
    .tag.legendary{ color:#f97316; }
    .owned{
      font-size:10px; letter-spacing:.14em; text-transform:uppercase;
      padding:6px 9px; border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.35);
      color:#e5e7eb;
      white-space:nowrap;
    }
  </style>
</head>

<body>
  <div class="top-bar">
    <div class="top-left">
      <div class="top-logo">VAULTSPIN Â· ME</div>
    </div>
    <div class="top-right">
      <a class="top-link" href="index.html">Packs</a>
      <a class="top-link" href="leaderboard.html">Leaderboard</a>
      <a class="top-link glow" href="collection.html">Ma collection</a>
      <button class="top-link glow" id="btn-logout">DÃ©connexion</button>
    </div>
  </div>

  <div class="wrap">
    <div class="panel">
      <div class="header">
        <div class="identity">
          <div class="avatar" id="me-avatar">ðŸ‘¤</div>
          <div class="id-meta">
            <h1 id="me-title">Mon profil</h1>
            <div class="sub" id="me-sub">Chargementâ€¦</div>
          </div>
        </div>

        <div class="row-actions">
          <a class="top-link glow" id="btn-edit" href="profile.html">Modifier pseudo</a>
          <a class="top-link" id="btn-public-url" href="#" style="display:none;">Voir public</a>
        </div>
      </div>

      <div class="stats-row">
        <div class="stat">
          <div class="k">Points (mois)</div>
          <div class="v" id="stat-points">â€”</div>
          <div class="s" id="stat-month">â€”</div>
        </div>
        <div class="stat">
          <div class="k">Classement</div>
          <div class="v" id="stat-rank">â€”</div>
          <div class="s">Rang global du mois</div>
        </div>
        <div class="stat">
          <div class="k">Total NFTs</div>
          <div class="v" id="stat-total">0</div>
          <div class="s">Cartes enregistrÃ©es</div>
        </div>
        <div class="stat">
          <div class="k">Vault value</div>
          <div class="v" id="stat-vault">0â‚¬</div>
          <div class="s">Somme estimÃ©e</div>
        </div>
      </div>

      <div class="toggle">
        <div class="switch" id="sw-public" role="switch" aria-checked="false" tabindex="0">
          <div class="knob"></div>
        </div>
        <div>
          <label>Profil public</label>
          <div class="sub" id="public-sub" style="margin-top:2px;">Si OFF, tes cartes ne sont pas visibles publiquement.</div>
        </div>
      </div>

      <div class="chip" id="me-chip">
        <span>Partager :</span>
        <strong id="share-url">â€”</strong>
      </div>
    </div>

    <div class="panel">
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <script type="module">
    import { supabase } from "./js/supabaseClient.js";

    function fmtEur(n){
      return (Number(n) || 0).toLocaleString("fr-FR", { maximumFractionDigits: 2 }) + "â‚¬";
    }
    function fmtMonthISO(d = new Date()){
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      return `${y}-${m}-01`; // DATE
    }
    function escapeHtml(s){
      return String(s || "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
      }[c]));
    }
    function escapeAttr(s){ return String(s || "").replace(/"/g, "&quot;"); }

    const CARD_PRICE_EUR_BY_INDEX = {
      0: 5.50, 1: 135, 2: 60, 3: 70, 4: 109, 5: 209, 6: 69, 7: 129, 8: 70, 9: 109,
      10: 1350, 11: 199, 12: 109, 13: 109, 14: 77, 15: 15.50, 16: 4.00, 17: 3.00, 18: 7.00
    };
    const CARD_CATALOG = {
      0: { name:"Phyllali PCA", img:"images/phyllali_PCA.png" },
      1: { name:"AÃ©romite", img:"images/aeromite.png" },
      2: { name:"Germignon", img:"images/germignon.png" },
      3: { name:"Astronelle", img:"images/astronelle.png" },
      4: { name:"ChÃ©tiflor", img:"images/chetiflor.png" },
      5: { name:"Jungko", img:"images/jungko.png" },
      6: { name:"Chenipan", img:"images/chenipan.png" },
      7: { name:"Ã‰nergie Plante", img:"images/energie_plante.png" },
      8: { name:"Majaspic", img:"images/majaspic.png" },
      9: { name:"Mimitoss", img:"images/mimitoss.png" },
      10:{ name:"Florizarre", img:"images/florizarre.png" },
      11:{ name:"Nidoking", img:"images/nidoking.png" },
      12:{ name:"Noeufnoeuf", img:"images/noeufnoeuf.png" },
      13:{ name:"Paras", img:"images/paras.png" },
      14:{ name:"Phyllali", img:"images/phyllali.png" },
      15:{ name:"Boskara", img:"images/boskara.png" },
      16:{ name:"Filentrappe", img:"images/filentrappe.png" },
      17:{ name:"Peterson", img:"images/peterson.png" },
      18:{ name:"Scovilain", img:"images/scovilain.png" }
    };

    const CT_FLORIZARRE = 10;
    const HIDDEN_SET = new Set([0,15,16,17,18]);
    const ULTRA_BUCKET = new Set([1,5,7,11]);
    const EPIC_BUCKET = new Set([2,3,4,6,8,9,12,13,14]);
    const RARITY_ORDER = ["EPIC","ULTRA","LEGENDARY"];
    const RARITY_LABEL = { EPIC:"EPIC", ULTRA:"ULTRA", LEGENDARY:"LEGENDARY" };

    function rarityKeyForCt(ct){
      const n = Number(ct);
      if (HIDDEN_SET.has(n)) return "";
      if (n === CT_FLORIZARRE) return "LEGENDARY";
      if (ULTRA_BUCKET.has(n)) return "ULTRA";
      if (EPIC_BUCKET.has(n)) return "EPIC";
      const price = CARD_PRICE_EUR_BY_INDEX[n] ?? 0;
      if (price > 300) return "LEGENDARY";
      if (price >= 121) return "ULTRA";
      return "EPIC";
    }
    function rarityRank(rk){
      if (!rk) return -1;
      return RARITY_ORDER.indexOf(rk);
    }
    function rarityClass(k){
      if (k === "LEGENDARY") return "legendary";
      if (k === "ULTRA") return "ultra";
      if (k === "EPIC") return "epic";
      return "";
    }

    function groupByCardType(items){
      const map = new Map();
      for (const x of items){
        const ct = Number(x.card_type_index ?? -1);
        if (!Number.isFinite(ct) || ct < 0) continue;
        const cat = CARD_CATALOG[ct] || null;
        const price = Number(x.estimated_value_eur ?? (CARD_PRICE_EUR_BY_INDEX[ct] ?? 0)) || 0;
        const rk = rarityKeyForCt(ct);

        if (!map.has(ct)){
          map.set(ct, {
            cardTypeIndex: ct,
            name: x.card_name || (cat && cat.name) || ("Card #" + ct),
            img: x.image_url || (cat && cat.img) || "",
            owned: 0,
            lastTs: 0,
            lastTokenId: x.token_id ?? null,
            price,
            rarityKey: rk,
            rarityLabel: rk ? (RARITY_LABEL[rk] || rk) : ""
          });
        }
        const g = map.get(ct);
        g.owned += 1;

        const ts = x.opened_at ? new Date(x.opened_at).getTime() : 0;
        if (ts > g.lastTs){
          g.lastTs = ts;
          g.lastTokenId = x.token_id ?? null;
        }
        if (!g.img && x.image_url) g.img = x.image_url;
        if (!g.name && x.card_name) g.name = x.card_name;
        g.price = price;
        g.rarityKey = rk;
        g.rarityLabel = rk ? (RARITY_LABEL[rk] || rk) : "";
      }
      return Array.from(map.values());
    }

    function vaultValue(items){
      let sum = 0;
      for (const x of items){
        const ct = Number(x.card_type_index ?? -1);
        if (!Number.isFinite(ct) || ct < 0) continue;
        sum += (CARD_PRICE_EUR_BY_INDEX[ct] ?? Number(x.estimated_value_eur || 0) || 0);
      }
      return sum;
    }

    async function requireAuth(){
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user){
        const next = encodeURIComponent("me.html");
        window.location.href = `login.html?next=${next}`;
        return null;
      }
      return session;
    }

    async function requireUsername(userId){
      const { data, error } = await supabase
        .from("profiles")
        .select("id, email, username, display_name, is_public")
        .eq("id", userId)
        .maybeSingle();
      if (error) throw error;

      if (!data?.username){
        window.location.href = "profile.html?next=./me.html";
        return null;
      }
      return data;
    }

    async function fetchMyCards(userId){
      const { data, error } = await supabase
        .from("user_cards")
        .select("id, token_id, card_type_index, rarity_key, image_url, card_name, estimated_value_eur, opened_at")
        .eq("user_id", userId)
        .order("opened_at", { ascending:false })
        .limit(5000);
      if (error) throw error;
      return data || [];
    }

    async function fetchMyPoints(userId, monthISO){
      const { data, error } = await supabase
        .from("user_points_monthly")
        .select("points")
        .eq("user_id", userId)
        .eq("month", monthISO)
        .maybeSingle();
      if (error) throw error;
      return Number(data?.points || 0);
    }

    async function computeRank(monthISO, myPoints){
      if (!myPoints) return null;

      const { count, error } = await supabase
        .from("user_points_monthly")
        .select("user_id", { count:"exact", head:true })
        .eq("month", monthISO)
        .gt("points", myPoints);

      if (error) throw error;
      return Number(count || 0) + 1;
    }

    function renderHeader(profile, userId){
      const name = profile.display_name || profile.username || profile.email || "Moi";
      document.getElementById("me-title").textContent = name;
      document.getElementById("me-avatar").textContent = (name || "M").trim().slice(0,1).toUpperCase();
      const short = userId.slice(0,6) + "â€¦" + userId.slice(-4);
      document.getElementById("me-sub").textContent = `ID: ${short}`;

      // share url
      const share = `${window.location.origin}${window.location.pathname.replace("me.html","player.html")}?u=${encodeURIComponent(userId)}`;
      document.getElementById("share-url").textContent = share;

      const publicBtn = document.getElementById("btn-public-url");
      publicBtn.style.display = "inline-flex";
      publicBtn.href = `player.html?u=${encodeURIComponent(userId)}`;
    }

    function renderStats(points, rank, totalCards, vaultEur){
      document.getElementById("stat-points").textContent = points.toLocaleString("fr-FR");
      document.getElementById("stat-rank").textContent = rank ? ("#" + String(rank)) : "â€”";
      document.getElementById("stat-total").textContent = String(totalCards);
      document.getElementById("stat-vault").textContent = fmtEur(vaultEur);

      const d = new Date();
      document.getElementById("stat-month").textContent = d.toLocaleString("fr-FR", { month:"long", year:"numeric" });
    }

    function renderStacks(stacks){
      const grid = document.getElementById("grid");
      grid.innerHTML = "";

      stacks.sort((a,b) => {
        const ra = rarityRank(a.rarityKey);
        const rb = rarityRank(b.rarityKey);
        return (rb - ra) || (b.price - a.price) || (b.owned - a.owned);
      });

      for (const s of stacks){
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="thumb"><img src="${escapeAttr(s.img)}" alt="${escapeAttr(s.name)}"/></div>
          <div class="meta">
            <div style="min-width:0;">
              <div class="name">${escapeHtml(s.name)}</div>
              <div class="ct">cardTypeIndex: ${s.cardTypeIndex} Â· last: #${s.lastTokenId ?? "â€”"}</div>
              <div class="price">Valeur estimÃ©e : ${fmtEur(s.price)}</div>
            </div>
            <div class="badges">
              ${s.rarityKey ? `<div class="tag ${rarityClass(s.rarityKey)}">${escapeHtml(s.rarityLabel)}</div>` : ""}
              <div class="owned">Owned Â· ${s.owned}</div>
            </div>
          </div>
        `;
        grid.appendChild(card);
      }
    }

    function setPublicSwitch(isPublic){
      const sw = document.getElementById("sw-public");
      sw.classList.toggle("on", !!isPublic);
      sw.setAttribute("aria-checked", isPublic ? "true" : "false");
      document.getElementById("public-sub").textContent = isPublic
        ? "ON : tes cartes et ton profil sont visibles publiquement."
        : "OFF : tes cartes ne sont pas visibles publiquement.";
    }

    async function updateIsPublic(userId, isPublic){
      const { error } = await supabase
        .from("profiles")
        .update({ is_public: !!isPublic, updated_at: new Date().toISOString() })
        .eq("id", userId);
      if (error) throw error;
    }

    /* ---------- Init ---------- */
    const session = await requireAuth();
    if (!session) { /* redirected */ }
    else {
      try{
        const profile = await requireUsername(session.user.id);
        if (!profile) { /* redirected */ }
        else {
          renderHeader(profile, session.user.id);

          // edit pseudo link -> keep next
          document.getElementById("btn-edit").href = "profile.html?next=./me.html";

          const monthISO = new Date();
          const monthKey = fmtMonthISO(monthISO);

          const [cards, points] = await Promise.all([
            fetchMyCards(session.user.id),
            fetchMyPoints(session.user.id, monthKey),
          ]);

          const rank = await computeRank(monthKey, points);

          renderStats(points, rank, cards.length, vaultValue(cards));
          renderStacks(groupByCardType(cards));

          // toggle public
          setPublicSwitch(!!profile.is_public);

          const sw = document.getElementById("sw-public");
          let busy = false;

          const toggle = async () => {
            if (busy) return;
            busy = true;
            try{
              const next = !sw.classList.contains("on");
              setPublicSwitch(next);
              await updateIsPublic(session.user.id, next);
            }catch(e){
              console.error(e);
              // rollback UI
              setPublicSwitch(!sw.classList.contains("on"));
              alert(e?.message || "Impossible de modifier la visibilitÃ©.");
            }finally{
              busy = false;
            }
          };

          sw.addEventListener("click", toggle);
          sw.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggle(); }
          });

          // logout
          document.getElementById("btn-logout").addEventListener("click", async () => {
            await supabase.auth.signOut();
            window.location.href = "index.html";
          });
        }
      }catch(e){
        console.error(e);
        document.getElementById("me-title").textContent = "Erreur";
        document.getElementById("me-sub").textContent = e?.message || "Impossible de charger ton profil.";
      }
    }
  </script>
</body>
</html>
