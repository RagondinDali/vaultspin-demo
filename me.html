<!-- me.html (FIXED: points/rank are pack-aware => uses pack_key='ALL' for global monthly stats) -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>VaultSpin â€“ Mon profil</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    *{ box-sizing:border-box; margin:0; padding:0; }
    body{
      min-height:100vh;
      background: radial-gradient(circle at top, #101827, #020617 60%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color:#e5e7eb;
      overflow-x:hidden;
    }
    .wrap{
      width:100%;
      max-width:1200px;
      margin:0 auto;
      padding:90px 16px 50px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .top-bar{
      position:fixed; top:16px; left:50%; transform:translateX(-50%);
      width:100%; max-width:1200px;
      display:flex; justify-content:space-between; align-items:center;
      padding:0 16px; z-index:40;
      pointer-events:none;
    }
    .top-left,.top-right{ pointer-events:auto; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .top-logo{ font-size:12px; letter-spacing:.22em; text-transform:uppercase; color:#9ca3af; }
    .top-link{
      font-size:12px; padding:6px 10px; height:34px;
      display:inline-flex; align-items:center; justify-content:center;
      border-radius:999px; border:1px solid rgba(148,163,184,.45);
      color:#e5e7eb; text-decoration:none;
      letter-spacing:.14em; text-transform:uppercase;
      background:rgba(15,23,42,.85);
      cursor:pointer;
    }
    .top-link:hover{ border-color:#a5b4fc; box-shadow:0 0 10px rgba(129,140,248,.4); }
    .top-link.glow{ border-color: rgba(165,180,252,.75); box-shadow: 0 0 14px rgba(129,140,248,.28); }

    .panel{
      background: radial-gradient(circle at top left, #020617, #020617 70%);
      border-radius:26px;
      border:1px solid rgba(148,163,184,.20);
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:14px;
      overflow:hidden;
    }

    .header{ display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap; }
    .identity{ display:flex; gap:12px; align-items:center; min-width:0; }
    .avatar{
      width:44px; height:44px; border-radius:14px;
      border:1px solid rgba(148,163,184,.22);
      background: rgba(15,23,42,.45);
      display:flex; align-items:center; justify-content:center;
      font-size:20px;
      flex:0 0 auto;
    }
    .id-meta{ min-width:0; }
    h1{
      font-size:18px; font-weight:900;
      letter-spacing:.10em; text-transform:uppercase; color:#f9fafb;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width:min(720px, 80vw);
    }
    .sub{ margin-top:4px; font-size:13px; color:#9ca3af; line-height:1.4; }

    .row-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .stats-row{ display:flex; flex-wrap:wrap; gap:10px; }
    .stat{
      border-radius:18px; border:1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.28);
      padding:12px;
      min-width:200px;
      flex:1;
    }
    .stat .k{ font-size:10px; letter-spacing:.16em; text-transform:uppercase; color:#9ca3af; }
    .stat .v{ margin-top:6px; font-size:18px; font-weight:900; color:#f9fafb; }
    .stat .s{ margin-top:3px; font-size:12px; color:#9ca3af; }

    .chip{
      display:inline-flex; align-items:center; gap:10px;
      border-radius:999px; border:1px solid rgba(148,163,184,.20);
      background: rgba(15,23,42,.40);
      padding:8px 12px;
      font-size:11px; color:#e5e7eb;
      width:fit-content;
      max-width:100%;
      overflow:hidden;
    }
    .chip strong{
      color:#f9fafb;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      display:inline-block;
      max-width: min(860px, 72vw);
    }

    .toggle{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.16);
      background: rgba(2,6,23,.28);
      width:fit-content;
    }
    .switch{
      width:46px; height:26px; border-radius:999px;
      border:1px solid rgba(148,163,184,.20);
      background: rgba(15,23,42,.55);
      position:relative; cursor:pointer;
    }
    .knob{
      position:absolute; top:3px; left:3px;
      width:20px; height:20px; border-radius:999px;
      background:#cbd5e1;
      transition: transform .15s ease;
    }
    .switch.on{ border-color: rgba(34,197,94,.55); box-shadow: 0 0 12px rgba(34,197,94,.18); }
    .switch.on .knob{ transform: translateX(20px); background:#22c55e; }
    .toggle label{
      font-size:11px; letter-spacing:.14em; text-transform:uppercase; color:#e5e7eb;
    }

    .grid{ display:flex; flex-direction:column; gap:12px; }

    .card{
      border-radius:20px; border:1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.28);
      padding:10px;
      display:flex; flex-direction:row; gap:12px; align-items:stretch;
      transition: transform .15s ease-out, box-shadow .15s ease-out, border-color .15s ease-out;
      cursor:default; user-select:none;
      overflow:hidden;
    }
    .card:hover{ transform: translateY(-2px); border-color: rgba(165,180,252,.55); box-shadow: 0 0 16px rgba(129,140,248,.18); }

    .thumb{
      width:92px; flex:0 0 auto;
      aspect-ratio: 3 / 4;
      border-radius:16px; overflow:hidden;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.55);
    }
    .thumb img{ width:100%; height:100%; object-fit:contain; object-position:center; display:block; padding:6px; }

    .meta{
      flex:1; display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      min-width:0;
    }
    .name{
      font-size:11px; letter-spacing:.10em; text-transform:uppercase;
      font-weight:900; color:#f9fafb; line-height:1.2; min-width:0;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width:100%;
    }
    .ct{ font-size:11px; color:#9ca3af; margin-top:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .price{ margin-top:6px; font-size:11px; color:#cbd5e1; letter-spacing:.06em; }

    .badges{ display:flex; flex-direction:column; gap:8px; align-items:flex-end; flex:0 0 auto; }
    .tag{
      font-size:10px; letter-spacing:.14em; text-transform:uppercase; font-weight:900;
      padding:6px 9px; border-radius:999px;
      border:1px solid rgba(148,163,184,.16);
      background: rgba(2,6,23,.35);
      white-space:nowrap;
    }
    .tag.pack{
      border-color: rgba(148,163,184,.20);
      background: rgba(15,23,42,.55);
      color:#e5e7eb;
    }
    .tag.epic{ color:#38bdf8; }
    .tag.ultra{ color:#a855f7; }
    .tag.legendary{ color:#f97316; }
    .tag.hidden{ color:#9ca3af; }

    .owned{
      font-size:10px; letter-spacing:.14em; text-transform:uppercase;
      padding:6px 9px; border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.35);
      color:#e5e7eb;
      white-space:nowrap;
    }

    .modal{
      position:fixed; inset:0; display:none;
      align-items:center; justify-content:center;
      z-index:80;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      padding:16px;
    }
    .modal.on{ display:flex; }
    .modal-card{
      width: min(430px, 92vw);
      border-radius:24px;
      border:1px solid rgba(148,163,184,.20);
      background: rgba(2,6,23,.86);
      box-shadow: 0 0 34px rgba(0,0,0,.5);
      padding:14px;
      position:relative;
      animation: popIn 140ms ease-out;
    }
    @keyframes popIn{ from{ transform:scale(.985); opacity:0; } to{ transform:scale(1); opacity:1; } }
    .modal-img{
      width:100%; aspect-ratio:3/4;
      border-radius:18px; overflow:hidden;
      border:1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.55);
    }
    .modal-img img{ width:100%; height:100%; object-fit:contain; object-position:center; display:block; padding:10px; }
    .modal-meta{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:10px; }
    .modal-name{
      font-size:12px; letter-spacing:.12em; text-transform:uppercase;
      font-weight:900; color:#e5e7eb; min-width:0;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .modal-tag{
      font-size:11px; letter-spacing:.14em; text-transform:uppercase;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(148,163,184,.20);
      background: rgba(15,23,42,.55);
      color:#e5e7eb;
      white-space:nowrap;
      display:none;
    }
    .modal-price{ margin-top:10px; font-size:12px; color:#cbd5e1; letter-spacing:.08em; }
    .modal-close{
      position:absolute; right:10px; top:10px;
      border:1px solid rgba(148,163,184,.20);
      background: rgba(15,23,42,.55);
      color:#e5e7eb;
      border-radius:999px;
      padding:8px 10px;
      cursor:pointer;
      font-size:12px;
    }
    .modal-close:hover{ border-color: rgba(165,180,252,.7); box-shadow: 0 0 10px rgba(129,140,248,.25); }

    @media (max-width: 520px){
      .thumb{ width:84px; }
      .ct{ white-space:normal; }
    }
  </style>
</head>

<body>
  <div class="top-bar">
    <div class="top-left">
      <div class="top-logo">VAULTSPIN Â· ME</div>
    </div>
    <div class="top-right">
      <a class="top-link" href="index.html">Packs</a>
      <a class="top-link" href="leaderboard.html">Leaderboard</a>
      <a class="top-link glow" href="collection.html">Ma collection</a>
      <button class="top-link glow" id="btn-logout">DÃ©connexion</button>
    </div>
  </div>

  <div class="modal" id="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true">
      <button class="modal-close" id="modal-close">âœ•</button>
      <div class="modal-img">
        <img id="modal-img" src="" alt="Preview" />
      </div>
      <div class="modal-meta">
        <div class="modal-name" id="modal-name">â€”</div>
        <div class="modal-tag" id="modal-tag">â€”</div>
      </div>
      <div class="modal-price" id="modal-price">Valeur estimÃ©e : â€”</div>
    </div>
  </div>

  <div class="wrap">
    <div class="panel">
      <div class="header">
        <div class="identity">
          <div class="avatar" id="me-avatar">ðŸ‘¤</div>
          <div class="id-meta">
            <h1 id="me-title">Mon profil</h1>
            <div class="sub" id="me-sub">Chargementâ€¦</div>
          </div>
        </div>

        <div class="row-actions">
          <a class="top-link glow" id="btn-edit" href="profile.html">Modifier pseudo</a>
          <a class="top-link" id="btn-public-url" href="#" style="display:none;">Voir public</a>
        </div>
      </div>

      <div class="stats-row">
        <div class="stat">
          <div class="k">Points (mois)</div>
          <div class="v" id="stat-points">â€”</div>
          <div class="s" id="stat-month">â€”</div>
        </div>
        <div class="stat">
          <div class="k">Classement</div>
          <div class="v" id="stat-rank">â€”</div>
          <div class="s">Rang global du mois (pack ALL)</div>
        </div>
        <div class="stat">
          <div class="k">Total NFTs</div>
          <div class="v" id="stat-total">0</div>
          <div class="s">Cartes enregistrÃ©es</div>
        </div>
        <div class="stat">
          <div class="k">Vault value</div>
          <div class="v" id="stat-vault">0â‚¬</div>
          <div class="s">Somme (DB: estimated_value_eur)</div>
        </div>
      </div>

      <div class="toggle">
        <div class="switch" id="sw-public" role="switch" aria-checked="false" tabindex="0">
          <div class="knob"></div>
        </div>
        <div>
          <label>Profil public</label>
          <div class="sub" id="public-sub" style="margin-top:2px;">Si OFF, tes cartes ne sont pas visibles publiquement.</div>
        </div>
      </div>

      <div class="chip" id="me-chip">
        <span>Partager :</span>
        <strong id="share-url">â€”</strong>
      </div>
    </div>

    <div class="panel">
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <script type="module">
    import { supabase } from "./js/supabaseClient.js";

    const CATALOG = {
      PLANT: {
        0:  { name:"Phyllali PCA",   img:"images/phyllali_PCA.png" },
        1:  { name:"AÃ©romite",       img:"images/aeromite.png" },
        2:  { name:"Germignon",      img:"images/germignon.png" },
        3:  { name:"Astronelle",     img:"images/astronelle.png" },
        4:  { name:"ChÃ©tiflor",      img:"images/chetiflor.png" },
        5:  { name:"Jungko",         img:"images/jungko.png" },
        6:  { name:"Chenipan",       img:"images/chenipan.png" },
        7:  { name:"Ã‰nergie Plante", img:"images/energie_plante.png" },
        8:  { name:"Majaspic",       img:"images/majaspic.png" },
        9:  { name:"Mimitoss",       img:"images/mimitoss.png" },
        10: { name:"Florizarre",     img:"images/florizarre.png" },
        11: { name:"Nidoking",       img:"images/nidoking.png" },
        12: { name:"Noeufnoeuf",     img:"images/noeufnoeuf.png" },
        13: { name:"Paras",          img:"images/paras.png" },
        14: { name:"Phyllali",       img:"images/phyllali.png" },
        15: { name:"Boskara",        img:"images/boskara.png" },
        16: { name:"Filentrappe",    img:"images/filentrappe.png" },
        17: { name:"Peterson",       img:"images/peterson.png" },
        18: { name:"Scovilain",      img:"images/scovilain.png" }
      },
      WATER: {},
      FIRE: {}
    };

    function catalogFor(packKey, ct){
      const pk = (packKey || "PLANT").toUpperCase();
      return (CATALOG[pk] && CATALOG[pk][Number(ct)]) ? CATALOG[pk][Number(ct)] : null;
    }

    function fmtEur(n){
      return (Number(n) || 0).toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " â‚¬";
    }
    function fmtMonthStartISO(d = new Date()){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      return `${y}-${m}-01`;
    }
    function escapeHtml(s){
      return String(s || "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
      }[c]));
    }
    function escapeAttr(s){ return String(s || "").replace(/"/g, "&quot;"); }

    const RARITY_ORDER = ["HIDDEN","EPIC","ULTRA","LEGENDARY"];
    function rarityRank(k){
      const kk = (k || "").toUpperCase();
      const i = RARITY_ORDER.indexOf(kk);
      return i === -1 ? 0 : i;
    }
    function rarityClass(k){
      const kk = (k || "").toUpperCase();
      if (kk === "LEGENDARY") return "legendary";
      if (kk === "ULTRA") return "ultra";
      if (kk === "EPIC") return "epic";
      if (kk === "HIDDEN") return "hidden";
      return "";
    }

    function openModal({ img, name, rarity, price }){
      document.getElementById("modal-img").src = img || "";
      document.getElementById("modal-name").textContent = name || "â€”";

      const tag = document.getElementById("modal-tag");
      if (rarity){
        tag.style.display = "inline-flex";
        tag.textContent = rarity;
      } else {
        tag.style.display = "none";
        tag.textContent = "";
      }

      document.getElementById("modal-price").textContent = "Valeur estimÃ©e : " + fmtEur(price || 0);
      const modal = document.getElementById("modal");
      modal.classList.add("on");
      modal.setAttribute("aria-hidden", "false");
    }
    function closeModal(){
      const modal = document.getElementById("modal");
      modal.classList.remove("on");
      modal.setAttribute("aria-hidden", "true");
    }

    async function requireAuth(){
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user){
        const next = encodeURIComponent("me.html");
        window.location.href = `login.html?next=${next}`;
        return null;
      }
      return session;
    }

    async function requireUsername(userId){
      const { data, error } = await supabase
        .from("profiles")
        .select("id, email, username, display_name, is_public")
        .eq("id", userId)
        .maybeSingle();
      if (error) throw error;

      if (!data?.username){
        window.location.href = "profile.html?next=./me.html";
        return null;
      }
      return data;
    }

    async function fetchMyCards(userId){
      const { data, error } = await supabase
        .from("user_cards")
        .select("id, user_id, token_id, pack_key, card_type_index, rarity_key, image_url, card_name, estimated_value_eur, opened_at")
        .eq("user_id", userId)
        .order("opened_at", { ascending:false })
        .limit(5000);
      if (error) throw error;
      return data || [];
    }

    // âœ… FIX: points are pack-aware => force pack_key = 'ALL'
    async function fetchMyPoints(userId, monthISO){
      const { data, error } = await supabase
        .from("user_points_monthly")
        .select("points")
        .eq("user_id", userId)
        .eq("month", monthISO)
        .eq("pack_key", "ALL")
        .maybeSingle();
      if (error) throw error;
      return Number(data?.points || 0);
    }

    // âœ… FIX: rank must also filter pack_key='ALL'
    async function computeRank(monthISO, myPoints){
      if (!myPoints) return null;

      const { count, error } = await supabase
        .from("user_points_monthly")
        .select("user_id", { count:"exact", head:true })
        .eq("month", monthISO)
        .eq("pack_key", "ALL")
        .gt("points", myPoints);

      if (error) throw error;
      return Number(count || 0) + 1;
    }

    async function updateIsPublic(userId, isPublic){
      const { error } = await supabase
        .from("profiles")
        .update({ is_public: !!isPublic, updated_at: new Date().toISOString() })
        .eq("id", userId);
      if (error) throw error;
    }

    function normalizeCards(rows){
      return (rows || []).map(r => {
        const pkRaw = (r.pack_key || "PLANT").toString().toUpperCase();
        const pk = pkRaw || "PLANT";
        const ct = Number(r.card_type_index ?? -1);
        const cat = catalogFor(pk, ct);
        const ts = r.opened_at ? new Date(r.opened_at).getTime() : 0;

        return {
          pack_key: pk,
          cardTypeIndex: ct,
          tokenId: r.token_id ?? null,
          ts,
          rarity_key: (r.rarity_key || "").toUpperCase() || null,
          img: r.image_url || (cat && cat.img) || "",
          name: r.card_name || (cat && cat.name) || ("Card #" + ct),
          estimated_value_eur: Number(r.estimated_value_eur ?? 0) || 0
        };
      }).filter(x => Number.isFinite(x.cardTypeIndex) && x.cardTypeIndex >= 0);
    }

    function vaultValue(items){
      let sum = 0;
      for (const x of items){
        sum += Number(x.estimated_value_eur || 0) || 0;
      }
      return sum;
    }

    function groupByStack(items){
      const map = new Map();
      for (const x of items){
        const ct = Number(x.cardTypeIndex ?? -1);
        const pk = (x.pack_key || "PLANT").toUpperCase();
        const key = pk + ":" + String(ct);

        if (!map.has(key)){
          map.set(key, {
            key,
            pack_key: pk,
            cardTypeIndex: ct,
            img: x.img || "",
            name: x.name || ("Card #" + ct),
            owned: 0,
            lastTs: 0,
            lastTokenId: null,
            price: Number(x.estimated_value_eur || 0) || 0,
            rarity_key: (x.rarity_key || "").toUpperCase() || null
          });
        }

        const g = map.get(key);
        g.owned += 1;

        const ts = Number(x.ts || 0) || 0;
        if (ts > g.lastTs){
          g.lastTs = ts;
          g.lastTokenId = x.tokenId ?? null;
        }

        const px = Number(x.estimated_value_eur || 0) || 0;
        if (px > g.price) g.price = px;

        const rk = (x.rarity_key || "").toUpperCase();
        if (rk && rarityRank(rk) > rarityRank(g.rarity_key)) g.rarity_key = rk;

        if (!g.img && x.img) g.img = x.img;
        if ((!g.name || g.name.startsWith("Card #")) && x.name) g.name = x.name;
      }
      return Array.from(map.values());
    }

    function renderHeader(profile, userId){
      const name = profile.display_name || profile.username || profile.email || "Moi";
      document.getElementById("me-title").textContent = name;
      document.getElementById("me-avatar").textContent = (name || "M").trim().slice(0,1).toUpperCase();

      const short = userId.slice(0,6) + "â€¦" + userId.slice(-4);
      document.getElementById("me-sub").textContent = `ID: ${short}`;

      const share = `${window.location.origin}${window.location.pathname.replace("me.html","player.html")}?u=${encodeURIComponent(userId)}`;
      document.getElementById("share-url").textContent = share;

      const publicBtn = document.getElementById("btn-public-url");
      publicBtn.style.display = "inline-flex";
      publicBtn.href = `player.html?u=${encodeURIComponent(userId)}`;

      document.getElementById("btn-edit").href = "profile.html?next=./me.html";
    }

    function renderStats(points, rank, totalCards, vaultEur){
      document.getElementById("stat-points").textContent = (Number(points||0)).toLocaleString("fr-FR");
      document.getElementById("stat-rank").textContent = rank ? ("#" + String(rank)) : "â€”";
      document.getElementById("stat-total").textContent = String(totalCards);
      document.getElementById("stat-vault").textContent = fmtEur(vaultEur);

      const d = new Date();
      document.getElementById("stat-month").textContent = d.toLocaleString("fr-FR", { month:"long", year:"numeric" });
    }

    function setPublicSwitch(isPublic){
      const sw = document.getElementById("sw-public");
      sw.classList.toggle("on", !!isPublic);
      sw.setAttribute("aria-checked", isPublic ? "true" : "false");
      document.getElementById("public-sub").textContent = isPublic
        ? "ON : tes cartes et ton profil sont visibles publiquement."
        : "OFF : tes cartes ne sont pas visibles publiquement.";
    }

    function renderStacks(stacks){
      const grid = document.getElementById("grid");
      grid.innerHTML = "";

      stacks.sort((a,b) => {
        const ra = rarityRank(a.rarity_key);
        const rb = rarityRank(b.rarity_key);
        return (rb - ra) || (b.price - a.price) || (b.owned - a.owned);
      });

      for (const s of stacks){
        const card = document.createElement("div");
        card.className = "card";

        const thumb = document.createElement("div");
        thumb.className = "thumb";
        thumb.innerHTML = `<img src="${escapeAttr(s.img)}" alt="${escapeAttr(s.name)}"/>`;

        const meta = document.createElement("div");
        meta.className = "meta";

        const left = document.createElement("div");
        left.style.minWidth = "0";
        left.innerHTML = `
          <div class="name">${escapeHtml(s.name)}</div>
          <div class="ct">pack: ${escapeHtml(s.pack_key)} Â· cardTypeIndex: ${s.cardTypeIndex} Â· last: #${s.lastTokenId ?? "â€”"}</div>
          <div class="price">Valeur estimÃ©e : ${fmtEur(s.price)}</div>
        `;

        const badges = document.createElement("div");
        badges.className = "badges";

        const packTag = document.createElement("div");
        packTag.className = "tag pack";
        packTag.textContent = s.pack_key;
        badges.appendChild(packTag);

        if (s.rarity_key){
          const tag = document.createElement("div");
          tag.className = "tag " + rarityClass(s.rarity_key);
          tag.textContent = s.rarity_key;
          badges.appendChild(tag);
        }

        const owned = document.createElement("div");
        owned.className = "owned";
        owned.textContent = "Owned Â· " + s.owned;
        badges.appendChild(owned);

        meta.appendChild(left);
        meta.appendChild(badges);

        card.appendChild(thumb);
        card.appendChild(meta);

        card.addEventListener("click", () => {
          openModal({
            img: s.img,
            name: `${s.name} (${s.pack_key} Â· ct ${s.cardTypeIndex})`,
            rarity: s.rarity_key || "",
            price: s.price || 0
          });
        });

        grid.appendChild(card);
      }
    }

    document.getElementById("modal-close").addEventListener("click", closeModal);
    document.getElementById("modal").addEventListener("click", (e) => { if (e.target.id === "modal") closeModal(); });
    document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

    const session = await requireAuth();
    if (session){
      try{
        const profile = await requireUsername(session.user.id);
        if (profile){
          renderHeader(profile, session.user.id);

          const monthISO = fmtMonthStartISO(new Date());

          const [rows, points] = await Promise.all([
            fetchMyCards(session.user.id),
            fetchMyPoints(session.user.id, monthISO),
          ]);

          const cards = normalizeCards(rows);
          const rank = await computeRank(monthISO, points);

          renderStats(points, rank, cards.length, vaultValue(cards));
          renderStacks(groupByStack(cards));

          setPublicSwitch(!!profile.is_public);

          const sw = document.getElementById("sw-public");
          let busy = false;

          const toggle = async () => {
            if (busy) return;
            busy = true;
            try{
              const next = !sw.classList.contains("on");
              setPublicSwitch(next);
              await updateIsPublic(session.user.id, next);
            }catch(e){
              console.error(e);
              setPublicSwitch(!sw.classList.contains("on"));
              alert(e?.message || "Impossible de modifier la visibilitÃ©.");
            }finally{
              busy = false;
            }
          };

          sw.addEventListener("click", toggle);
          sw.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggle(); }
          });

          document.getElementById("btn-logout").addEventListener("click", async () => {
            await supabase.auth.signOut();
            window.location.href = "index.html";
          });
        }
      }catch(e){
        console.error(e);
        document.getElementById("me-title").textContent = "Erreur";
        document.getElementById("me-sub").textContent = e?.message || "Impossible de charger ton profil.";
      }
    }
  </script>
</body>
</html>
