<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>VaultSpin – Admin Mint Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Ethers v6 -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>

    <link rel="stylesheet" href="animations.css" />

    <style>
      body {
        min-height: 100vh;
        background: radial-gradient(circle at top, #101827, #020617 60%);
        font-family: system-ui, sans-serif;
        color: #e5e7eb;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .panel {
        width: 100%;
        max-width: 420px;
        background: radial-gradient(circle at top, #020617, #020617 70%);
        border-radius: 24px;
        border: 1px solid rgba(148, 163, 184, 0.25);
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      h1 {
        font-size: 18px;
        text-transform: uppercase;
        letter-spacing: 0.14em;
      }

      .btn {
        border-radius: 999px;
        padding: 12px 18px;
        font-size: 12px;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        border: none;
        cursor: pointer;
        background: radial-gradient(circle at top left, #a855f7, #4f46e5);
        color: #fff;
        box-shadow: 0 0 18px rgba(168, 85, 247, 0.5);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .status {
        font-size: 13px;
        padding: 10px 14px;
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.7);
        border: 1px solid #374151;
        white-space: pre-line;
      }

      .small {
        font-size: 11px;
        color: #9ca3af;
      }

      .danger {
        color: #f97373;
        font-weight: 600;
      }
    </style>
  </head>

  <body>
    <div class="panel">
      <h1>VaultSpin Admin</h1>

      <div class="status" id="status">Wallet non connecté.</div>

      <button class="btn" id="connect-btn">Connecter MetaMask</button>

      <button class="btn" id="mint-btn" disabled>Mint Booster (on-chain)</button>

      <div class="small">Cette page minte réellement des NFTs vers ton wallet admin.</div>

      <div class="small danger">⚠️ À ne jamais partager publiquement.</div>
    </div>

    <script>
      /********************
       * CONFIG CONTRAT
       ********************/
      const CONTRACT_ADDRESS = "0x6279B83Fd6093c5cAf2989cc428197D7A7d7342D";
      const SEPOLIA_CHAIN_ID = 11155111n;

      const CONTRACT_ABI = [
        {
          anonymous: false,
          inputs: [
            { indexed: true, name: "tokenId", type: "uint256" },
            { indexed: false, name: "rarity", type: "uint8" },
            { indexed: true, name: "cardTypeIndex", type: "uint256" },
          ],
          name: "CardMinted",
          type: "event",
        },
        {
          inputs: [],
          name: "owner",
          outputs: [{ type: "address" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [
            { name: "to", type: "address" },
            { name: "randomNumber", type: "uint256" },
          ],
          name: "mintBooster",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
      ];

      let provider;
      let signer;
      let contract;
      let currentAccount;

      const statusEl = document.getElementById("status");
      const connectBtn = document.getElementById("connect-btn");
      const mintBtn = document.getElementById("mint-btn");

      function setStatus(txt) {
        statusEl.textContent = txt;
      }

      function shortAddr(addr) {
        if (!addr) return "";
        return addr.slice(0, 6) + "…" + addr.slice(-4);
      }

      async function connectWallet() {
        try {
          if (!window.ethereum) {
            setStatus("MetaMask non détecté.");
            return;
          }

          provider = new ethers.BrowserProvider(window.ethereum);

          // Check réseau
          const net = await provider.getNetwork();
          if (net.chainId !== SEPOLIA_CHAIN_ID) {
            setStatus("Mauvais réseau : passe sur Sepolia.\n(chainId: " + net.chainId + ")");
            mintBtn.disabled = true;
            return;
          }

          await provider.send("eth_requestAccounts", []);
          signer = await provider.getSigner();
          currentAccount = await signer.getAddress();

          contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

          const owner = (await contract.owner()).toLowerCase();

          if (currentAccount.toLowerCase() !== owner) {
            setStatus(
              "Connecté : " +
                shortAddr(currentAccount) +
                "\nNON OWNER du contrat.\nOwner attendu : " +
                shortAddr(owner)
            );
            mintBtn.disabled = true;
            return;
          }

          setStatus("Admin connecté : " + shortAddr(currentAccount) + "\nRéseau : Sepolia ✅");
          mintBtn.disabled = false;
        } catch (e) {
          console.error(e);
          setStatus("Erreur connexion: " + (e.shortMessage || e.message));
          mintBtn.disabled = true;
        }
      }

      async function mintBooster() {
        mintBtn.disabled = true;

        try {
          if (!contract || !currentAccount) {
            setStatus("Connecte d'abord le wallet.");
            return;
          }

          const randomNumber = BigInt(Math.floor(Math.random() * 1e9) + 1);

          // 1) Simulation => te donne la vraie raison en cas de revert
          setStatus("Simulation du mint…");
          await contract.mintBooster.staticCall(currentAccount, randomNumber);

          // 2) Envoi tx
          setStatus("Signature MetaMask…");
          const tx = await contract.mintBooster(currentAccount, randomNumber);

          setStatus("Tx envoyée : " + tx.hash + "\nAttente confirmation…");
          await tx.wait();

          setStatus("Mint réussi ✔️\nTx: " + tx.hash);
        } catch (e) {
          console.error(e);
          setStatus("Mint revert: " + (e.shortMessage || e.message));
        } finally {
          mintBtn.disabled = false;
        }
      }

      connectBtn.addEventListener("click", connectWallet);
      mintBtn.addEventListener("click", mintBooster);
    </script>
  </body>
</html>
