<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>VaultSpin â€“ Profil joueur</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    *{ box-sizing:border-box; margin:0; padding:0; }
    body{
      min-height:100vh;
      background: radial-gradient(circle at top, #101827, #020617 60%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color:#e5e7eb;
      overflow-x:hidden;
    }
    .wrap{
      width:100%;
      max-width:1200px;
      margin:0 auto;
      padding:90px 16px 50px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    /* Top bar */
    .top-bar{
      position:fixed; top:16px; left:50%; transform:translateX(-50%);
      width:100%; max-width:1200px;
      display:flex; justify-content:space-between; align-items:center;
      padding:0 16px; z-index:40;
      pointer-events:none;
    }
    .top-left,.top-right{ pointer-events:auto; display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .top-logo{ font-size:12px; letter-spacing:.22em; text-transform:uppercase; color:#9ca3af; }

    .pill{
      border-radius:999px;
      border:1px solid rgba(148,163,184,.22);
      background: rgba(15,23,42,.55);
      padding:8px 12px;
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:#e5e7eb;
      cursor:default;
      max-width: 360px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .top-link{
      font-size:12px; padding:6px 10px; height:34px;
      display:inline-flex; align-items:center; justify-content:center;
      border-radius:999px; border:1px solid rgba(148,163,184,.45);
      color:#e5e7eb; text-decoration:none;
      letter-spacing:.14em; text-transform:uppercase;
      background:rgba(15,23,42,.85);
      cursor:pointer;
    }
    .top-link:hover{ border-color:#a5b4fc; box-shadow:0 0 10px rgba(129,140,248,.4); }
    .top-link.glow{ border-color: rgba(165,180,252,.75); box-shadow: 0 0 14px rgba(129,140,248,.28); }

    .panel{
      background: radial-gradient(circle at top left, #020617, #020617 70%);
      border-radius:26px;
      border:1px solid rgba(148,163,184,.20);
      padding:18px;
      display:flex;
      flex-direction:column;
      gap:14px;
      overflow:hidden;
    }

    .header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
    }

    .identity{
      display:flex;
      gap:12px;
      align-items:center;
      min-width:0;
    }
    .avatar{
      width:44px; height:44px; border-radius:14px;
      border:1px solid rgba(148,163,184,.22);
      background: rgba(15,23,42,.45);
      display:flex; align-items:center; justify-content:center;
      font-size:18px;
      flex:0 0 auto;
    }
    .id-meta{ min-width:0; }
    h1{
      font-size:18px; font-weight:900;
      letter-spacing:.10em; text-transform:uppercase; color:#f9fafb;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width:min(720px, 80vw);
    }
    .sub{
      margin-top:4px;
      font-size:13px; color:#9ca3af; line-height:1.4;
      overflow:hidden; text-overflow:ellipsis;
    }

    .stats-row{ display:flex; flex-wrap:wrap; gap:10px; }
    .stat{
      border-radius:18px;
      border:1px solid rgba(148,163,184,.14);
      background: rgba(2,6,23,.28);
      padding:12px;
      min-width:200px;
      flex:1;
    }
    .stat .k{ font-size:10px; letter-spacing:.16em; text-transform:uppercase; color:#9ca3af; }
    .stat .v{ margin-top:6px; font-size:18px; font-weight:900; color:#f9fafb; }
    .stat .s{ margin-top:3px; font-size:12px; color:#9ca3af; line-height:1.35; }

    .hint{ font-size:12px; color:#9ca3af; line-height:1.45; }

    /* Cards list (stacks) */
    .grid{ display:flex; flex-direction:column; gap:12px; }
    .card{
      border-radius:20px; border:1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.28);
      padding:10px;
      display:flex; flex-direction:row; gap:12px; align-items:stretch;
      transition: transform .15s ease-out, box-shadow .15s ease-out, border-color .15s ease-out;
      cursor:default; user-select:none;
      overflow:hidden;
    }
    .card:hover{ transform: translateY(-2px); border-color: rgba(165,180,252,.55); box-shadow: 0 0 16px rgba(129,140,248,.18); }

    .thumb{
      width:92px; flex:0 0 auto;
      aspect-ratio: 3 / 4;
      border-radius:16px; overflow:hidden;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(2,6,23,.55);
    }
    .thumb img{ width:100%; height:100%; object-fit:contain; object-position:center; display:block; padding:6px; }

    .meta{
      flex:1; display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      min-width:0;
    }
    .name{
      font-size:11px; letter-spacing:.10em; text-transform:uppercase;
      font-weight:900; color:#f9fafb; line-height:1.2; min-width:0;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width:100%;
    }
    .ct{
      font-size:11px; color:#9ca3af; margin-top:6px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .price{ margin-top:6px; font-size:11px; color:#cbd5e1; letter-spacing:.06em; }

    .badges{ display:flex; flex-direction:column; gap:8px; align-items:flex-end; flex:0 0 auto; }

    .tag{
      font-size:10px; letter-spacing:.14em; text-transform:uppercase; font-weight:900;
      padding:6px 9px; border-radius:999px;
      border:1px solid rgba(148,163,184,.16);
      background: rgba(2,6,23,.35);
      white-space:nowrap;
    }
    .tag.pack{
      border-color: rgba(148,163,184,.20);
      background: rgba(15,23,42,.55);
      color:#e5e7eb;
    }
    .tag.epic{ color:#38bdf8; }
    .tag.ultra{ color:#a855f7; }
    .tag.legendary{ color:#f97316; }
    .tag.hidden{ color:#9ca3af; }

    .owned{
      font-size:10px; letter-spacing:.14em; text-transform:uppercase;
      padding:6px 9px; border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background: rgba(15,23,42,.35);
      color:#e5e7eb;
      white-space:nowrap;
    }

    /* Modal preview */
    .modal{
      position:fixed; inset:0; display:none;
      align-items:center; justify-content:center;
      z-index:80;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      padding:16px;
    }
    .modal.on{ display:flex; }
    .modal-card{
      width: min(430px, 92vw);
      border-radius:24px;
      border:1px solid rgba(148,163,184,.20);
      background: rgba(2,6,23,.86);
      box-shadow: 0 0 34px rgba(0,0,0,.5);
      padding:14px;
      position:relative;
      animation: popIn 140ms ease-out;
    }
    @keyframes popIn{ from{ transform:scale(.985); opacity:0; } to{ transform:scale(1); opacity:1; } }
    .modal-img{
      width:100%; aspect-ratio:3/4;
      border-radius:18px; overflow:hidden;
      border:1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.55);
    }
    .modal-img img{ width:100%; height:100%; object-fit:contain; object-position:center; display:block; padding:10px; }
    .modal-meta{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:10px; }
    .modal-name{ font-size:12px; letter-spacing:.12em; text-transform:uppercase; font-weight:900; color:#e5e7eb; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .modal-tag{
      font-size:11px; letter-spacing:.14em; text-transform:uppercase;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(148,163,184,.20);
      background: rgba(15,23,42,.55);
      color:#e5e7eb;
      white-space:nowrap;
    }
    .modal-price{ margin-top:10px; font-size:12px; color:#cbd5e1; letter-spacing:.08em; }
    .modal-close{
      position:absolute; right:10px; top:10px;
      border:1px solid rgba(148,163,184,.20);
      background: rgba(15,23,42,.55);
      color:#e5e7eb;
      border-radius:999px;
      padding:8px 10px;
      cursor:pointer;
      font-size:12px;
    }
    .modal-close:hover{ border-color: rgba(165,180,252,.7); box-shadow: 0 0 10px rgba(129,140,248,.25); }

    @media (max-width: 520px){
      .ct{ white-space:normal; }
      .pill{ max-width: 220px; }
    }
  </style>
</head>

<body>
  <div class="top-bar">
    <div class="top-left">
      <div class="top-logo">VAULTSPIN Â· PLAYER</div>
      <div class="pill" id="month-pill">â€”</div>
      <div class="pill" id="pack-pill" style="display:none;">â€”</div>
    </div>
    <div class="top-right">
      <a class="top-link" href="index.html">Packs</a>
      <a class="top-link" href="leaderboard.html">Leaderboard</a>
      <a class="top-link glow" href="collection.html">Ma collection</a>
      <a class="top-link glow" href="me.html">Mon profil</a>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true">
      <button class="modal-close" id="modal-close">âœ•</button>
      <div class="modal-img">
        <img id="modal-img" src="" alt="Preview" />
      </div>
      <div class="modal-meta">
        <div class="modal-name" id="modal-name">â€”</div>
        <div class="modal-tag" id="modal-tag" style="display:none;">â€”</div>
      </div>
      <div class="modal-price" id="modal-price">Valeur estimÃ©e : â€”</div>
    </div>
  </div>

  <div class="wrap">
    <div class="panel">
      <div class="header">
        <div class="identity">
          <div class="avatar" id="p-avatar">ðŸ‘¤</div>
          <div class="id-meta">
            <h1 id="p-title">Profil</h1>
            <div class="sub" id="p-sub">Chargementâ€¦</div>
          </div>
        </div>

        <a class="top-link glow" href="index.html">Ouvrir un pack</a>
      </div>

      <div class="stats-row">
        <div class="stat">
          <div class="k">Points (mois)</div>
          <div class="v" id="stat-points">â€”</div>
          <div class="s" id="stat-month">â€”</div>
        </div>
        <div class="stat">
          <div class="k">Classement</div>
          <div class="v" id="stat-rank">â€”</div>
          <div class="s">Rang global du mois</div>
        </div>
        <div class="stat">
          <div class="k">Total NFTs</div>
          <div class="v" id="stat-total">0</div>
          <div class="s">Cartes visibles</div>
        </div>
        <div class="stat">
          <div class="k">Vault value</div>
          <div class="v" id="stat-vault">0â‚¬</div>
          <div class="s">Somme (estimated_value_eur)</div>
        </div>
      </div>

      <div class="hint" id="p-hint">
        Astuce : clique sur une carte pour la voir en grand.
      </div>
    </div>

    <div class="panel">
      <div class="hint" id="empty" style="display:none;">
        Ce joueur nâ€™a pas encore de cartes visibles (profil privÃ© ou aucune ouverture).
      </div>
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <script type="module">
    import { supabase } from "./js/supabaseClient.js";

    /* ---------- Helpers ---------- */
    function monthKey(d = new Date()){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      return `${y}-${m}`;
    }
    function monthStartISO(d = new Date()){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      return `${y}-${m}-01`; // DATE
    }
    function fmtEur(n){
      return (Number(n) || 0).toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " â‚¬";
    }
    function fmtPts(n){ return (Number(n)||0).toLocaleString("fr-FR"); }
    function escapeHtml(s){
      return String(s || "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
      }[c]));
    }
    function escapeAttr(s){ return String(s || "").replace(/"/g, "&quot;"); }

    function rewardForRank(rank1){
      if (rank1 < 1 || rank1 > 10) return null;
      return 1100 - (rank1 * 100);
    }

    const RARITY_ORDER = ["HIDDEN","EPIC","ULTRA","LEGENDARY"];
    function rarityRank(k){
      const kk = (k || "").toUpperCase();
      const i = RARITY_ORDER.indexOf(kk);
      return i === -1 ? 0 : i;
    }
    function rarityClass(k){
      const kk = (k || "").toUpperCase();
      if (kk === "LEGENDARY") return "legendary";
      if (kk === "ULTRA") return "ultra";
      if (kk === "EPIC") return "epic";
      if (kk === "HIDDEN") return "hidden";
      return "";
    }

    function openModal({ img, name, rarity, price }){
      document.getElementById("modal-img").src = img || "";
      document.getElementById("modal-name").textContent = name || "â€”";
      const tag = document.getElementById("modal-tag");
      if (rarity){
        tag.style.display = "inline-flex";
        tag.textContent = rarity;
      } else {
        tag.style.display = "none";
        tag.textContent = "";
      }
      document.getElementById("modal-price").textContent = "Valeur estimÃ©e : " + fmtEur(price || 0);
      const modal = document.getElementById("modal");
      modal.classList.add("on");
      modal.setAttribute("aria-hidden", "false");
    }
    function closeModal(){
      const modal = document.getElementById("modal");
      modal.classList.remove("on");
      modal.setAttribute("aria-hidden", "true");
    }

    function getUserIdFromUrl(){
      const p = new URLSearchParams(window.location.search);
      const u = p.get("u");
      return u && u.length > 10 ? u : null;
    }
    function getPackFromUrl(){
      const p = new URLSearchParams(window.location.search);
      const raw = (p.get("pack") || "").toUpperCase();
      if (raw === "PLANT" || raw === "WATER" || raw === "FIRE") return raw;
      return "ALL";
    }

    function setPills(){
      document.getElementById("month-pill").textContent = "Mois : " + monthKey(new Date());
      const pack = getPackFromUrl();
      const packPill = document.getElementById("pack-pill");
      if (pack && pack !== "ALL"){
        packPill.style.display = "inline-flex";
        packPill.textContent = "Pack : " + pack;
      } else {
        packPill.style.display = "none";
        packPill.textContent = "";
      }
    }

    /* ---------- Data fetch ---------- */
    async function fetchProfile(userId){
      // policies: profiles_public_read si is_public = true
      const { data, error } = await supabase
        .from("profiles")
        .select("id, email, username, display_name, is_public")
        .eq("id", userId)
        .maybeSingle();

      if (error) throw error;
      return data || null;
    }

    async function fetchCardsPublic(userId, pack){
      // policies: cards_public_read_if_profile_public
      let q = supabase
        .from("user_cards")
        .select("id, user_id, token_id, pack_key, card_type_index, rarity_key, image_url, card_name, estimated_value_eur, opened_at")
        .eq("user_id", userId)
        .order("opened_at", { ascending: false })
        .limit(5000);

      if (pack && pack !== "ALL"){
        q = q.eq("pack_key", pack);
      }

      const { data, error } = await q;
      if (error) throw error;
      return data || [];
    }

    async function fetchMonthlyPoints(userId, monthISO, pack){
      // pack-aware si colonne pack_key existe dans user_points_monthly (sinon fallback)
      if (pack && pack !== "ALL"){
        try{
          const { data, error } = await supabase
            .from("user_points_monthly")
            .select("points")
            .eq("user_id", userId)
            .eq("month", monthISO)
            .eq("pack_key", pack)
            .maybeSingle();
          if (error) throw error;
          return Number(data?.points || 0);
        }catch(_e){
          // fallback
        }
      }

      const { data, error } = await supabase
        .from("user_points_monthly")
        .select("points")
        .eq("user_id", userId)
        .eq("month", monthISO)
        .maybeSingle();

      if (error) throw error;
      return Number(data?.points || 0);
    }

    async function computeRank(monthISO, myPoints, pack){
      if (!myPoints) return null;

      if (pack && pack !== "ALL"){
        try{
          const { count, error } = await supabase
            .from("user_points_monthly")
            .select("user_id", { count: "exact", head: true })
            .eq("month", monthISO)
            .eq("pack_key", pack)
            .gt("points", myPoints);

          if (error) throw error;
          return Number(count || 0) + 1;
        } catch(_e){
          // fallback
        }
      }

      const { count, error } = await supabase
        .from("user_points_monthly")
        .select("user_id", { count: "exact", head: true })
        .eq("month", monthISO)
        .gt("points", myPoints);

      if (error) throw error;
      return Number(count || 0) + 1;
    }

    function vaultValue(items){
      let sum = 0;
      for (const x of items){
        sum += Number(x.estimated_value_eur || 0) || 0;
      }
      return sum;
    }

    function groupByStack(items){
      const map = new Map();
      for (const x of (items || [])){
        const pk = (x.pack_key || "PLANT").toString().toUpperCase();
        const ct = Number(x.card_type_index ?? -1);
        if (!Number.isFinite(ct) || ct < 0) continue;

        const key = pk + ":" + String(ct);
        if (!map.has(key)){
          map.set(key, {
            key,
            pack_key: pk,
            cardTypeIndex: ct,
            img: x.image_url || "",
            name: x.card_name || ("Card #" + ct),
            owned: 0,
            lastTs: 0,
            lastTokenId: null,
            price: Number(x.estimated_value_eur || 0) || 0,
            rarity_key: (x.rarity_key || "").toUpperCase() || null
          });
        }

        const g = map.get(key);
        g.owned += 1;

        const ts = x.opened_at ? new Date(x.opened_at).getTime() : 0;
        if (ts > g.lastTs){
          g.lastTs = ts;
          g.lastTokenId = x.token_id ?? null;
        }

        const px = Number(x.estimated_value_eur || 0) || 0;
        if (px > g.price) g.price = px;

        const rk = (x.rarity_key || "").toUpperCase();
        if (rk && rarityRank(rk) > rarityRank(g.rarity_key)) g.rarity_key = rk;

        if (!g.img && x.image_url) g.img = x.image_url;
        if ((!g.name || g.name.startsWith("Card #")) && x.card_name) g.name = x.card_name;
      }
      return Array.from(map.values());
    }

    function renderHeader(profile, userId){
      const name = profile?.display_name || profile?.username || profile?.email || "Player";
      document.getElementById("p-title").textContent = name;

      const short = userId.slice(0, 6) + "â€¦" + userId.slice(-4);
      const privacy = profile?.is_public ? "public" : "privÃ©";
      document.getElementById("p-sub").textContent = `ID: ${short} Â· Profil ${privacy}`;
      document.getElementById("p-avatar").textContent = (name || "P").trim().slice(0,1).toUpperCase();
    }

    function renderStats(points, rank, totalCards, vaultEur){
      document.getElementById("stat-points").textContent = fmtPts(points);
      document.getElementById("stat-rank").textContent = rank ? ("#" + String(rank)) : "â€”";
      document.getElementById("stat-total").textContent = String(totalCards);
      document.getElementById("stat-vault").textContent = fmtEur(vaultEur);

      const d = new Date();
      const monthLabel = d.toLocaleString("fr-FR", { month:"long", year:"numeric" });
      const r = rank ? rewardForRank(rank) : null;
      document.getElementById("stat-month").textContent = monthLabel + (r ? (" Â· Reward: " + r + "â‚¬") : "");
    }

    function renderStacks(stacks){
      const grid = document.getElementById("grid");
      const empty = document.getElementById("empty");

      grid.innerHTML = "";
      if (!stacks.length){
        empty.style.display = "block";
        return;
      }
      empty.style.display = "none";

      stacks.sort((a,b) => {
        const ra = rarityRank(a.rarity_key);
        const rb = rarityRank(b.rarity_key);
        return (rb - ra) || (b.price - a.price) || (b.owned - a.owned);
      });

      for (const s of stacks){
        const card = document.createElement("div");
        card.className = "card";

        const thumb = document.createElement("div");
        thumb.className = "thumb";
        thumb.innerHTML = `<img src="${escapeAttr(s.img)}" alt="${escapeAttr(s.name)}"/>`;

        const meta = document.createElement("div");
        meta.className = "meta";

        const left = document.createElement("div");
        left.style.minWidth = "0";
        left.innerHTML = `
          <div class="name">${escapeHtml(s.name)}</div>
          <div class="ct">pack: ${escapeHtml(s.pack_key)} Â· cardTypeIndex: ${s.cardTypeIndex} Â· last: #${s.lastTokenId ?? "â€”"}</div>
          <div class="price">Valeur estimÃ©e : ${fmtEur(s.price)}</div>
        `;

        const badges = document.createElement("div");
        badges.className = "badges";

        const packTag = document.createElement("div");
        packTag.className = "tag pack";
        packTag.textContent = s.pack_key;
        badges.appendChild(packTag);

        if (s.rarity_key){
          const tag = document.createElement("div");
          tag.className = "tag " + rarityClass(s.rarity_key);
          tag.textContent = s.rarity_key;
          badges.appendChild(tag);
        }

        const owned = document.createElement("div");
        owned.className = "owned";
        owned.textContent = "Owned Â· " + s.owned;
        badges.appendChild(owned);

        meta.appendChild(left);
        meta.appendChild(badges);

        card.appendChild(thumb);
        card.appendChild(meta);

        card.addEventListener("click", () => {
          openModal({ img: s.img, name: `${s.name} (${s.pack_key} Â· ct ${s.cardTypeIndex})`, rarity: s.rarity_key || "", price: s.price });
        });

        grid.appendChild(card);
      }
    }

    /* ---------- Init ---------- */
    document.getElementById("modal-close").addEventListener("click", closeModal);
    document.getElementById("modal").addEventListener("click", (e) => { if (e.target.id === "modal") closeModal(); });
    document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

    const userId = getUserIdFromUrl();
    setPills();

    if (!userId){
      document.getElementById("p-title").textContent = "Profil introuvable";
      document.getElementById("p-sub").textContent = "ParamÃ¨tre manquant: ?u=";
      document.getElementById("empty").style.display = "block";
    } else {
      const pack = getPackFromUrl();
      const monthISO = monthStartISO();

      try{
        const profile = await fetchProfile(userId);
        if (!profile){
          document.getElementById("p-title").textContent = "Profil privÃ© / introuvable";
          document.getElementById("p-sub").textContent = "Ce joueur nâ€™est pas public ou nâ€™existe pas.";
          document.getElementById("empty").style.display = "block";
        } else {
          renderHeader(profile, userId);

          const [cards, points] = await Promise.all([
            fetchCardsPublic(userId, pack),
            fetchMonthlyPoints(userId, monthISO, pack),
          ]);

          const rank = await computeRank(monthISO, points, pack);

          renderStats(points, rank, cards.length, vaultValue(cards));

          const stacks = groupByStack(cards);
          renderStacks(stacks);
        }
      }catch(e){
        console.error(e);
        document.getElementById("p-title").textContent = "Erreur";
        document.getElementById("p-sub").textContent = (e?.message || "Impossible de charger le profil.");
        document.getElementById("empty").style.display = "block";
      }
    }
  </script>
</body>
</html>
