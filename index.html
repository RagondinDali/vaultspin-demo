<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>VaultSpin â€“ Pack Opening</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="animations.css" />

  <!-- âœ… Preload images visibles (sans WebP) -->
  <link rel="preload" as="image" href="images/germignon.png">
  <link rel="preload" as="image" href="images/astronelle.png">
  <link rel="preload" as="image" href="images/majaspic.png">
  <link rel="preload" as="image" href="images/chenipan.png">
  <link rel="preload" as="image" href="images/phyllali.png">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    /* âœ… FIX: empÃªcher tout scroll horizontal */
    html, body{
      width:100%;
      max-width:100%;
      overflow-x:hidden;
    }

    body{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:radial-gradient(circle at top,#101827,#020617 60%);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color:#e5e7eb;
    }

    .page{
      width:100%;
      max-width: min(1200px, calc(100vw - 32px)); /* âœ… FIX overflow subtil */
      padding:96px 16px 40px;
      display:flex;
      flex-direction:column;
      gap:24px;
    }

    /* âœ… Desktop: 3 colonnes (live + left + right) */
    @media (min-width: 900px){
      .page{
        flex-direction:row;
        gap:24px;
        align-items:flex-start;
      }
      .live-panel{ flex:0 0 280px; }
      .left-panel{ flex:1.1; }
      .right-panel{ flex:1; }
    }

    .left-panel,.right-panel{
      background:radial-gradient(circle at top left,#020617,#020617 70%);
      border-radius:28px;
      border:1px solid rgba(148,163,184,.20);
      padding:22px 22px 24px;
    }
    .left-panel{ display:flex; flex-direction:column; gap:16px; }
    .right-panel{ display:flex; flex-direction:column; gap:18px; }

    h1{ font-size:28px; font-weight:650; letter-spacing:.08em; text-transform:uppercase; color:#f9fafb; }
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      border-radius:999px; border:1px solid rgba(148,163,184,.30);
      padding:5px 10px;
      font-size:10px; letter-spacing:.16em; text-transform:uppercase;
      background:radial-gradient(circle at top,#111827,#020617 70%);
    }
    .btn-row{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
    .btn-primary{
      border-radius:999px; padding:10px 18px; font-size:13px;
      letter-spacing:.14em; text-transform:uppercase;
      border:none; cursor:pointer;
      display:inline-flex; align-items:center; gap:8px; white-space:nowrap;
      background:radial-gradient(circle at top left,#a855f7,#4f46e5);
      color:#f9fafb;
      box-shadow:0 0 18px rgba(168,85,247,.45);
      transition:transform .15s ease-out, box-shadow .15s ease-out, opacity .15s ease-out;
    }
    .btn-primary:hover{ transform:translateY(-1px); box-shadow:0 0 22px rgba(168,85,247,.65); }
    .btn-primary:disabled{ opacity:.45; cursor:default; box-shadow:none; }

    /* âœ… bouton gratuit */
    .btn-free{ background:radial-gradient(circle at top left,#22c55e,#16a34a); box-shadow:0 0 18px rgba(34,197,94,.35); }
    .btn-free:hover{ box-shadow:0 0 22px rgba(34,197,94,.55); }

    .status-line{
      font-size:13px; color:#e5e7eb;
      background:rgba(15,23,42,.55);
      border-radius:999px; padding:8px 14px;
      border:1px solid rgba(148,163,184,.22);
      display:inline-flex; align-items:center; gap:8px;
    }
    .status-dot{ width:8px; height:8px; border-radius:999px; background:#22c55e; }
    .status-dot.error{ background:#f97373; }
    .status-dot.pending{ background:#facc15; }

    /* Stats */
    .stats{
      margin-top:4px;
      padding:12px;
      border-radius:20px;
      border:1px solid rgba(148,163,184,.20);
      background:rgba(15,23,42,.35);
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:10px;
    }
    @media (max-width: 860px){
      .stats{ grid-template-columns: repeat(2, 1fr); }
    }
    .stat{
      border-radius:16px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(2,6,23,.32);
      padding:10px 10px;
      min-height:66px;
    }
    .stat .k{ font-size:10px; letter-spacing:.16em; text-transform:uppercase; color:#9ca3af; }
    .stat .v{ margin-top:5px; font-size:16px; font-weight:850; color:#f9fafb; }
    .stat .s{ margin-top:2px; font-size:11px; color:#9ca3af; }

    /* Best pull */
    .best-pull{ display:flex; align-items:center; gap:10px; margin-top:5px; }
    .best-thumb{ width:34px; height:34px; border-radius:10px; overflow:hidden; border:1px solid rgba(148,163,184,.20); background:rgba(15,23,42,.45); flex:0 0 auto; }
    .best-thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .best-meta{ display:flex; flex-direction:column; gap:1px; }
    .best-meta .line1{ font-size:12px; font-weight:800; color:#f9fafb; }
    .best-meta .line2{ font-size:11px; color:#9ca3af; }

    /* History */
    .history{
      margin-top:6px;
      padding:12px;
      border-radius:20px;
      border:1px solid rgba(148,163,184,.20);
      background:rgba(2,6,23,.24);
    }
    .history-title{
      font-size:10px; letter-spacing:.18em; text-transform:uppercase;
      color:#9ca3af;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom:10px;
    }
    .history-clear{
      font-size:10px; letter-spacing:.14em; text-transform:uppercase;
      border-radius:999px; padding:6px 10px;
      border:1px solid rgba(148,163,184,.20);
      background:rgba(15,23,42,.40);
      color:#e5e7eb; cursor:pointer;
    }
    .history-clear:hover{ border-color: rgba(165,180,252,.65); box-shadow: 0 0 10px rgba(129,140,248,.25); }
    .history-list{
      display:flex; flex-direction:column; gap:8px;
      max-height:200px; overflow:auto; padding-right:4px;
    }
    .hist-item{
      display:flex; align-items:center; gap:10px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(15,23,42,.28);
      padding:8px 10px;
    }
    .hist-dot{ width:10px; height:10px; border-radius:999px; background:#38bdf8; flex:0 0 auto; box-shadow:0 0 14px rgba(56,189,248,.18); }
    .hist-dot.ultra{ background:#a855f7; box-shadow:0 0 14px rgba(168,85,247,.22); }
    .hist-dot.legendary{ background:#f97316; box-shadow:0 0 16px rgba(249,115,22,.25); }
    .hist-dot.hidden{ background:#cbd5e1; box-shadow:0 0 14px rgba(203,213,225,.18); }
    .hist-main{ display:flex; flex-direction:column; gap:1px; min-width:0; }
    .hist-line1{
      font-size:12px; font-weight:800; color:#f9fafb;
      display:flex; gap:8px; align-items:center; min-width:0;
    }
    .pill-mini{
      font-size:10px; letter-spacing:.12em; text-transform:uppercase;
      padding:4px 8px; border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.35);
      color:#e5e7eb; flex:0 0 auto;
    }
    .hist-line2{ font-size:11px; color:#9ca3af; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* Right preview booster */
    .card-zone{
      width:100%;
      min-height:420px;
      border-radius:28px;
      border:1px dashed rgba(148,163,184,.30);
      background:radial-gradient(circle at top,#0b1120,#020617 70%);
      display:flex; align-items:center; justify-content:center;
      padding:28px 16px;
      position:relative;
      overflow:hidden;
    }
    .card-frame{
      position:relative;
      width:260px; height:380px;
      border-radius:24px;
      padding:2px;
      background:radial-gradient(circle at top,#22c55e,#064e3b 70%);
      box-shadow:0 0 36px rgba(34,197,94,.45);
    }
    .card-inner{ width:100%; height:100%; border-radius:22px; overflow:hidden; }

    /* Top bar */
    .top-bar{
      position:absolute;
      top:16px;
      left:50%;
      transform:translateX(-50%);
      width:100%;
      max-width:1200px;
      display:flex;
      justify-content:flex-end;
      align-items:center;
      padding:0 16px;
      pointer-events:none;
      z-index:50;
    }
    .top-right{ display:flex; align-items:center; gap:12px; pointer-events:auto; }
    .top-link{
      font-size:12px;
      padding:6px 10px;
      height:34px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.45);
      color:#e5e7eb;
      text-decoration:none;
      letter-spacing:.14em;
      text-transform:uppercase;
      background:rgba(15,23,42,.85);
    }
    .top-link:hover{ border-color:#a5b4fc; box-shadow:0 0 10px rgba(129,140,248,.4); }
    .top-link.glow{ border-color: rgba(165,180,252,.75); box-shadow: 0 0 14px rgba(129,140,248,.28); }

    /* âœ… Auth buttons */
    #vs-logout-btn.top-link{ cursor:pointer; }
    #vs-logout-btn.top-link:hover{ border-color:#a5b4fc; box-shadow:0 0 10px rgba(129,140,248,.4); }

    /* Wallet */
    .wallet-wrap{ position:relative; pointer-events:auto; }
    .wallet-wrap::after{ content:""; position:absolute; left:0; right:0; top:100%; height:14px; }
    .wallet-pill{
      display:inline-flex; align-items:center; gap:10px;
      border-radius:999px;
      height:34px;
      padding:0 12px;
      background:radial-gradient(circle at top,#020617,#020617 70%);
      border:1px solid rgba(148,163,184,.45);
      cursor:default;
    }
    .wallet-label{ font-size:10px; letter-spacing:.18em; text-transform:uppercase; color:#9ca3af; }
    .wallet-main{ font-size:12px; font-weight:800; color:#f9fafb; }
    .wallet-sub{ font-size:10px; color:#9ca3af; }
    .wallet-pop{
      position:absolute;
      right:0; top:44px;
      width:260px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.20);
      background:rgba(2,6,23,.92);
      backdrop-filter:blur(10px);
      padding:10px;
      box-shadow:0 0 24px rgba(0,0,0,.35);
      opacity:0;
      visibility:hidden;
      transform: translateY(-6px);
      pointer-events:none;
      transition: opacity .12s ease, transform .12s ease, visibility .12s ease;
    }
    .wallet-wrap:hover .wallet-pop{ opacity:1; visibility:visible; transform: translateY(0); pointer-events:auto; }
    .wallet-pop h3{ margin:0 0 8px 0; font-size:11px; letter-spacing:.18em; text-transform:uppercase; color:#cbd5e1; }
    .wallet-hint{ margin-top:8px; font-size:11px; color:#9ca3af; line-height:1.35; }
    .btn-mini{
      border-radius:999px;
      padding:8px 10px;
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      border:1px solid rgba(148,163,184,.20);
      cursor:pointer;
      background:rgba(15,23,42,.55);
      color:#e5e7eb;
    }
    .btn-mini:hover{ border-color: rgba(165,180,252,.7); box-shadow:0 0 10px rgba(129,140,248,.25); }

    /* Hover preview float */
    .preview-float{
      position:fixed; top:50%; right:28px; transform:translateY(-50%);
      width:320px; aspect-ratio:3/4;
      border-radius:18px;
      overflow:hidden;
      background:rgba(2,6,23,.90);
      border:1px solid rgba(148,163,184,.22);
      box-shadow:0 0 30px rgba(0,0,0,.6);
      opacity:0; pointer-events:none;
      transition: opacity .12s ease;
      z-index:120;
    }
    .preview-float.on{ opacity:1; }
    .preview-float img{ width:100%; height:100%; object-fit:contain; background:#020617; padding:8px; display:block; }
    .preview-float-meta{
      position:absolute; left:10px; right:10px; bottom:10px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .pf-name{
      font-size:11px; letter-spacing:.12em; text-transform:uppercase; font-weight:900;
      color:#e5e7eb; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(148,163,184,.16);
      background:rgba(2,6,23,.45);
      max-width:70%;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .pf-tag{
      font-size:11px; letter-spacing:.14em; text-transform:uppercase;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(148,163,184,.16);
      background:rgba(2,6,23,.45);
      font-weight:900;
    }
    .pf-tag.epic{ color:#38bdf8; }
    .pf-tag.ultra{ color:#a855f7; }
    .pf-tag.legendary{ color:#f97316; }
    .pf-tag.hidden{ display:none; }

    /* Opening overlay */
    .open-overlay{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      z-index:140;
      background:rgba(0,0,0,.62);
      backdrop-filter: blur(12px);
      padding:18px;
    }
    .open-overlay.on{ display:flex; }
    .open-modal{
      width:min(1180px, 98vw);
      border-radius:26px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(2,6,23,.90);
      box-shadow:0 0 44px rgba(0,0,0,.55);
      padding:18px;
      position:relative;
    }
    .open-top{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:12px; }
    .open-title{ font-size:12px; letter-spacing:.22em; text-transform:uppercase; color:#cbd5e1; font-weight:800; }
    .open-right{ display:flex; gap:10px; align-items:center; }
    .open-btn{
      border-radius:999px;
      padding:10px 14px;
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      border:1px solid rgba(148,163,184,.20);
      background:rgba(15,23,42,.55);
      color:#e5e7eb;
      cursor:pointer;
    }
    .open-btn.primary{
      border:none;
      background: radial-gradient(circle at top left, #a855f7, #4f46e5);
      box-shadow: 0 0 18px rgba(168,85,247,.30);
    }
    .open-btn.close-glow{
      border-color: rgba(165,180,252,.75);
      box-shadow: 0 0 14px rgba(129,140,248,.28);
    }
    .open-btn:disabled{ opacity:.45; cursor:default; }

    /* Reel */
    .reel-section{ display:block; }
    .reel-section.hidden{ display:none; }
    .reel-viewport{
      position:relative;
      border-radius:22px;
      border:1px solid rgba(148,163,184,.20);
      background:radial-gradient(circle at top,#0b1120,#020617 70%);
      overflow:hidden;
      padding:18px 12px;
    }
    .reel-strip{ position:relative; height:188px; display:flex; align-items:center; }
    .reel-fade-left, .reel-fade-right{ position:absolute; top:0; bottom:0; width:140px; pointer-events:none; z-index:3; }
    .reel-fade-left{ left:0; background: linear-gradient(to right, rgba(2,6,23,.94), rgba(2,6,23,0)); }
    .reel-fade-right{ right:0; background: linear-gradient(to left, rgba(2,6,23,.94), rgba(2,6,23,0)); }
    .reel-cursor-line{
      position:absolute; left:50%; top:14px; transform:translateX(-50%);
      width:4px; height:126px;
      border-radius:999px;
      background: linear-gradient(to bottom, transparent, rgba(250,204,21,.95), transparent);
      box-shadow: 0 0 18px rgba(250,204,21,.55);
      z-index:4; pointer-events:none; opacity:.98;
    }
    .reel-track{ display:flex; align-items:center; gap:12px; will-change: transform; transform: translateX(0px); }
    .reel-track.spinning{ transition: transform 7.1s cubic-bezier(0.08, 0.84, 0.12, 1); }
    .reel-item{
      width:168px; height:184px;
      border-radius:20px;
      overflow:hidden;
      border:1px solid rgba(148,163,184,.16);
      background:rgba(15,23,42,.28);
      flex:0 0 auto;
      position:relative;
    }
    .reel-thumb{ width:100%; height:132px; overflow:hidden; border-bottom:1px solid rgba(148,163,184,.12); background:#020617; }
    .reel-thumb img{ width:100%; height:100%; object-fit:contain; object-position:center; display:block; padding:6px; background:#020617; }
    .reel-meta{ padding:10px 12px 12px; display:flex; justify-content:space-between; align-items:center; gap:10px; min-width:0; }
    .reel-name{ font-size:10px; letter-spacing:.12em; text-transform:uppercase; font-weight:900; color:#e5e7eb; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .reel-tag{
      font-size:10px; letter-spacing:.12em; text-transform:uppercase;
      padding:4px 8px; border-radius:999px;
      border:1px solid rgba(148,163,184,.16);
      background:rgba(2,6,23,.35);
      flex:0 0 auto;
      font-weight:900;
      min-width:52px; text-align:center;
    }
    .reel-tag.epic{ color:#38bdf8; }
    .reel-tag.ultra{ color:#a855f7; }
    .reel-tag.legendary{ color:#f97316; }
    .reel-tag.hidden{ display:none; }

    /* Result-only */
    .result-section{ display:none; }
    .result-section.on{ display:block; }
    .result-wrap{ display:flex; align-items:center; justify-content:center; padding:8px 0; }
    .result-center{ width:min(420px, 92vw); display:flex; flex-direction:column; align-items:center; gap:10px; }
    .result-card{
      width:100%;
      border-radius:22px;
      border:1px solid rgba(148,163,184,.20);
      background:rgba(2,6,23,.35);
      padding:10px;
    }
    .result-img{
      width:100%;
      aspect-ratio:3/4;
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(148,163,184,.22);
      background:#020617;
      position:relative;
    }
    .result-img img{ width:100%; height:100%; object-fit:contain; object-position:center; display:block; padding:8px; background:#020617; }
    .result-meta{ margin-top:10px; display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
    .result-name{ font-size:12px; letter-spacing:.12em; text-transform:uppercase; font-weight:900; color:#f9fafb; }
    .result-sub{ margin-top:4px; font-size:12px; color:#9ca3af; line-height:1.35; white-space:pre-line; }
    .result-pill{
      font-size:11px; letter-spacing:.14em; text-transform:uppercase;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(148,163,184,.20);
      background:rgba(2,6,23,.35);
      font-weight:900; white-space:nowrap;
    }
    .result-pill.epic{ color:#38bdf8; }
    .result-pill.ultra{ color:#a855f7; }
    .result-pill.legendary{ color:#f97316; }
    .result-profit{
      margin-top:10px;
      font-size:12px; font-weight:900;
      border:1px solid rgba(148,163,184,.20);
      background:rgba(2,6,23,.35);
      padding:8px 10px;
      border-radius:999px;
      display:inline-flex;
      align-items:center; gap:8px;
      color:#e5e7eb;
    }
    .result-btnrow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; }

    .fly-out{ animation: flyToCollection .85s ease-in forwards; transform-origin:center; }
    @keyframes flyToCollection{
      0%{ transform:translate(0,0) scale(1); opacity:1; }
      60%{ transform:translate(120px,-90px) scale(.92); opacity:.95; }
      100%{ transform:translate(210px,-160px) scale(.72); opacity:0; }
    }

    /* Loot table */
    .drop-table{
      margin-top:10px;
      padding:16px 18px 18px;
      border-radius:24px;
      border:1px solid rgba(148,163,184,.22);
      background:radial-gradient(circle at top left,#020617,#020617 70%);
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .drop-title{ font-size:11px; letter-spacing:.18em; text-transform:uppercase; color:#9ca3af; text-align:center; }
    .drop-grid{ display:grid; grid-template-columns: repeat(7, 1fr); gap:14px; justify-items:center; }
    @media (max-width: 1080px){ .drop-grid{ grid-template-columns: repeat(6, 1fr); } }
    @media (max-width: 900px){ .drop-grid{ grid-template-columns: repeat(5, 1fr); } }
    @media (max-width: 740px){ .drop-grid{ grid-template-columns: repeat(4, 1fr); } }

    .drop-item{ width:92px; display:flex; flex-direction:column; align-items:center; gap:6px; text-align:center; cursor:pointer; user-select:none; }
    .drop-thumb{ width:78px; height:100px; border-radius:14px; overflow:hidden; border:1px solid rgba(148,163,184,.22); background:#020617; transition:transform .16s ease-out, box-shadow .16s ease-out; }
    .drop-thumb img{ width:100%; height:100%; object-fit:contain; object-position:center; display:block; padding:6px; background:#020617; }
    .drop-name{ font-size:10px; letter-spacing:.10em; text-transform:uppercase; color:#e5e7eb; }
    .drop-meta{ font-size:9px; color:#9ca3af; display:flex; flex-direction:column; gap:2px; }
    .drop-tag{ letter-spacing:.14em; text-transform:uppercase; font-weight:700; }
    .drop-tag.epic{ color:#38bdf8; }
    .drop-tag.ultra{ color:#a855f7; }
    .drop-tag.legendary{ color:#f97316; }

    .drop-item[data-rarity="EPIC"]:hover .drop-thumb{ transform:translateY(-2px) scale(1.04); box-shadow:0 0 14px rgba(56,189,248,.28); }
    .drop-item[data-rarity="ULTRA"]:hover .drop-thumb{ transform:translateY(-2px) scale(1.04); box-shadow:0 0 16px rgba(168,85,247,.30); }
    .drop-item[data-rarity="LEGENDARY"]:hover .drop-thumb{ transform:translateY(-2px) scale(1.04); box-shadow:0 0 18px rgba(249,115,22,.33); }

    /* ===== Live Loots (colonne gauche) ===== */
    .live-panel{
      background:radial-gradient(circle at top left,#020617,#020617 70%);
      border-radius:28px;
      border:1px solid rgba(148,163,184,.20);
      padding:18px 14px 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .live-head{ display:flex; flex-direction:column; gap:4px; }
    .live-title{
      font-size:12px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:#f9fafb;
      font-weight:900;
    }
    .live-sub{ font-size:11px; color:#9ca3af; }

    /* 6 items visibles */
    .live-list{
      border-radius:18px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(2,6,23,.28);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      height:510px;
      overflow:auto;
    }
    .live-empty{ font-size:12px; color:#9ca3af; padding:8px 6px; }

    .loot-item{
      display:flex;
      gap:10px;
      align-items:center;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(15,23,42,.28);
      padding:8px;
      position:relative;
      user-select:none;
    }
    .loot-thumb{
      width:56px;
      height:72px;
      border-radius:12px;
      overflow:hidden;
      border:1px solid rgba(148,163,184,.18);
      background:#020617;
      flex:0 0 auto;
    }
    .loot-thumb img{
      width:100%;
      height:100%;
      object-fit:contain;
      padding:6px;
      display:block;
    }
    .loot-meta{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
      flex:1;
    }
    .loot-line1{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .loot-user{
      font-size:11px;
      font-weight:900;
      color:#f9fafb;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .loot-pill{
      font-size:10px;
      letter-spacing:.12em;
      text-transform:uppercase;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.16);
      background:rgba(2,6,23,.35);
      font-weight:900;
      white-space:nowrap;
    }
    .loot-pill.epic{ color:#38bdf8; }
    .loot-pill.ultra{ color:#a855f7; }
    .loot-pill.legendary{ color:#f97316; }
    .loot-pill.hidden{ color:#cbd5e1; }

    .loot-line2{
      font-size:11px;
      color:#9ca3af;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .loot-line3{
      margin-top:2px;
      font-size:11px;
      color:#cbd5e1;
      display:flex;
      justify-content:space-between;
      gap:8px;
    }

    /* Hover overlay + bouton profil */
    .loot-hover{
      position:absolute;
      inset:0;
      border-radius:14px;
      background:rgba(2,6,23,.78);
      backdrop-filter: blur(6px);
      border:1px solid rgba(165,180,252,.35);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px;
      opacity:0;
      pointer-events:none;
      transition:opacity .12s ease;
    }
    .loot-item:hover .loot-hover{
      opacity:1;
      pointer-events:auto;
    }
    .loot-hover-left{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .loot-hover-title{
      font-size:11px;
      font-weight:900;
      color:#f9fafb;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .loot-hover-sub{ font-size:11px; color:#9ca3af; }

    .loot-profile-btn{
      border-radius:999px;
      padding:8px 10px;
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      border:1px solid rgba(148,163,184,.20);
      cursor:pointer;
      background:rgba(15,23,42,.55);
      color:#e5e7eb;
    }
    .loot-profile-btn:hover{
      border-color: rgba(165,180,252,.7);
      box-shadow:0 0 10px rgba(129,140,248,.25);
    }
  </style>
</head>

<body>
  <!-- Hover preview -->
  <div class="preview-float" id="preview-float" aria-hidden="true">
    <img id="preview-img" src="" alt="Preview" loading="lazy" decoding="async" />
    <div class="preview-float-meta">
      <div class="pf-name" id="preview-name">â€”</div>
      <div class="pf-tag epic" id="preview-tag">EPIC</div>
    </div>
  </div>

  <!-- Opening overlay -->
  <div class="open-overlay" id="open-overlay" aria-hidden="true">
    <div class="open-modal" role="dialog" aria-modal="true">
      <div class="open-top">
        <div>
          <div class="open-title">VAULTSPIN Â· OPENING</div>
        </div>
        <div class="open-right">
          <button class="open-btn" id="open-skip">Skip</button>
          <button class="open-btn close-glow" id="open-close">Close</button>
        </div>
      </div>

      <div class="reel-section" id="reel-section">
        <div class="reel-viewport" id="reel-viewport">
          <div class="reel-fade-left"></div>
          <div class="reel-fade-right"></div>
          <div class="reel-strip">
            <div class="reel-cursor-line"></div>
            <div class="reel-track" id="reel-track"></div>
          </div>
        </div>
        <div style="margin-top:12px; display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <div style="font-size:12px; color:#9ca3af;" id="open-hint">Openingâ€¦</div>
          <div></div>
        </div>
      </div>

      <div class="result-section" id="result-section">
        <div class="result-wrap">
          <div class="result-center">
            <div class="result-card">
              <div class="result-img" id="result-imgwrap">
                <img id="result-img" src="" alt="Result" decoding="async" />
              </div>
              <div class="result-meta">
                <div>
                  <div class="result-name" id="result-name">â€”</div>
                  <div class="result-sub" id="result-desc">â€”</div>
                  <div class="result-profit" id="result-profit">Valeur : 0,00 â‚¬</div>
                </div>
                <div class="result-pill epic" id="result-pill">EPIC</div>
              </div>
            </div>

            <div class="result-btnrow">
              <button class="open-btn" id="result-sell">Revendre</button>
              <button class="open-btn primary" id="result-open-another">Open another pack</button>
              <a class="top-link glow" href="collection.html" style="display:inline-flex; align-items:center; justify-content:center; padding:0 14px; height:34px;">
                Ma collection
              </a>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Top bar -->
  <div class="top-bar">
    <div class="top-right">
      <!-- âœ… NEW: Profil bouton avant Ma collection -->
      <a id="vs-profile-link" class="top-link glow" href="player.html" style="display:none;">Profil</a>

      <a class="top-link glow" href="collection.html">Ma collection</a>
      <a class="top-link" href="leaderboard.html">Leaderboard</a>

      <!-- âœ… AUTH -->
      <span id="vs-user-email" class="top-link" style="display:none; max-width:220px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">â€”</span>
      <a id="vs-login-btn" class="top-link glow" href="login.html">Connexion</a>
      <button id="vs-logout-btn" class="top-link" style="display:none;">DÃ©connexion</button>

      <div class="wallet-wrap">
        <div class="wallet-pill" title="Wallet local (dÃ©mo)">
          <span class="wallet-label">Wallet</span>
          <span class="wallet-main" id="wallet-eur">0,00 â‚¬</span>
          <span class="wallet-sub" id="wallet-eth">â‰ˆ 0,0000 ETH</span>
        </div>
        <div class="wallet-pop">
          <h3>Wallet (dÃ©mo)</h3>
          <div class="wallet-hint" id="wallet-hint">Balance : <b>0,00 â‚¬</b></div>
          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn-mini" id="wallet-topup-100">+100â‚¬</button>
            <button class="btn-mini" id="reset-data">Reset data</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div class="page">
    <!-- âœ… COLONNE GAUCHE : Derniers loots -->
    <div class="live-panel">
      <div class="live-head">
        <div class="live-title">Derniers loots</div>
        <div class="live-sub">Global Â· temps rÃ©el</div>
      </div>

      <div class="live-list" id="vs-live-list">
        <div class="live-empty" id="vs-live-empty">Chargementâ€¦</div>
      </div>
    </div>

    <!-- LEFT -->
    <div class="left-panel">
      <div class="tag" style="align-self:flex-start;">VAULTSPIN Â· DÃ‰MO</div>
      <div><h1>Open your VaultSpin Pack</h1></div>

      <div class="btn-row">
        <button id="open-pack-btn" class="btn-primary">Open VaultSpin Pack â€” 24,99 â‚¬</button>
        <button id="free-pack-btn" class="btn-primary btn-free" disabled>Booster gratuit â€” 2500 pts</button>
      </div>

      <div id="status-line" class="status-line">
        <span class="status-dot" id="status-dot"></span>
        <span id="status-text">PrÃªt. Ouvre un pack.</span>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="k">Packs opened</div>
          <div class="v" id="stat-opened">0</div>
          <div class="s">Total</div>
        </div>
        <div class="stat">
          <div class="k">Spent</div>
          <div class="v" id="stat-spent">0â‚¬</div>
          <div class="s">Packs</div>
        </div>
        <div class="stat">
          <div class="k">Points</div>
          <div class="v" id="stat-points">0</div>
          <div class="s">+25 / pack</div>
        </div>
        <div class="stat">
          <div class="k">Vault value</div>
          <div class="v" id="stat-vault">0â‚¬</div>
          <div class="s">Estimation</div>
        </div>
        <div class="stat">
          <div class="k">Last pull</div>
          <div class="v" id="stat-last">â€”</div>
          <div class="s" id="stat-last-sub">â€”</div>
        </div>
        <div class="stat">
          <div class="k">Best pull</div>
          <div class="best-pull">
            <div class="best-thumb">
              <img id="stat-best-img" src="images/germignon.png" alt="Best" loading="lazy" decoding="async" />
            </div>
            <div class="best-meta">
              <div class="line1" id="stat-best-line1">â€”</div>
              <div class="line2" id="stat-best-line2">â€”</div>
            </div>
          </div>
        </div>
      </div>

      <div class="history">
        <div class="history-title">
          <span>Pack history</span>
          <button class="history-clear" id="clear-history">Clear</button>
        </div>
        <div class="history-list" id="history-list"></div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="right-panel">
      <div class="card-zone">
        <div class="card-frame">
          <div class="card-inner">
            <div id="booster-closed" class="booster-closed booster-mode-idle">
              <div class="booster-label">
                <div class="booster-leaf-icon">ðŸŒ¿</div>
                <div class="booster-chip">VaultSpin Pack</div>
                <div class="booster-title">Booster Plante</div>
                <div class="booster-subtitle">1 carte Ã  rÃ©vÃ©ler</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="drop-table">
        <div class="drop-title">Cartes potentiellement obtenables</div>
        <div class="drop-grid" id="drop-grid">
          <!-- EPIC -->
          <div class="drop-item" data-rarity="EPIC" data-name="Germignon" data-img="images/germignon.png" data-ct="2">
            <div class="drop-thumb"><img src="images/germignon.png" alt="Germignon" loading="lazy" decoding="async" /></div>
            <div class="drop-name">Germignon</div>
            <div class="drop-meta"><span class="drop-tag epic">EPIC</span></div>
          </div>
          <div class="drop-item" data-rarity="EPIC" data-name="Astronelle" data-img="images/astronelle.png" data-ct="3">
            <div class="drop-thumb"><img src="images/astronelle.png" alt="Astronelle" loading="lazy" decoding="async" /></div>
            <div class="drop-name">Astronelle</div>
            <div class="drop-meta"><span class="drop-tag epic">EPIC</span></div>
          </div>
          <div class="drop-item" data-rarity="EPIC" data-name="Majaspic" data-img="images/majaspic.png" data-ct="8">
            <div class="drop-thumb"><img src="images/majaspic.png" alt="Majaspic" loading="lazy" decoding="async" /></div>
            <div class="drop-name">Majaspic</div>
            <div class="drop-meta"><span class="drop-tag epic">EPIC</span></div>
          </div>
          <div class="drop-item" data-rarity="EPIC" data-name="Chenipan" data-img="images/chenipan.png" data-ct="6">
            <div class="drop-thumb"><img src="images/chenipan.png" alt="Chenipan" loading="lazy" decoding="async" /></div>
            <div class="drop-name">Chenipan</div>
            <div class="drop-meta"><span class="drop-tag epic">EPIC</span></div>
          </div>
          <div class="drop-item" data-rarity="EPIC" data-name="Phyllali" data-img="images/phyllali.png" data-ct="14">
            <div class="drop-thumb"><img src="images/phyllali.png" alt="Phyllali" loading="lazy" decoding="async" /></div>
            <div class="drop-name">Phyllali</div>
            <div class="drop-meta"><span class="drop-tag epic">EPIC</span></div>
          </div>
          <div class="drop-item" data-rarity="EPIC" data-name="Paras" data-img="images/paras.png" data-ct="13">
            <div class="drop-thumb"><img src="images/paras.png" alt="Paras" loading="lazy" decoding="async" /></div>
            <div class="drop-name">Paras</div>
            <div class="drop-meta"><span class="drop-tag epic">EPIC</span></div>
          </div>
          <div class="drop-item" data-rarity="EPIC" data-name="ChÃ©tiflor" data-img="images/chetiflor.png" data-ct="4">
            <div class="drop-thumb"><img src="images/chetiflor.png" alt="ChÃ©tiflor" loading="lazy" decoding="async" /></div>
            <div class="drop-name">ChÃ©tiflor</div>
            <div class="drop-meta"><span class="drop-tag epic">EPIC</span></div>
          </div>
          <div class="drop-item" data-rarity="EPIC" data-name="Mimitoss" data-img="images/mimitoss.png" data-ct="9">
            <div class="drop-thumb"><img src="images/mimitoss.png" alt="Mimitoss" loading="lazy" decoding="async" /></div>
            <div class="drop-name">Mimitoss</div>
            <div class="drop-meta"><span class="drop-tag epic">EPIC</span></div>
          </div>
          <div class="drop-item" data-rarity="EPIC" data-name="Noeufnoeuf" data-img="images/noeufnoeuf.png" data-ct="12">
            <div class="drop-thumb"><img src="images/noeufnoeuf.png" alt="Noeufnoeuf" loading="lazy" decoding="async" /></div>
            <div class="drop-name">Noeufnoeuf</div>
            <div class="drop-meta"><span class="drop-tag epic">EPIC</span></div>
          </div>

          <!-- ULTRA -->
          <div class="drop-item" data-rarity="ULTRA" data-name="Ã‰nergie Plante" data-img="images/energie_plante.png" data-ct="7">
            <div class="drop-thumb"><img src="images/energie_plante.png" alt="Ã‰nergie Plante" loading="lazy" decoding="async" /></div>
            <div class="drop-name">Ã‰nergie</div>
            <div class="drop-meta"><span class="drop-tag ultra">ULTRA</span></div>
          </div>
          <div class="drop-item" data-rarity="ULTRA" data-name="AÃ©romite" data-img="images/aeromite.png" data-ct="1">
            <div class="drop-thumb"><img src="images/aeromite.png" alt="AÃ©romite" loading="lazy" decoding="async" /></div>
            <div class="drop-name">AÃ©romite</div>
            <div class="drop-meta"><span class="drop-tag ultra">ULTRA</span></div>
          </div>
          <div class="drop-item" data-rarity="ULTRA" data-name="Jungko" data-img="images/jungko.png" data-ct="5">
            <div class="drop-thumb"><img src="images/jungko.png" alt="Jungko" loading="lazy" decoding="async" /></div>
            <div class="drop-name">Jungko</div>
            <div class="drop-meta"><span class="drop-tag ultra">ULTRA</span></div>
          </div>
          <div class="drop-item" data-rarity="ULTRA" data-name="Nidoking" data-img="images/nidoking.png" data-ct="11">
            <div class="drop-thumb"><img src="images/nidoking.png" alt="Nidoking" loading="lazy" decoding="async" /></div>
            <div class="drop-name">Nidoking</div>
            <div class="drop-meta"><span class="drop-tag ultra">ULTRA</span></div>
          </div>

          <!-- LEGENDARY -->
          <div class="drop-item" data-rarity="LEGENDARY" data-name="Florizarre" data-img="images/florizarre.png" data-ct="10">
            <div class="drop-thumb"><img src="images/florizarre.png" alt="Florizarre" loading="lazy" decoding="async" /></div>
            <div class="drop-name">Florizarre</div>
            <div class="drop-meta"><span class="drop-tag legendary">LEGENDARY</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sounds -->
  <audio id="sfx-booster" src="sounds/booster_open.mp3" preload="auto"></audio>
  <audio id="sfx-reveal" src="sounds/card_reveal.mp3" preload="auto"></audio>
  <audio id="sfx-legendary" src="sounds/legendary_fx.mp3" preload="auto"></audio>
  <audio id="sfx-tick" src="sounds/clic_clic.mp3" preload="auto"></audio>

  <script>
    /********************
     * STORAGE KEYS
     ********************/
    const VS_COLLECTION_KEY = "vaultspin_collection_v1";
    const VS_TOKEN_COUNTER_KEY = "vaultspin_demo_token_counter_v1";
    const VS_WALLET_SPENT_EUR_KEY = "vaultspin_wallet_spent_eur_v1";
    const VS_WALLET_BALANCE_EUR_KEY = "vaultspin_wallet_balance_eur_v1";

    /* âœ… Points + leaderboard (dÃ©mo/local UI) */
    const VS_USER_ID_KEY = "vaultspin_user_id_v1";
    const VS_USER_NAME_KEY = "vaultspin_user_name_v1";
    const VS_POINTS_KEY = "vaultspin_points_v1";
    const VS_LB_MONTH_KEY = "vaultspin_leaderboard_month_v1";
    const VS_LB_DATA_KEY = "vaultspin_leaderboard_data_v1";

    const POINTS_PER_PACK = 25;
    const FREE_PACK_COST_PTS = 2500;

    function monthKey(d = new Date()){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      return `${y}-${m}`;
    }

    function getUserId(){
      let id = localStorage.getItem(VS_USER_ID_KEY);
      if (!id){
        id = "u_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
        localStorage.setItem(VS_USER_ID_KEY, id);
      }
      return id;
    }

    function getUserName(){
      let name = localStorage.getItem(VS_USER_NAME_KEY);
      if (!name){
        name = "Player " + (Math.floor(Math.random()*9000) + 1000);
        localStorage.setItem(VS_USER_NAME_KEY, name);
      }
      return name;
    }

    function getPoints(){
      const raw = localStorage.getItem(VS_POINTS_KEY);
      const n = raw ? Number(raw) : 0;
      return Number.isFinite(n) ? Math.max(0, n) : 0;
    }
    function setPoints(v){
      localStorage.setItem(VS_POINTS_KEY, String(Math.max(0, Number(v) || 0)));
    }
    function canFreePack(){ return getPoints() >= FREE_PACK_COST_PTS; }

    function ensureLbMonth(){
      const nowM = monthKey();
      const storedM = localStorage.getItem(VS_LB_MONTH_KEY);
      if (storedM !== nowM){
        localStorage.setItem(VS_LB_MONTH_KEY, nowM);
        localStorage.setItem(VS_LB_DATA_KEY, JSON.stringify([
          { id:getUserId(), name:getUserName(), points:getPoints() }
        ]));
      }
    }

    function loadLb(){
      try{ return JSON.parse(localStorage.getItem(VS_LB_DATA_KEY) || "[]"); }
      catch{ return []; }
    }
    function saveLb(arr){ localStorage.setItem(VS_LB_DATA_KEY, JSON.stringify(arr)); }

    function syncLeaderboardMe(){
      ensureLbMonth();
      const arr = loadLb();
      const meId = getUserId();
      const idx = arr.findIndex(x => x.id === meId);
      const me = { id: meId, name: getUserName(), points: getPoints() };
      if (idx >= 0) arr[idx] = me; else arr.push(me);
      saveLb(arr.slice(0, 100));
    }

    function addPoints(delta){
      setPoints(getPoints() + (Number(delta) || 0));
      renderPoints();
      syncLeaderboardMe();
    }

    function spendPoints(cost){
      const pts = getPoints();
      if (pts < cost) return false;
      setPoints(pts - cost);
      renderPoints();
      syncLeaderboardMe();
      return true;
    }

    function renderPoints(){
      const pts = getPoints();
      const el = document.getElementById("stat-points");
      if (el) el.textContent = pts.toLocaleString("fr-FR");

      const freeBtn = document.getElementById("free-pack-btn");
      if (freeBtn){
        const ok = canFreePack() && !isBusy();
        freeBtn.disabled = !ok;
        freeBtn.textContent = canFreePack()
          ? `Booster gratuit â€” ${FREE_PACK_COST_PTS} pts`
          : `Booster gratuit â€” ${FREE_PACK_COST_PTS} pts (${pts}/${FREE_PACK_COST_PTS})`;
      }
    }

    /********************
     * ECONOMY
     ********************/
    const PACK_PRICE_EUR = 24.99;
    const EUR_TO_ETH = 1 / 3500;

    function getWalletSpent(){
      const raw = localStorage.getItem(VS_WALLET_SPENT_EUR_KEY);
      const n = raw ? Number(raw) : 0;
      return Number.isFinite(n) ? Math.max(0, n) : 0;
    }
    function setWalletSpent(v){
      localStorage.setItem(VS_WALLET_SPENT_EUR_KEY, String(Math.max(0, Number(v) || 0)));
    }
    function getWalletBalance(){
      const raw = localStorage.getItem(VS_WALLET_BALANCE_EUR_KEY);
      const n = raw ? Number(raw) : 0;
      return Number.isFinite(n) ? Math.max(0, n) : 0;
    }
    function setWalletBalance(v){
      localStorage.setItem(VS_WALLET_BALANCE_EUR_KEY, String(Math.max(0, Number(v) || 0)));
    }
    function creditWallet(amount){
      setWalletBalance(getWalletBalance() + (Number(amount) || 0));
      renderWallet();
    }

    function fmtEur(n){
      return (Number(n) || 0).toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " â‚¬";
    }
    function fmtEthFromEur(eur){
      const eth = (Number(eur)||0) * EUR_TO_ETH;
      return "â‰ˆ " + eth.toLocaleString("fr-FR", { minimumFractionDigits: 4, maximumFractionDigits: 4 }) + " ETH";
    }

    function renderWallet(){
      const bal = getWalletBalance();
      document.getElementById("wallet-eur").textContent = fmtEur(bal);
      document.getElementById("wallet-eth").textContent = fmtEthFromEur(bal);
      document.getElementById("wallet-hint").innerHTML =
        `Balance : <b>${fmtEur(bal)}</b><br/>Spent : <b>${fmtEur(getWalletSpent())}</b><br/>Pack : <b>${fmtEur(PACK_PRICE_EUR)}</b>`;
    }

    function debitPack(){
      const bal = getWalletBalance();
      if (bal < PACK_PRICE_EUR){
        setStatus("Fonds insuffisants. Ajoute +100â‚¬ dans le wallet.", "error");
        return false;
      }
      setWalletBalance(bal - PACK_PRICE_EUR);
      setWalletSpent(getWalletSpent() + PACK_PRICE_EUR);
      renderWallet();
      return true;
    }

    /********************
     * PRICES (source of truth)
     ********************/
    const CARD_PRICE_EUR_BY_INDEX = {
      0: 5.50,  // Phyllali PCA (HIDDEN)
      1: 135,
      2: 60,
      3: 70,
      4: 109,
      5: 209,
      6: 69,
      7: 129,
      8: 70,
      9: 109,
      10: 1350, // Florizarre
      11: 199,  // Nidoking
      12: 109,
      13: 109,
      14: 77,
      15: 15.50, // Boskara (HIDDEN)
      16: 4.00,  // Filentrappe (HIDDEN)
      17: 3.00,  // Peterson (HIDDEN)
      18: 7.00   // Scovilain (HIDDEN)
    };

    /********************
     * Cards meta
     ********************/
    const CARD_IMAGE_BY_INDEX = {
      0:"images/phyllali_PCA.png",
      1:"images/aeromite.png",
      2:"images/germignon.png",
      3:"images/astronelle.png",
      4:"images/chetiflor.png",
      5:"images/jungko.png",
      6:"images/chenipan.png",
      7:"images/energie_plante.png",
      8:"images/majaspic.png",
      9:"images/mimitoss.png",
      10:"images/florizarre.png",
      11:"images/nidoking.png",
      12:"images/noeufnoeuf.png",
      13:"images/paras.png",
      14:"images/phyllali.png",
      15:"images/boskara.png",
      16:"images/filentrappe.png",
      17:"images/peterson.png",
      18:"images/scovilain.png"
    };

    const CARD_NAME_BY_INDEX = {
      0:"Phyllali PCA",
      1:"AÃ©romite",
      2:"Germignon",
      3:"Astronelle",
      4:"ChÃ©tiflor",
      5:"Jungko",
      6:"Chenipan",
      7:"Ã‰nergie Plante",
      8:"Majaspic",
      9:"Mimitoss",
      10:"Florizarre",
      11:"Nidoking",
      12:"Noeufnoeuf",
      13:"Paras",
      14:"Phyllali",
      15:"Boskara",
      16:"Filentrappe",
      17:"Peterson",
      18:"Scovilain"
    };

    /********************
     * RARITY (display rules)
     * HIDDEN = aucun tag affichÃ©
     ********************/
    const CT_HIDDEN_PCA = 0;
    const CT_BOSKARA = 15;
    const CT_FILENTRAPPE = 16;
    const CT_PETERSON = 17;
    const CT_SCOVILAIN = 18;
    const CT_FLORIZARRE = 10;

    const HIDDEN_SET = new Set([CT_HIDDEN_PCA, CT_BOSKARA, CT_FILENTRAPPE, CT_PETERSON, CT_SCOVILAIN]);

    function rarityKeyForCt(ct){
      if (HIDDEN_SET.has(ct)) return "HIDDEN";
      if (ct === CT_FLORIZARRE) return "LEGENDARY";
      const price = CARD_PRICE_EUR_BY_INDEX[ct] ?? 0;
      if (price >= 121 && price <= 300) return "ULTRA";
      return "EPIC";
    }
    function rarityLabelForKey(k){
      if (k === "ULTRA") return "Ultra";
      if (k === "LEGENDARY") return "Legendary";
      if (k === "HIDDEN") return "";
      return "Epic";
    }
    function dotClassForRarityKey(k){
      if (k==="LEGENDARY") return "legendary";
      if (k==="ULTRA") return "ultra";
      if (k==="HIDDEN") return "hidden";
      return "";
    }

    /********************
     * Drop logic (bucketed)
     ********************/
    const POOL_ULTRA = [11, 1, 7, 5];
    const POOL_EPIC = [2, 3, 8, 6, 14, 13, 4, 9, 12];
    function pickFrom(arr){ return arr[Math.floor(Math.random() * arr.length)]; }
    function pickWeighted(pairs){
      let total = 0;
      for (const p of pairs) total += p.w;
      let r = Math.random() * total;
      for (const p of pairs){
        r -= p.w;
        if (r <= 0) return p.ct;
      }
      return pairs[pairs.length - 1].ct;
    }
    function pickHiddenCt(){
      return pickWeighted([
        { ct: CT_PETERSON, w: 60 },
        { ct: CT_FILENTRAPPE, w: 22 },
        { ct: CT_HIDDEN_PCA, w: 12 },
        { ct: CT_SCOVILAIN, w: 5 },
        { ct: CT_BOSKARA, w: 1 }
      ]);
    }
    function pickCardIndex(){
      const r = Math.random();
      if (r < (1/5000)) return CT_FLORIZARRE;
      if (r < (1/5000) + (1/50)) return pickFrom(POOL_ULTRA);
      if (r < (1/5000) + (1/50) + (1/20)) return pickFrom(POOL_EPIC);
      return pickHiddenCt();
    }

    /********************
     * Collection helpers
     ********************/
    function getCollection(){
      try{ return JSON.parse(localStorage.getItem(VS_COLLECTION_KEY) || "[]"); }
      catch{ return []; }
    }
    function setCollection(arr){ localStorage.setItem(VS_COLLECTION_KEY, JSON.stringify(arr)); }
    function nextLocalTokenId(){
      const raw = localStorage.getItem(VS_TOKEN_COUNTER_KEY);
      const n = raw ? Number(raw) : 1;
      const next = Number.isFinite(n) && n > 0 ? n : 1;
      localStorage.setItem(VS_TOKEN_COUNTER_KEY, String(next + 1));
      return next;
    }
    function pushToCollection(entry){
      const arr = getCollection();
      arr.unshift(entry);
      setCollection(arr);
    }
    function removeTokenFromCollection(tokenId){
      const arr = getCollection();
      const i = arr.findIndex(x => Number(x.tokenId) === Number(tokenId));
      if (i >= 0){
        arr.splice(i, 1);
        setCollection(arr);
      }
    }
    function formatDate(ts){
      const d = new Date(ts);
      return d.toLocaleString("fr-FR", { day:"2-digit", month:"2-digit", year:"2-digit", hour:"2-digit", minute:"2-digit" });
    }
    function bestPullFromCollection(arr){
      if (!arr.length) return null;
      const score = (rk) => rk==="LEGENDARY" ? 3 : rk==="ULTRA" ? 2 : rk==="EPIC" ? 1 : 0;
      let best = arr[0];
      for (const c of arr){
        if (score(c.rarityKey) > score(best.rarityKey)) best = c;
      }
      return best;
    }
    function vaultValueFromCollection(arr){
      let sum = 0;
      for (const x of arr){
        const ct = Number(x.cardTypeIndex ?? -1);
        if (!Number.isFinite(ct) || ct < 0) continue;
        sum += (CARD_PRICE_EUR_BY_INDEX[ct] ?? 0);
      }
      return sum;
    }

    /********************
     * UI
     ********************/
    const UI_STATE = { IDLE:"idle", OPENING:"opening", RESULT:"result" };
    let uiState = UI_STATE.IDLE;

    let sfxBooster=null, sfxReveal=null, sfxLegendary=null, sfxTickSrc=null;
    let tickA=null, tickB=null, tickFlip=false;
    let lastTickAt = 0;

    function sleep(ms){ return new Promise((r)=>setTimeout(r, ms)); }
    function isBusy(){ return uiState !== UI_STATE.IDLE; }

    function setStatus(text, mode="ok"){
      const t = document.getElementById("status-text");
      const d = document.getElementById("status-dot");
      t.textContent = text;
      d.classList.remove("error","pending");
      if (mode==="error") d.classList.add("error");
      if (mode==="pending") d.classList.add("pending");
    }

    function playSound(el){
      if(!el) return;
      try{ el.pause(); el.currentTime=0; el.play().catch(()=>{}); }catch(_){}
    }

    function stopTickAudio(){
      try{
        if (tickA){ tickA.pause(); tickA.currentTime = 0; }
        if (tickB){ tickB.pause(); tickB.currentTime = 0; }
      }catch(_){}
    }

    function playTick(){
      const now = performance.now();
      if (now - lastTickAt < 58) return;
      lastTickAt = now;
      const a = tickFlip ? tickA : tickB;
      tickFlip = !tickFlip;
      if (!a) return;
      try{ a.currentTime = 0; a.play().catch(()=>{}); }catch(_){}
    }

    function renderStats(){
      const arr = getCollection();
      const opened = arr.length;
      const spent = getWalletSpent();
      const last = opened ? arr[0] : null;
      const best = opened ? bestPullFromCollection(arr) : null;
      const vault = vaultValueFromCollection(arr);

      document.getElementById("stat-opened").textContent = String(opened);
      document.getElementById("stat-spent").textContent = spent.toLocaleString("fr-FR", { maximumFractionDigits: 2 }) + "â‚¬";
      document.getElementById("stat-vault").textContent = vault.toLocaleString("fr-FR", { maximumFractionDigits: 2 }) + "â‚¬";

      if (last){
        document.getElementById("stat-last").textContent = "#" + last.tokenId;
        document.getElementById("stat-last-sub").textContent = (last.rarityKey === "HIDDEN") ? "HIDDEN" : last.rarityKey;
      } else {
        document.getElementById("stat-last").textContent = "â€”";
        document.getElementById("stat-last-sub").textContent = "â€”";
      }

      if (best){
        document.getElementById("stat-best-img").src = best.img;
        document.getElementById("stat-best-line1").textContent =
          ((best.rarityKey === "HIDDEN") ? "HIDDEN" : best.rarityKey) + " #" + best.tokenId;
        document.getElementById("stat-best-line2").textContent = formatDate(best.ts);
      } else {
        document.getElementById("stat-best-line1").textContent = "â€”";
        document.getElementById("stat-best-line2").textContent = "â€”";
      }
    }

    function renderHistory(){
      const list = document.getElementById("history-list");
      const arr = getCollection().slice(0, 12);
      list.innerHTML = "";

      if (!arr.length){
        const empty = document.createElement("div");
        empty.style.fontSize = "12px";
        empty.style.color = "#9ca3af";
        empty.textContent = "Aucun pack ouvert pour lâ€™instant.";
        list.appendChild(empty);
        return;
      }

      for (const c of arr){
        const row = document.createElement("div");
        row.className = "hist-item";

        const dot = document.createElement("div");
        dot.className = "hist-dot " + dotClassForRarityKey(c.rarityKey);

        const main = document.createElement("div");
        main.className = "hist-main";

        const l1 = document.createElement("div");
        l1.className = "hist-line1";
        const label = (c.rarityKey === "HIDDEN") ? "HIDDEN" : c.rarityKey;
        l1.innerHTML = `<span>#${c.tokenId}</span><span class="pill-mini">${label}</span>`;

        const l2 = document.createElement("div");
        l2.className = "hist-line2";
        l2.textContent = formatDate(c.ts);

        main.appendChild(l1);
        main.appendChild(l2);
        row.appendChild(dot);
        row.appendChild(main);
        list.appendChild(row);
      }
    }

    function openOverlay(){
      const o = document.getElementById("open-overlay");
      o.classList.add("on");
      o.setAttribute("aria-hidden","false");
    }
    function closeOverlay(){
      const o = document.getElementById("open-overlay");
      o.classList.remove("on");
      o.setAttribute("aria-hidden","true");
    }
    function showReel(){
      document.getElementById("reel-section").classList.remove("hidden");
      document.getElementById("result-section").classList.remove("on");
      document.getElementById("open-close").style.display = "none";
      document.getElementById("open-skip").style.display = "inline-flex";
      document.getElementById("open-hint").textContent = "Openingâ€¦";
    }
    function showResult(){
      document.getElementById("reel-section").classList.add("hidden");
      document.getElementById("result-section").classList.add("on");
      document.getElementById("open-skip").style.display = "none";
      document.getElementById("open-close").style.display = "inline-flex";
    }

    /********************
     * Reel logic
     ********************/
    const REEL_TOTAL_ITEMS = 60;
    let spinning = false;
    let stopIndex = 0;
    let currentOpen = null;
    let rafId = null;
    let lastIndexUnderCursor = -1;

    function buildReelItems(winningCt){
      const arr = [];
      for (let i=0;i<REEL_TOTAL_ITEMS;i++) arr.push(pickCardIndex());
      stopIndex = Math.max(20, REEL_TOTAL_ITEMS - 10);
      arr[stopIndex] = winningCt;
      return arr;
    }

    function escapeHtml(s){
      return String(s || "").replace(/[&<>"']/g, (c) => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;" }[c]));
    }

    function renderReel(reelItems){
      const track = document.getElementById("reel-track");
      track.innerHTML = "";
      track.classList.remove("spinning");
      track.style.transition = "";
      track.style.transform = "translateX(0px)";
      void track.offsetHeight;

      for (let i=0;i<reelItems.length;i++){
        const ct = reelItems[i];
        const rk = rarityKeyForCt(ct);
        const el = document.createElement("div");
        el.className = "reel-item";
        el.setAttribute("data-i", String(i));
        el.innerHTML = `
          <div class="reel-thumb">
            <img src="${CARD_IMAGE_BY_INDEX[ct]}" alt="${escapeHtml(CARD_NAME_BY_INDEX[ct] || "Card")}" loading="lazy" decoding="async"/>
          </div>
          <div class="reel-meta">
            <div class="reel-name">${escapeHtml(CARD_NAME_BY_INDEX[ct] || "Card")}</div>
            <div class="reel-tag ${rk.toLowerCase()}">${rk === "HIDDEN" ? "" : rk}</div>
          </div>
        `;
        track.appendChild(el);
      }
    }

    function getStepPx(){
      const track = document.getElementById("reel-track");
      const first = track.firstElementChild;
      if (!first) return 180;
      const w = first.getBoundingClientRect().width;
      const gap = parseFloat(getComputedStyle(track).gap || "12") || 12;
      return w + gap;
    }

    function getTranslateX(el){
      const tr = getComputedStyle(el).transform;
      if (!tr || tr === "none") return 0;
      const m = tr.match(/matrix\(([^)]+)\)/);
      if (!m) return 0;
      const parts = m[1].split(",").map(x => parseFloat(x.trim()));
      return Number.isFinite(parts[4]) ? parts[4] : 0;
    }

    function startTickLoop(){
      const track = document.getElementById("reel-track");
      const viewport = document.getElementById("reel-viewport");
      lastIndexUnderCursor = -1;

      const loop = () => {
        if (!spinning) return;
        const x = getTranslateX(track);
        const step = getStepPx();
        const vw = viewport.getBoundingClientRect().width;
        const cursorX = vw / 2;
        const offset = -x;
        const idx = Math.floor((offset + cursorX) / step);
        if (idx !== lastIndexUnderCursor){
          lastIndexUnderCursor = idx;
          playTick();
        }
        rafId = requestAnimationFrame(loop);
      };
      rafId = requestAnimationFrame(loop);
    }

    function stopTickLoop(){
      if (rafId) cancelAnimationFrame(rafId);
      rafId = null;
    }

    async function spinToStop(){
      spinning = true;
      setStatus("Ouvertureâ€¦", "pending");
      stopTickAudio();
      playSound(sfxBooster);

      const track = document.getElementById("reel-track");
      const viewport = document.getElementById("reel-viewport");
      track.classList.remove("spinning");
      track.style.transition = "";
      track.style.transform = "translateX(0px)";
      void track.offsetHeight;

      const step = getStepPx();
      const vw = viewport.getBoundingClientRect().width;
      const cursorX = vw / 2;

      const targetCenter = stopIndex * step + (step / 2);
      const targetTranslate = targetCenter - cursorX;
      const jitter = (Math.random()*6) - 3;
      const finalX = -(targetTranslate + jitter);

      startTickLoop();
      track.classList.add("spinning");
      requestAnimationFrame(() => {
        track.style.transform = `translateX(${finalX}px)`;
      });

      await new Promise((resolve) => {
        track.addEventListener("transitionend", resolve, { once:true });
      });

      spinning = false;
      stopTickLoop();
    }

    function skipSpinNow(){
      if (!spinning) return;
      const track = document.getElementById("reel-track");
      const viewport = document.getElementById("reel-viewport");

      track.classList.remove("spinning");
      const step = getStepPx();
      const vw = viewport.getBoundingClientRect().width;
      const cursorX = vw / 2;

      const targetCenter = stopIndex * step + (step / 2);
      const targetTranslate = targetCenter - cursorX;
      const finalX = -(targetTranslate);

      track.style.transition = "transform 420ms cubic-bezier(.16,.84,.2,1)";
      track.style.transform = `translateX(${finalX}px)`;
    }

    function fillResultUI(){
      const { rarityKey, imgSrc, name, tokenId, ts, winningCt } = currentOpen;
      const price = CARD_PRICE_EUR_BY_INDEX[winningCt] ?? 0;

      document.getElementById("result-img").src = imgSrc;
      document.getElementById("result-name").textContent = `${name} â€” #${tokenId}`;

      const isHidden = HIDDEN_SET.has(winningCt);
      const desc = isHidden
        ? `${formatDate(ts)}\nValeur estimÃ©e : ${fmtEur(price)}`
        : `${rarityLabelForKey(rarityKey)} Â· ${formatDate(ts)}\nValeur estimÃ©e : ${fmtEur(price)}`;

      document.getElementById("result-desc").textContent = desc;

      const pill = document.getElementById("result-pill");
      if (isHidden){
        pill.style.display = "none";
      } else {
        pill.style.display = "inline-flex";
        pill.textContent = rarityKey;
        pill.className = "result-pill " + rarityKey.toLowerCase();
      }

      document.getElementById("result-profit").textContent = "Valeur : " + fmtEur(price);

      const sellBtn = document.getElementById("result-sell");
      sellBtn.disabled = false;
      sellBtn.textContent = "Revendre Â· " + fmtEur(price);
    }

    function commitToCollection(){
      const { winningCt, rarityKey, imgSrc, name, tokenId, ts } = currentOpen;
      const entry = {
        tokenId,
        ts,
        priceEur: PACK_PRICE_EUR,
        rarityKey,
        rarityLabel: rarityLabelForKey(rarityKey),
        cardTypeIndex: winningCt,
        img: imgSrc,
        name
      };
      pushToCollection(entry);
      renderStats();
      renderHistory();
      return entry;
    }

    function sellCurrentPull(){
      if (!currentOpen) return;
      const { winningCt, tokenId } = currentOpen;
      const price = CARD_PRICE_EUR_BY_INDEX[winningCt] ?? 0;

      removeTokenFromCollection(tokenId);
      creditWallet(price);
      renderStats();
      renderHistory();
      setStatus(`Revendu âœ… +${fmtEur(price)}`, "ok");

      const btn = document.getElementById("result-sell");
      btn.disabled = true;
    }

    async function openPackRoulette(mode="paid"){
      if (isBusy()) return;

      if (mode === "paid"){
        if (!debitPack()) return;
      } else {
        // âœ… spend points server-side if available (authoritative)
        try{
          if (window.vsSpendPointsServer){
            const res = await window.vsSpendPointsServer(FREE_PACK_COST_PTS);
            if (!res?.ok){
              setStatus(`Points insuffisants (${res?.points || 0}/${FREE_PACK_COST_PTS}).`, "error");
              return;
            }
            localStorage.setItem(VS_POINTS_KEY, String(res.points));
            renderPoints();
          } else {
            if (!spendPoints(FREE_PACK_COST_PTS)){
              setStatus("Points insuffisants pour un booster gratuit.", "error");
              return;
            }
          }
        }catch(e){
          // fallback demo local
          if (!spendPoints(FREE_PACK_COST_PTS)){
            setStatus("Points insuffisants pour un booster gratuit.", "error");
            return;
          }
        }
      }

      uiState = UI_STATE.OPENING;
      const mainBtn = document.getElementById("open-pack-btn");
      mainBtn.disabled = true;
      renderPoints();

      openOverlay();
      showReel();

      const winningCt = pickCardIndex();
      const rarityKey = rarityKeyForCt(winningCt);
      const imgSrc = CARD_IMAGE_BY_INDEX[winningCt] ?? CARD_IMAGE_BY_INDEX[2];
      const name = CARD_NAME_BY_INDEX[winningCt] || "Card";
      const tokenId = nextLocalTokenId();
      const ts = Date.now();

      currentOpen = { winningCt, rarityKey, imgSrc, name, tokenId, ts };

      const reelItems = buildReelItems(winningCt);
      renderReel(reelItems);

      await sleep(70);
      await spinToStop();

      playSound(sfxReveal);
      if (rarityKey === "LEGENDARY") playSound(sfxLegendary);

      // âœ… 1) localStorage (dÃ©mo)
      commitToCollection();

      // âœ… 2) DB Supabase (si dispo)
      try{
        if (window.vsSaveCardToDb){
          const price = CARD_PRICE_EUR_BY_INDEX[winningCt] ?? 0;
          await window.vsSaveCardToDb({
            token_id: tokenId,
            card_type_index: winningCt,
            rarity_key: (rarityKey === "HIDDEN") ? null : rarityKey,
            image_url: imgSrc,
            card_name: name,
            estimated_value_eur: price,
            opened_at: new Date(ts).toISOString()
          });
        }
      }catch(err){
        console.warn("DB save failed:", err);
        setStatus("Pack ouvert âœ… (DB en retard / erreur)", "pending");
      }

      fillResultUI();

      /* âœ… FIX: pas de double ajout de points.
         - si Supabase est connectÃ©, vsSaveCardToDb ajoute les points via RPC
         - si pas de Supabase, on ajoute localement ici
      */
      if (!window.vsSaveCardToDb){
        addPoints(POINTS_PER_PACK);
      }

      uiState = UI_STATE.RESULT;
      showResult();
      setStatus("Pack ouvert âœ…", "ok");

      mainBtn.disabled = false;
      renderPoints();
    }

    async function flyThenOpenAnother(){
      const imgwrap = document.getElementById("result-imgwrap");
      imgwrap.classList.add("fly-out");
      await sleep(850);
      imgwrap.classList.remove("fly-out");
      uiState = UI_STATE.IDLE;
      renderPoints();
      await openPackRoulette("paid");
    }

    function openCollectionFiltered(cardTypeIndex){
      window.location.href = "collection.html?ct=" + encodeURIComponent(String(cardTypeIndex));
    }

    function resetAllData(){
      localStorage.removeItem(VS_COLLECTION_KEY);
      localStorage.removeItem(VS_TOKEN_COUNTER_KEY);
      localStorage.removeItem(VS_WALLET_SPENT_EUR_KEY);
      localStorage.removeItem(VS_WALLET_BALANCE_EUR_KEY);
      localStorage.removeItem(VS_POINTS_KEY);
      localStorage.removeItem(VS_LB_DATA_KEY);
      localStorage.removeItem(VS_LB_MONTH_KEY);

      setStatus("Reset âœ…", "ok");
      renderWallet();
      renderStats();
      renderHistory();
      syncLeaderboardMe();
      renderPoints();
    }

    /********************
     * Hover preview
     ********************/
    function setPreview({ img, name, rarity }){
      const box = document.getElementById("preview-float");
      document.getElementById("preview-img").src = img || "";
      document.getElementById("preview-name").textContent = name || "â€”";
      const tag = document.getElementById("preview-tag");
      tag.textContent = rarity || "EPIC";
      tag.className = "pf-tag " + String(rarity || "EPIC").toLowerCase();
      box.classList.add("on");
      box.setAttribute("aria-hidden","false");
    }
    function clearPreview(){
      const box = document.getElementById("preview-float");
      box.classList.remove("on");
      box.setAttribute("aria-hidden","true");
    }

    /********************
     * Init
     ********************/
    document.addEventListener("DOMContentLoaded", () => {
      sfxBooster = document.getElementById("sfx-booster");
      sfxReveal = document.getElementById("sfx-reveal");
      sfxLegendary = document.getElementById("sfx-legendary");
      sfxTickSrc = document.getElementById("sfx-tick");

      try{
        const src = sfxTickSrc ? sfxTickSrc.getAttribute("src") : null;
        if (src){
          tickA = new Audio(src);
          tickB = new Audio(src);
          tickA.preload = "auto";
          tickB.preload = "auto";
          tickA.volume = 0.55;
          tickB.volume = 0.55;
        }
      }catch(_){}

      getUserId();
      getUserName();
      syncLeaderboardMe();

      renderWallet();
      renderStats();
      renderHistory();
      renderPoints();
      setStatus("PrÃªt. Ouvre un pack.", "ok");

      // âœ… expose pour module (sync server points)
      window.renderPoints = renderPoints;

      document.getElementById("open-pack-btn").addEventListener("click", () => openPackRoulette("paid"));
      document.getElementById("free-pack-btn").addEventListener("click", () => openPackRoulette("free"));

      document.getElementById("open-skip").addEventListener("click", () => { skipSpinNow(); });
      document.getElementById("result-open-another").addEventListener("click", async () => { await flyThenOpenAnother(); });
      document.getElementById("result-sell").addEventListener("click", sellCurrentPull);

      document.getElementById("open-close").addEventListener("click", () => {
        if (spinning) return;
        closeOverlay();
        uiState = UI_STATE.IDLE;
        renderPoints();
      });

      document.addEventListener("keydown", (e) => {
        if (e.key !== "Escape") return;
        const overlay = document.getElementById("open-overlay");
        if (overlay.classList.contains("on") && !spinning && uiState === UI_STATE.RESULT){
          closeOverlay();
          uiState = UI_STATE.IDLE;
          renderPoints();
        }
      });

      document.getElementById("wallet-topup-100").addEventListener("click", () => {
        creditWallet(100);
        setStatus("+100â‚¬ ajoutÃ©s âœ…", "ok");
      });

      document.getElementById("reset-data").addEventListener("click", resetAllData);

      document.getElementById("clear-history").addEventListener("click", () => {
        localStorage.removeItem(VS_COLLECTION_KEY);
        setStatus("History cleared âœ…", "ok");
        renderStats();
        renderHistory();
      });

      // Hover preview + click filter
      document.querySelectorAll(".drop-item").forEach((el) => {
        const img = el.getAttribute("data-img");
        const name = el.getAttribute("data-name");
        const rarity = el.getAttribute("data-rarity");
        const ct = el.getAttribute("data-ct");
        let timer = null;

        el.addEventListener("mouseenter", () => {
          timer = setTimeout(() => setPreview({ img, name, rarity }), 90);
        });
        el.addEventListener("mouseleave", () => {
          if (timer) clearTimeout(timer);
          clearPreview();
        });
        el.addEventListener("click", (e) => {
          e.preventDefault();
          clearPreview();
          openCollectionFiltered(ct);
        });
      });
    });
  </script>

  <!-- Hidden Pull FX discret -->
  <style>
    #result-imgwrap.fx-hidden{
      box-shadow: 0 0 0 1px rgba(203,213,225,.22), 0 0 26px rgba(203,213,225,.12) inset;
    }
    #result-imgwrap.fx-hidden::after{
      content:"";
      position:absolute;
      inset:-20%;
      background: radial-gradient(circle, rgba(203,213,225,.25) 0, rgba(203,213,225,0) 60%);
      mix-blend-mode: screen;
      opacity:.9;
      animation: hiddenPulse 900ms ease-out forwards;
      pointer-events:none;
    }
    @keyframes hiddenPulse{
      0%{ transform: scale(.7); opacity:0; }
      20%{ opacity:.9; }
      100%{ transform: scale(1.15); opacity:0; }
    }
  </style>
  <!-- âœ… AUTH + DB SAVE (Supabase) + âœ… POINTS RPC -->
  <script type="module">
    import { supabase } from "./js/supabaseClient.js";

    const loginBtn = document.getElementById("vs-login-btn");
    const logoutBtn = document.getElementById("vs-logout-btn");
    const emailEl = document.getElementById("vs-user-email");
    const paidBtn = document.getElementById("open-pack-btn");
    const freeBtn = document.getElementById("free-pack-btn");

    const POINTS_PER_PACK = 25;
    const FREE_PACK_COST_PTS = 2500;

    function setAuthed(label){
      if (emailEl){
        emailEl.style.display = "inline-flex";
        emailEl.textContent = label || "ConnectÃ©";
      }
      if (loginBtn) loginBtn.style.display = "none";
      if (logoutBtn) logoutBtn.style.display = "inline-flex";
    }
    function setNotAuthed(){
      if (emailEl){
        emailEl.style.display = "none";
        emailEl.textContent = "â€”";
      }
      if (loginBtn) loginBtn.style.display = "inline-flex";
      if (logoutBtn) logoutBtn.style.display = "none";
    }

    async function setAuthedFromSession(session){
      const { data, error } = await supabase
        .from("profiles")
        .select("username, display_name")
        .eq("id", session.user.id)
        .maybeSingle();

      const label = (!error && data)
        ? (data.display_name || data.username || session.user.email || "ConnectÃ©")
        : (session.user.email || "ConnectÃ©");

      setAuthed(label);
    }

    async function requireAuthOrRedirect(){
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user){
        window.location.href = "login.html";
        return null;
      }
      // Optionnel: forcer un username
      try{
        const { data } = await supabase
          .from("profiles")
          .select("username")
          .eq("id", session.user.id)
          .maybeSingle();
        if (!data?.username){
          window.location.href = "profile.html?next=./index.html";
          return null;
        }
      }catch(_){}
      return session;
    }

    /********************
     * âœ… POINTS RPC (server authoritative)
     ********************/
    async function vsGetPoints(){
      const { data, error } = await supabase.rpc("vs_get_points", {});
      if (error) throw error;
      return Number(data || 0);
    }
    async function vsAddPoints(delta){
      const { data, error } = await supabase.rpc("vs_add_points", { p_delta: delta });
      if (error) throw error;
      return Number(data || 0);
    }
    async function vsSpendPoints(cost){
      const { data, error } = await supabase.rpc("vs_spend_points", { p_cost: cost });
      if (error) throw error;
      const row = Array.isArray(data) ? data[0] : data;
      return { ok: !!row?.ok, points: Number(row?.points || 0) };
    }

    async function syncPointsToLocalStorage(){
      try{
        const { data: { session } } = await supabase.auth.getSession();
        if (!session?.user) return;
        const pts = await vsGetPoints();
        localStorage.setItem("vaultspin_points_v1", String(pts));
        if (window.renderPoints) window.renderPoints();
      }catch(e){
        console.warn("syncPointsToLocalStorage failed:", e);
      }
    }

    // expose spend pour openPackRoulette("free")
    window.vsSpendPointsServer = async (cost) => {
      return await vsSpendPoints(cost);
    };

    // âœ… EXPOSE: fonction DB save utilisable par ton <script> classique
    // âœ… FIX: on attribue +25 points ICI seulement (server authoritative)
    window.vsSaveCardToDb = async (card) => {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user) throw new Error("Not authenticated");

      const payload = {
        user_id: session.user.id,
        token_id: card.token_id ?? null,
        card_type_index: card.card_type_index,
        rarity_key: card.rarity_key ?? null,
        image_url: card.image_url ?? null,
        card_name: card.card_name ?? null,
        estimated_value_eur: card.estimated_value_eur ?? 0,
        opened_at: card.opened_at ?? new Date().toISOString(),
        chain_id: null,
        contract_address: null,
        onchain_token_id: null
      };

      const { error } = await supabase
        .from("user_cards")
        .insert(payload);

      if (error) throw error;

      // âœ… add points server-side (authoritative)
      try{
        const newPts = await vsAddPoints(POINTS_PER_PACK);
        localStorage.setItem("vaultspin_points_v1", String(newPts));
        if (window.renderPoints) window.renderPoints();
      }catch(e){
        console.warn("vsAddPoints failed:", e);
      }
      return true;
    };

    // 1) Etat initial
    const { data: { session } } = await supabase.auth.getSession();
    if (session?.user){
      await setAuthedFromSession(session);
      await syncPointsToLocalStorage();
    } else {
      setNotAuthed();
    }

    // 2) React aux changements login/logout
    supabase.auth.onAuthStateChange(async (_event, newSession) => {
      if (newSession?.user){
        await setAuthedFromSession(newSession);
        await syncPointsToLocalStorage();
      } else {
        setNotAuthed();
      }
    });

    // 3) Logout
    logoutBtn?.addEventListener("click", async () => {
      await supabase.auth.signOut();
    });

    // 4) GUARD (capture)
    paidBtn?.addEventListener("click", async (e) => {
      const s = await requireAuthOrRedirect();
      if (!s){
        e.preventDefault();
        e.stopImmediatePropagation();
        return;
      }
    }, true);

    freeBtn?.addEventListener("click", async (e) => {
      const s = await requireAuthOrRedirect();
      if (!s){
        e.preventDefault();
        e.stopImmediatePropagation();
        return;
      }
    }, true);

    /********************
     * âœ… BONUS: bouton "Profil" Ã  gauche de "Ma collection"
     * (tu mâ€™avais demandÃ© Ã§a)
     ********************/
    function ensureProfileLink(){
      const topRight = document.querySelector(".top-right");
      if (!topRight) return;

      // Evite doublons
      if (document.getElementById("vs-profile-link")) return;

      const a = document.createElement("a");
      a.id = "vs-profile-link";
      a.className = "top-link glow";
      a.textContent = "Profil";
      a.href = "profile.html";
      // insert avant "Ma collection"
      const coll = topRight.querySelector('a[href="collection.html"]');
      if (coll) topRight.insertBefore(a, coll);
      else topRight.insertBefore(a, topRight.firstChild);
    }
    ensureProfileLink();
  </script>

  <!-- âœ… LIVE LOOTS (colonne gauche) -->
  <script type="module">
    import { supabase } from "./js/supabaseClient.js";

    const listEl = document.getElementById("vs-live-list");

    function fmtEur(n){
      return (Number(n)||0).toLocaleString("fr-FR", { minimumFractionDigits:2, maximumFractionDigits:2 }) + " â‚¬";
    }
    function fmtTime(ts){
      const d = new Date(ts);
      return d.toLocaleString("fr-FR", { day:"2-digit", month:"2-digit", hour:"2-digit", minute:"2-digit" });
    }
    function pillClass(rk){
      const k = String(rk || "").toUpperCase();
      if (k === "LEGENDARY") return "legendary";
      if (k === "ULTRA") return "ultra";
      if (k === "HIDDEN") return "hidden";
      return "epic";
    }
    function escapeHtml(s){
      return String(s || "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
      }[c]));
    }
    function safeName(p){
      return (p?.display_name || p?.username || p?.email || "Player");
    }

    async function fetchLatestLoots(limit = 30){
      // âš ï¸ join via FK user_cards.user_id -> profiles.id
      const { data, error } = await supabase
        .from("user_cards")
        .select(`
          id,
          user_id,
          card_type_index,
          rarity_key,
          image_url,
          card_name,
          estimated_value_eur,
          opened_at,
          profiles:profiles!user_cards_user_id_fkey(display_name, username, email)
        `)
        .order("opened_at", { ascending: false })
        .limit(limit);

      if (error) throw error;

      return (data || []).map(x => ({
        id: x.id,
        user_id: x.user_id,
        opened_at: x.opened_at,
        img: x.image_url,
        name: x.card_name || ("Card ct " + x.card_type_index),
        rarity: (x.rarity_key || "EPIC").toUpperCase(),
        value: Number(x.estimated_value_eur || 0),
        player: safeName(x.profiles)
      }));
    }

    function renderItems(items){
      if (!listEl) return;
      listEl.innerHTML = "";

      if (!items.length){
        listEl.innerHTML = `<div class="live-empty">Aucun loot pour le moment.</div>`;
        return;
      }

      // âœ… 6 visibles + scroll => dÃ©jÃ  assurÃ© par CSS height + overflow:auto
      for (const it of items){
        const row = document.createElement("div");
        row.className = "loot-item";
        row.setAttribute("data-loot-id", String(it.id));

        row.innerHTML = `
          <div class="loot-thumb">
            <img src="${String(it.img || "").replace(/"/g,"&quot;")}" alt="loot"/>
          </div>

          <div class="loot-meta">
            <div class="loot-line1">
              <div class="loot-user">${escapeHtml(it.player)}</div>
              <div class="loot-pill ${pillClass(it.rarity)}">${escapeHtml(it.rarity)}</div>
            </div>
            <div class="loot-line2">${escapeHtml(it.name)}</div>
            <div class="loot-line3">
              <span>${fmtEur(it.value)}</span>
              <span>${fmtTime(it.opened_at)}</span>
            </div>
          </div>

          <div class="loot-hover">
            <div class="loot-hover-left">
              <div class="loot-hover-title">${escapeHtml(it.player)}</div>
              <div class="loot-hover-sub">Voir la collection & le rank</div>
            </div>
            <button class="loot-profile-btn" type="button">Profil</button>
          </div>
        `;

        row.querySelector(".loot-profile-btn")?.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          // page profil joueur (Ã  crÃ©er ensuite)
          window.location.href = `player.html?u=${encodeURIComponent(it.user_id)}`;
        });

        listEl.appendChild(row);
      }
    }

    let lastTopId = null;

    async function refreshLatest(){
      try{
        const items = await fetchLatestLoots(30);
        const topId = items[0]?.id ? String(items[0].id) : null;
        const isNewTop = topId && topId !== lastTopId;

        renderItems(items);

        // si nouveau loot en top => on remonte en haut comme Hellcase
        if (isNewTop){
          listEl.scrollTop = 0;
        }
        lastTopId = topId;
      }catch(err){
        console.error("Live feed error:", err);
        if (listEl && listEl.children.length === 0){
          listEl.innerHTML = `<div class="live-empty">Erreur feed (voir console).</div>`;
        }
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await refreshLatest();
      setInterval(refreshLatest, 4000);
    });
  </script>

</body>
</html>
