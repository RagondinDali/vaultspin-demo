
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>VaultSpin ‚Äì Pack Opening</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="animations.css" />

  <!-- ‚úÖ Preload images visibles (PLANTE) -->
  <link rel="preload" as="image" href="images/germignon.png">
  <link rel="preload" as="image" href="images/astronelle.png">
  <link rel="preload" as="image" href="images/majaspic.png">
  <link rel="preload" as="image" href="images/chenipan.png">
  <link rel="preload" as="image" href="images/phyllali.png">

  <!-- ‚úÖ Preload EAU -->
  <link rel="preload" as="image" href="images/aquali.png">
  <link rel="preload" as="image" href="images/givrali.png">
  <link rel="preload" as="image" href="images/flobio.png">
  <link rel="preload" as="image" href="images/lokhlass.png">
  <link rel="preload" as="image" href="images/tortank.png">

  <!-- ‚úÖ Preload FEU -->
  <link rel="preload" as="image" href="images/dracaufeu.png">
  <link rel="preload" as="image" href="images/dracaufeu_vmax.png">
  <link rel="preload" as="image" href="images/energie_feu.png">
  <link rel="preload" as="image" href="images/reshiram.png">
  <link rel="preload" as="image" href="images/typhlosion.png">

  <!-- ‚úÖ Preload MYTHIQUE (quelques cl√©s) -->
  <link rel="preload" as="image" href="images/arceus.png">
  <link rel="preload" as="image" href="images/mewtwo_gx_signed.png">
  <link rel="preload" as="image" href="images/pikachu.png">
  <link rel="preload" as="image" href="images/sulfura.png">

  <style>
    html, body { overflow-x:hidden; }
    * { box-sizing: border-box; margin: 0; padding: 0; }

    /* ‚úÖ FIX: emp√™cher tout scroll horizontal */
    html, body{
      width:100%;
      max-width:100%;
      overflow-x:hidden;
    }

    body{
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      background:radial-gradient(circle at top,#101827,#020617 60%);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color:#e5e7eb;
      overflow-x:hidden;
    }

    /* ‚úÖ remonter l‚Äôinterface + r√©duire ‚Äúvide‚Äù global */
    .page{
      width:100%;
      max-width: min(1200px, calc(100vw - 32px));
      padding:76px 16px 26px; /* avant: 96px 16px 40px */
      display:flex;
      flex-direction:column;
      gap:18px; /* avant: 24px */
    }

    /* ‚úÖ Desktop: 3 colonnes (live + left + right) */
    @media (min-width: 900px){
      .page{
        flex-direction:row;
        gap:18px; /* avant: 24px */
        align-items:flex-start;
      }
      .live-panel{
        flex:0 0 280px;
        max-width:280px;
        min-width:280px;
        box-sizing:border-box;
      }
    }

    .left-panel,.right-panel{
      background:radial-gradient(circle at top left,#020617,#020617 70%);
      border-radius:28px;
      border:1px solid rgba(148,163,184,.20);
      padding:20px 20px 22px; /* un peu plus compact */
    }
    .left-panel{ display:flex; flex-direction:column; gap:14px; }
    .right-panel{ display:flex; flex-direction:column; gap:12px; }

    h1{ font-size:28px; font-weight:650; letter-spacing:.08em; text-transform:uppercase; color:#f9fafb; }
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      border-radius:999px; border:1px solid rgba(148,163,184,.30);
      padding:5px 10px;
      font-size:10px; letter-spacing:.16em; text-transform:uppercase;
      background:radial-gradient(circle at top,#111827,#020617 70%);
    }

    .btn-row{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; }

    /* ‚úÖ NO GLOW (tu ne veux plus de glow sur les boosters + autour) */
    .btn-primary{
      border-radius:999px; padding:10px 18px; font-size:13px;
      letter-spacing:.14em; text-transform:uppercase;
      border:none; cursor:pointer;
      display:inline-flex; align-items:center; gap:8px; white-space:nowrap;
      background:radial-gradient(circle at top left,#a855f7,#4f46e5);
      color:#f9fafb;
      box-shadow:none; /* avant: glow */
      transition:transform .15s ease-out, opacity .15s ease-out;
    }
    .btn-primary:hover{ transform:translateY(-1px); }
    .btn-primary:disabled{ opacity:.45; cursor:default; }

    .btn-free{ background:radial-gradient(circle at top left,#22c55e,#16a34a); box-shadow:none; }
    .btn-free:hover{ }

    .status-line{
      font-size:13px; color:#e5e7eb;
      background:rgba(15,23,42,.55);
      border-radius:999px; padding:8px 14px;
      border:1px solid rgba(148,163,184,.22);
      display:inline-flex; align-items:center; gap:8px;
    }
    .status-dot{ width:8px; height:8px; border-radius:999px; background:#22c55e; }
    .status-dot.error{ background:#f97373; }
    .status-dot.pending{ background:#facc15; }

    /* Stats */
    .stats{
      margin-top:4px;
      padding:12px;
      border-radius:20px;
      border:1px solid rgba(148,163,184,.20);
      background:rgba(15,23,42,.35);
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:10px;
    }
    @media (max-width: 860px){
      .stats{ grid-template-columns: repeat(2, 1fr); }
    }
    .stat{
      border-radius:16px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(2,6,23,.32);
      padding:10px 10px;
      min-height:66px;
    }
    .stat .k{ font-size:10px; letter-spacing:.16em; text-transform:uppercase; color:#9ca3af; }
    .stat .v{ margin-top:5px; font-size:16px; font-weight:850; color:#f9fafb; }
    .stat .s{ margin-top:2px; font-size:11px; color:#9ca3af; }

    /* Best pull */
    .best-pull{ display:flex; align-items:center; gap:10px; margin-top:5px; }
    .best-thumb{ width:34px; height:34px; border-radius:10px; overflow:hidden; border:1px solid rgba(148,163,184,.20); background:rgba(15,23,42,.45); flex:0 0 auto; }
    .best-thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .best-meta{ display:flex; flex-direction:column; gap:1px; }
    .best-meta .line1{ font-size:12px; font-weight:800; color:#f9fafb; }
    .best-meta .line2{ font-size:11px; color:#9ca3af; }

    /* History */
    .history{
      margin-top:6px;
      padding:12px;
      border-radius:20px;
      border:1px solid rgba(148,163,184,.20);
      background:rgba(2,6,23,.24);
    }
    .history-title{
      font-size:10px; letter-spacing:.18em; text-transform:uppercase;
      color:#9ca3af;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom:10px;
    }
    .history-clear{
      font-size:10px; letter-spacing:.14em; text-transform:uppercase;
      border-radius:999px; padding:6px 10px;
      border:1px solid rgba(148,163,184,.20);
      background:rgba(15,23,42,.40);
      color:#e5e7eb; cursor:pointer;
    }
    .history-clear:hover{ border-color: rgba(165,180,252,.65); }
    .history-list{
      display:flex; flex-direction:column; gap:8px;
      max-height:200px; overflow:auto; padding-right:4px;
    }
    .hist-item{
      display:flex; align-items:center; gap:10px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.14);
      background:rgba(15,23,42,.28);
      padding:8px 10px;
    }
    .hist-dot{ width:10px; height:10px; border-radius:999px; background:#38bdf8; flex:0 0 auto; }
    .hist-dot.ultra{ background:#a855f7; }
    .hist-dot.legendary{ background:#f97316; }
    .hist-dot.hidden{ background:#cbd5e1; }
    .hist-main{ display:flex; flex-direction:column; gap:1px; min-width:0; }
    .hist-line1{
      font-size:12px; font-weight:800; color:#f9fafb;
      display:flex; gap:8px; align-items:center; min-width:0;
    }
    .pill-mini{
      font-size:10px; letter-spacing:.12em; text-transform:uppercase;
      padding:4px 8px; border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.35);
      color:#e5e7eb; flex:0 0 auto;
    }
    .hist-line2{ font-size:11px; color:#9ca3af; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* Right preview booster */
    .card-zone{
      width:100%;
      min-height:386px; /* un peu plus court */
      border-radius:28px;
      border:1px dashed rgba(148,163,184,.30);
      background:radial-gradient(circle at top,#0b1120,#020617 70%);
      display:flex; align-items:center; justify-content:center;
      padding:18px 14px; /* avant: 28px 16px */
      position:relative;
      overflow:hidden;
    }

    /* ‚úÖ NO GLOW on booster cards */
    .card-frame{
      position:relative;
      width:260px; height:380px;
      border-radius:24px;
      padding:2px;
      background:rgba(2,6,23,.15); /* neutre, pas de halo */
      box-shadow:none; /* supprim√© */
      transition: transform .16s ease-out, border-color .16s ease-out;
      min-width:0;
      border:1px solid rgba(148,163,184,.16);
    }
    .card-inner{ width:100%; height:100%; border-radius:22px; overflow:hidden; }

    /* ‚úÖ Grid boosters: 3 en haut, 2 en bas (slot futur) ‚Äî sans scroll horizontal */
    .booster-grid{
      width:100%;
      max-width:100%;
      overflow:hidden;
      display:grid;
      grid-template-columns: repeat(6, minmax(0, 1fr)); /* pr√©cision placement */
      gap:14px;
      align-items:center;
      justify-content:center;
    }

    /* placements (chaque booster span 2 colonnes) */
    .booster-slot{ grid-column: auto / span 2; justify-self:center; }

    .slot-plant{ grid-column: 1 / span 2; }
    .slot-water{ grid-column: 3 / span 2; }
    .slot-fire{  grid-column: 5 / span 2; }

    /* ‚úÖ Mythique sous les 3, entre plante et eau */
    .slot-mythic{ grid-column: 2 / span 2; }

    /* responsive */
    @media (max-width: 980px){
      .booster-grid{
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .booster-slot,
      .slot-plant,.slot-water,.slot-fire,.slot-mythic{
        grid-column:auto / span 1;
      }
    }
    @media (max-width: 640px){
      .booster-grid{ grid-template-columns: 1fr; }
      .booster-slot{ grid-column:auto / span 1; }
    }

    /* ‚úÖ taille r√©duite boosters */
    .card-frame--sm{
      width:100%;
      max-width:200px; /* avant 220 */
      height:300px;    /* avant 330 */
      justify-self:center;
    }

    /* selected state (sans glow) */
    .card-frame[data-selected="true"]{
      transform: translateY(-2px);
      border-color: rgba(165,180,252,.65);
    }

    .card-frame--sm .booster-title{ font-size:15px; }
    .card-frame--sm .booster-subtitle{ font-size:11px; }

    /* ‚úÖ Theme eau (face booster) */
    .booster-closed[data-theme="water"]{
      background: radial-gradient(circle at 20% 0%, #38bdf8 0, #082f49 55%);
    }
    .booster-closed[data-theme="water"]::before{
      background: radial-gradient(circle at top left, rgba(186,230,253,.22), transparent 60%);
    }

    /* ‚úÖ Theme feu (face booster) */
    .booster-closed[data-theme="fire"]{
      background: radial-gradient(circle at 20% 0%, #fb7185 0, #7f1d1d 60%);
    }
    .booster-closed[data-theme="fire"]::before{
      background: radial-gradient(circle at top left, rgba(254,202,202,.20), transparent 60%);
    }

    /* ‚úÖ Theme mythic (violet baby) */
    .booster-closed[data-theme="mythic"]{
      background: radial-gradient(circle at 20% 0%, #c4b5fd 0, #4c1d95 60%);
    }
    .booster-closed[data-theme="mythic"]::before{
      background: radial-gradient(circle at top left, rgba(233,213,255,.25), transparent 60%);
    }

    /* Top bar */
    .top-bar{
      position:absolute;
      top:12px; /* un peu plus haut */
      left:50%;
      transform:translateX(-50%);
      width:100%;
      max-width:1200px;
      display:flex;
      justify-content:flex-end;
      align-items:center;
      padding:0 16px;
      pointer-events:none;
      z-index:50;
    }
    .top-right{ display:flex; align-items:center; gap:12px; pointer-events:auto; }
    .top-link{
      font-size:12px;
      padding:6px 10px;
      height:34px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.45);
      color:#e5e7eb;
      text-decoration:none;
      letter-spacing:.14em;
      text-transform:uppercase;
      background:rgba(15,23,42,.85);
    }
    .top-link:hover{ border-color:#a5b4fc; }
    .top-link.glow{ border-color: rgba(165,180,252,.75); box-shadow:none; } /* ‚úÖ enlever glow */

    /* ‚úÖ Auth buttons */
    #vs-logout-btn.top-link{ cursor:pointer; }
    #vs-logout-btn.top-link:hover{ border-color:#a5b4fc; }

    /* Wallet */
    .wallet-wrap{ position:relative; pointer-events:auto; }
    .wallet-wrap::after{ content:""; position:absolute; left:0; right:0; top:100%; height:14px; }
    .wallet-pill{
      display:inline-flex; align-items:center; gap:10px;
      border-radius:999px;
      height:34px;
      padding:0 12px;
      background:radial-gradient(circle at top,#020617,#020617 70%);
      border:1px solid rgba(148,163,184,.45);
      cursor:default;
    }
    .wallet-label{ font-size:10px; letter-spacing:.18em; text-transform:uppercase; color:#9ca3af; }
    .wallet-main{ font-size:12px; font-weight:800; color:#f9fafb; }
    .wallet-sub{ font-size:10px; color:#9ca3af; }
    .wallet-pop{
      position:absolute;
      right:0; top:44px;
      width:260px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.20);
      background:rgba(2,6,23,.92);
      backdrop-filter:blur(10px);
      padding:10px;
      box-shadow:0 0 24px rgba(0,0,0,.35);
      opacity:0;
      visibility:hidden;
      transform: translateY(-6px);
      pointer-events:none;
      transition: opacity .12s ease, transform .12s ease, visibility .12s ease;
    }
    .wallet-wrap:hover .wallet-pop{ opacity:1; visibility:visible; transform: translateY(0); pointer-events:auto; }
    .wallet-pop h3{ margin:0 0 8px 0; font-size:11px; letter-spacing:.18em; text-transform:uppercase; color:#cbd5e1; }
    .wallet-hint{ margin-top:8px; font-size:11px; color:#9ca3af; line-height:1.35; }
    .btn-mini{
      border-radius:999px;
      padding:8px 10px;
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      border:1px solid rgba(148,163,184,.20);
      cursor:pointer;
      background:rgba(15,23,42,.55);
      color:#e5e7eb;
    }
    .btn-mini:hover{ border-color: rgba(165,180,252,.7); }

    /* Hover preview float */
    .preview-float{
      position:fixed; top:50%; right:28px; transform:translateY(-50%);
      width:320px; aspect-ratio:3/4;
      border-radius:18px;
      overflow:hidden;
      background:rgba(2,6,23,.90);
      border:1px solid rgba(148,163,184,.22);
      box-shadow:0 0 30px rgba(0,0,0,.6);
      opacity:0; pointer-events:none;
      transition: opacity .12s ease;
      z-index:120;
    }
    .preview-float.on{ opacity:1; }
    .preview-float img{ width:100%; height:100%; object-fit:contain; background:#020617; padding:8px; display:block; }
    .preview-float-meta{
      position:absolute; left:10px; right:10px; bottom:10px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .pf-name{
      font-size:11px; letter-spacing:.12em; text-transform:uppercase; font-weight:900;
      color:#e5e7eb; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(148,163,184,.16);
      background:rgba(2,6,23,.45);
      max-width:70%;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .pf-tag{
      font-size:11px; letter-spacing:.14em; text-transform:uppercase;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(148,163,184,.16);
      background:rgba(2,6,23,.45);
      font-weight:900;
    }
    .pf-tag.epic{ color:#38bdf8; }
    .pf-tag.ultra{ color:#a855f7; }
    .pf-tag.legendary{ color:#f97316; }
    .pf-tag.hidden{ display:none; }

    /* (Le reste du CSS arrive en Partie 2) */
  </style>
</head>

<body>

  <!-- Top bar (Settings + Profile) -->
  <div class="top-bar">
    <div class="top-right">
      <a href="settings.html" class="top-link glow" title="Settings">‚öôÔ∏è</a>

      <!-- Wallet pill (auth state) -->
      <div class="wallet-wrap" id="wallet-wrap" style="display:none;">
        <div class="wallet-pill" id="wallet-pill" title="Compte connect√©">
          <div style="display:flex;flex-direction:column;line-height:1.05;">
            <span class="wallet-label">Compte</span>
            <span class="wallet-main" id="wallet-main">‚Äî</span>
          </div>
          <span class="wallet-sub" id="wallet-sub">Connected</span>
        </div>

        <!-- Hover dropdown -->
        <div class="wallet-pop">
          <h3>Profil</h3>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <div style="font-size:12px;color:#e5e7eb;">
              <div style="font-weight:850" id="wallet-email">‚Äî</div>
              <div style="color:#9ca3af" id="wallet-userid">‚Äî</div>
            </div>

            <button class="btn-mini" id="vs-logout-btn" type="button">Logout</button>
            <div class="wallet-hint">
              Tu es connect√© via Supabase Auth. Les openings sont enregistr√©s c√¥t√© DB (RPC <code>vs_open_pack</code>).
            </div>
          </div>
        </div>
      </div>

      <!-- Login link (shown when logged out) -->
      <a href="login.html" class="top-link" id="login-link" style="display:none;">Login</a>
    </div>
  </div>

  <!-- Hover preview -->
  <div class="preview-float" id="preview-float" aria-hidden="true">
    <img id="preview-img" src="" alt="Preview" />
    <div class="preview-float-meta">
      <div class="pf-name" id="preview-name">‚Äî</div>
      <div class="pf-tag hidden" id="preview-tag">‚Äî</div>
    </div>
  </div>

  <main class="page">

    <!-- LIVE PANEL (gauche) -->
    <aside class="live-panel left-panel">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <div style="display:flex;flex-direction:column;gap:6px;">
          <h1>VaultSpin</h1>
          <span class="tag">Secure Pack Opening ¬∑ RPC</span>
        </div>

        <div class="status-line" title="Statut du backend">
          <span class="status-dot" id="status-dot"></span>
          <span id="status-text">Ready</span>
        </div>
      </div>

      <!-- Stats -->
      <section class="stats" aria-label="Stats">
        <div class="stat">
          <div class="k">Packs</div>
          <div class="v" id="stat-packs">0</div>
          <div class="s">ouverts</div>
        </div>
        <div class="stat">
          <div class="k">Valeur</div>
          <div class="v" id="stat-value">0.00</div>
          <div class="s">‚Ç¨ total</div>
        </div>
        <div class="stat">
          <div class="k">Moyenne</div>
          <div class="v" id="stat-avg">0.00</div>
          <div class="s">‚Ç¨ / pack</div>
        </div>
        <div class="stat">
          <div class="k">Points</div>
          <div class="v" id="stat-points-all">0</div>
          <div class="s">ALL (mois)</div>
        </div>
        <div class="stat">
          <div class="k">Points</div>
          <div class="v" id="stat-points-pack">0</div>
          <div class="s" id="stat-points-pack-label">PACK</div>
        </div>
        <div class="stat">
          <div class="k">Best</div>
          <div class="v" id="stat-best">‚Äî</div>
          <div class="s">top pull</div>
        </div>
      </section>

      <!-- Best pull detail -->
      <div class="best-pull" aria-label="Best pull">
        <div class="best-thumb"><img id="best-img" src="images/phyllali_PCA.png" alt="Best card"/></div>
        <div class="best-meta">
          <div class="line1" id="best-name">‚Äî</div>
          <div class="line2" id="best-meta">‚Äî</div>
        </div>
      </div>

      <!-- History -->
      <section class="history" aria-label="Historique">
        <div class="history-title">
          <span>Historique (local)</span>
          <button class="history-clear" id="history-clear" type="button">Clear</button>
        </div>
        <div class="history-list" id="history-list"></div>
      </section>

      <!-- Action buttons -->
      <div class="btn-row">
        <button class="btn-primary" id="btn-open-paid" type="button">Ouvrir ¬∑ Pay√©</button>
        <button class="btn-primary btn-free" id="btn-open-free" type="button">Ouvrir ¬∑ Free (Points)</button>
      </div>

      <div style="font-size:12px;color:#9ca3af;line-height:1.35;">
        <b>Rappel :</b> le tirage est serveur-authoritative (SQL RPC <code>vs_open_pack</code>).
        Le reel/animation est pure UI (<code>BoosterEngine</code>).
      </div>
    </aside>

    <!-- RIGHT PANEL (boosters grid + preview) -->
    <section class="right-panel" style="flex:1;min-width:0;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <div style="display:flex;flex-direction:column;gap:2px;">
          <div style="font-size:12px;letter-spacing:.18em;text-transform:uppercase;color:#9ca3af;">S√©lection booster</div>
          <div style="font-size:16px;font-weight:900;color:#f9fafb;" id="selected-title">Booster Plante</div>
        </div>

        <div class="tag" id="selected-pill">üåø PLANT</div>
      </div>

      <!-- Boosters grid (3 top, mythic under) -->
      <div class="booster-grid" id="booster-grid">

        <!-- PLANT -->
        <div class="booster-slot slot-plant">
          <div class="card-frame card-frame--sm" data-pack="PLANT" data-selected="true">
            <div class="card-inner">
              <div class="booster-closed" data-theme="plant" style="height:100%;display:flex;flex-direction:column;justify-content:space-between;padding:18px;">
                <div>
                  <div style="display:flex;align-items:center;justify-content:space-between;">
                    <div class="booster-title" style="font-weight:950;font-size:16px;">Booster Plante</div>
                    <div style="font-size:20px;">üåø</div>
                  </div>
                  <div class="booster-subtitle" style="margin-top:6px;opacity:.9;font-size:12px;color:#e5e7eb;">
                    1/20 Epic ¬∑ 1/50 Ultra ¬∑ 1/5000 Legendary
                  </div>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:flex-end;">
                  <div style="font-size:11px;letter-spacing:.14em;text-transform:uppercase;color:#e5e7eb;opacity:.85;">24.99 ‚Ç¨</div>
                  <div style="font-size:10px;letter-spacing:.18em;text-transform:uppercase;color:#cbd5e1;opacity:.75;">Select</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- WATER -->
        <div class="booster-slot slot-water">
          <div class="card-frame card-frame--sm" data-pack="WATER" data-selected="false">
            <div class="card-inner">
              <div class="booster-closed" data-theme="water" style="height:100%;display:flex;flex-direction:column;justify-content:space-between;padding:18px;">
                <div>
                  <div style="display:flex;align-items:center;justify-content:space-between;">
                    <div class="booster-title" style="font-weight:950;font-size:16px;">Booster Eau</div>
                    <div style="font-size:20px;">üíß</div>
                  </div>
                  <div class="booster-subtitle" style="margin-top:6px;opacity:.9;font-size:12px;color:#e5e7eb;">
                    1/20 Epic ¬∑ 1/50 Ultra ¬∑ 1/5000 Legendary
                  </div>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:flex-end;">
                  <div style="font-size:11px;letter-spacing:.14em;text-transform:uppercase;color:#e5e7eb;opacity:.85;">24.99 ‚Ç¨</div>
                  <div style="font-size:10px;letter-spacing:.18em;text-transform:uppercase;color:#cbd5e1;opacity:.75;">Select</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- FIRE -->
        <div class="booster-slot slot-fire">
          <div class="card-frame card-frame--sm" data-pack="FIRE" data-selected="false">
            <div class="card-inner">
              <div class="booster-closed" data-theme="fire" style="height:100%;display:flex;flex-direction:column;justify-content:space-between;padding:18px;">
                <div>
                  <div style="display:flex;align-items:center;justify-content:space-between;">
                    <div class="booster-title" style="font-weight:950;font-size:16px;">Booster Feu</div>
                    <div style="font-size:20px;">üî•</div>
                  </div>
                  <div class="booster-subtitle" style="margin-top:6px;opacity:.9;font-size:12px;color:#e5e7eb;">
                    1/20 Epic ¬∑ 1/50 Ultra ¬∑ 1/5000 Legendary
                  </div>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:flex-end;">
                  <div style="font-size:11px;letter-spacing:.14em;text-transform:uppercase;color:#e5e7eb;opacity:.85;">24.99 ‚Ç¨</div>
                  <div style="font-size:10px;letter-spacing:.18em;text-transform:uppercase;color:#cbd5e1;opacity:.75;">Select</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- MYTHIC (UI-only) -->
        <div class="booster-slot slot-mythic">
          <div class="card-frame card-frame--sm" data-pack="MYTHIC" data-selected="false">
            <div class="card-inner">
              <div class="booster-closed" data-theme="mythic" style="height:100%;display:flex;flex-direction:column;justify-content:space-between;padding:18px;">
                <div>
                  <div style="display:flex;align-items:center;justify-content:space-between;">
                    <div class="booster-title" style="font-weight:950;font-size:16px;">Booster Mythique</div>
                    <div style="font-size:20px;">üü£</div>
                  </div>
                  <div class="booster-subtitle" style="margin-top:6px;opacity:.9;font-size:12px;color:#e5e7eb;">
                    (UI only) ‚Äî coming soon
                  </div>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:flex-end;">
                  <div style="font-size:11px;letter-spacing:.14em;text-transform:uppercase;color:#e5e7eb;opacity:.85;">‚Äî</div>
                  <div style="font-size:10px;letter-spacing:.18em;text-transform:uppercase;color:#cbd5e1;opacity:.75;">Locked</div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Main opening area (reel/result overlay is handled by BoosterEngine, HTML structure comes next part) -->
      <div class="card-zone" style="margin-top:8px;">
        <div style="display:flex;flex-direction:column;align-items:center;gap:10px;text-align:center;">
          <div style="font-size:12px;letter-spacing:.18em;text-transform:uppercase;color:#9ca3af;">
            Zone d‚Äôouverture
          </div>
          <div style="font-size:15px;font-weight:900;color:#f9fafb;">
            Clique ‚ÄúOuvrir‚Äù √† gauche pour lancer l‚Äôanimation üé∞
          </div>
          <div style="font-size:12px;color:#9ca3af;max-width:520px;line-height:1.45;">
            Le booster s√©lectionn√© d√©finit le <code>pack_key</code> envoy√© au backend.
            Le r√©sultat est √©crit dans <code>user_cards</code> via <code>vs_open_pack</code>.
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- OVERLAY OPENING / RESULT -->
  <div class="overlay" id="open-overlay" aria-hidden="true">

    <div class="overlay-card">

      <!-- header -->
      <div class="overlay-head">
        <div class="overlay-title">
          <span class="overlay-pill" id="overlay-pill">OPEN</span>
          <span id="overlay-title">Opening‚Ä¶</span>
        </div>

        <div class="overlay-actions">
          <button class="btn-mini" id="open-skip" type="button" title="Skip animation">Skip</button>
          <button class="btn-mini" id="open-close" type="button" title="Close" style="display:none;">Close</button>
        </div>
      </div>

      <!-- small hint -->
      <div class="overlay-hint" id="open-hint">Opening‚Ä¶</div>

      <!-- =================== REEL SECTION =================== -->
      <section class="open-section" id="reel-section">
        <div class="reel-shell">
          <div class="reel-viewport" id="reel-viewport" aria-label="Reel viewport">
            <div class="reel-track" id="reel-track"></div>
          </div>

          <!-- cursor line -->
          <div class="reel-cursor" aria-hidden="true"></div>
        </div>

        <div class="reel-sub">
          <div class="tag">UI reel</div>
          <div class="reel-subtext">
            Le reel est une animation visuelle. Le gagnant vient du serveur (RPC).
          </div>
        </div>
      </section>

      <!-- =================== RESULT SECTION =================== -->
      <section class="open-section hidden" id="result-section">
        <div class="result-wrap">

          <div class="result-card">
            <div class="result-media">
              <img id="result-img" src="images/phyllali_PCA.png" alt="Result"/>
              <span class="result-pill" id="result-pill" style="display:none;">EPIC</span>
            </div>

            <div class="result-meta">
              <div class="result-name" id="result-name">‚Äî</div>
              <pre class="result-desc" id="result-desc">‚Äî</pre>

              <div class="result-actions">
                <button class="btn-primary" id="result-sell" type="button" disabled>Revendre</button>
                <div class="result-profit" id="result-profit">Valeur : 0.00 ‚Ç¨</div>
              </div>
            </div>
          </div>

          <div class="result-foot">
            <div class="result-note">
              ‚úÖ L‚Äôouverture est enregistr√©e dans <code>public.user_cards</code>.
              <br/>
              üíé La raret√© est choisie c√¥t√© DB, puis une carte al√©atoire dans <code>pack_cards</code>.
            </div>
          </div>

        </div>
      </section>

    </div>
  </div>

  <!-- AUDIO SFX -->
  <audio id="sfx-booster" preload="auto" src="audio/booster.mp3"></audio>
  <audio id="sfx-reveal" preload="auto" src="audio/reveal.mp3"></audio>
  <audio id="sfx-legendary" preload="auto" src="audio/legendary.mp3"></audio>
  <audio id="sfx-tick" preload="auto" src="audio/tick.mp3"></audio>

  <!-- TOP BAR -->
  <div class="top-bar">
    <div class="top-right">
      <a class="top-link glow" href="me.html">Profil</a>
      <a class="top-link glow" href="collection.html">Ma collection</a>
      <a class="top-link" href="leaderboard.html">Leaderboard</a>

      <!-- AUTH -->
      <span id="vs-user-email" class="top-link" style="display:none; max-width:220px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">‚Äî</span>
      <a id="vs-login-btn" class="top-link glow" href="login.html">Connexion</a>
      <button id="vs-logout-btn" class="top-link" style="display:none;">D√©connexion</button>

      <!-- Wallet demo -->
      <div class="wallet-wrap">
        <div class="wallet-pill" title="Wallet local (d√©mo)">
          <span class="wallet-label">Wallet</span>
          <span class="wallet-main" id="wallet-eur">0,00 ‚Ç¨</span>
          <span class="wallet-sub" id="wallet-eth">‚âà 0,0000 ETH</span>
        </div>
        <div class="wallet-pop">
          <h3>Wallet (d√©mo)</h3>
          <div class="wallet-hint" id="wallet-hint">Balance : <b>0,00 ‚Ç¨</b></div>
          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn-mini" id="wallet-topup-100" type="button">+100‚Ç¨</button>
            <button class="btn-mini" id="reset-data" type="button">Reset data</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- PAGE -->
  <div class="page">

    <!-- LIVE PANEL (gauche) -->
    <aside class="live-panel">
      <div class="live-head">
        <div class="live-title">Derniers loots</div>
        <div class="live-sub">Global ¬∑ temps r√©el</div>
      </div>

      <div class="live-list" id="vs-live-list">
        <div class="live-empty" id="vs-live-empty">Chargement‚Ä¶</div>
      </div>
    </aside>

    <!-- LEFT PANEL -->
    <section class="left-panel">
      <div class="tag" style="align-self:flex-start;">VAULTSPIN ¬∑ D√âMO</div>
      <div><h1>Open your VaultSpin Pack</h1></div>

      <div class="btn-row">
        <button id="open-pack-btn" class="btn-primary" type="button">Open VaultSpin Pack ‚Äî 24,99 ‚Ç¨</button>
        <button id="free-pack-btn" class="btn-primary btn-free" type="button" disabled>Booster gratuit ‚Äî 2500 pts</button>
      </div>

      <div id="status-line" class="status-line">
        <span class="status-dot" id="status-dot"></span>
        <span id="status-text">Pr√™t. Ouvre un pack.</span>
      </div>

      <!-- stats -->
      <div class="stats">
        <div class="stat">
          <div class="k">Packs opened</div>
          <div class="v" id="stat-opened">0</div>
          <div class="s">Total</div>
        </div>
        <div class="stat">
          <div class="k">Spent</div>
          <div class="v" id="stat-spent">0‚Ç¨</div>
          <div class="s">Packs</div>
        </div>
        <div class="stat">
          <div class="k">Points</div>
          <div class="v" id="stat-points">0</div>
          <div class="s">+25 / pack</div>
        </div>
        <div class="stat">
          <div class="k">Vault value</div>
          <div class="v" id="stat-vault">0‚Ç¨</div>
          <div class="s">Estimation</div>
        </div>
        <div class="stat">
          <div class="k">Last pull</div>
          <div class="v" id="stat-last">‚Äî</div>
          <div class="s" id="stat-last-sub">‚Äî</div>
        </div>
        <div class="stat">
          <div class="k">Best pull</div>
          <div class="best-pull">
            <div class="best-thumb">
              <img id="stat-best-img" src="images/germignon.png" alt="Best" loading="lazy" decoding="async" />
            </div>
            <div class="best-meta">
              <div class="line1" id="stat-best-line1">‚Äî</div>
              <div class="line2" id="stat-best-line2">‚Äî</div>
            </div>
          </div>
        </div>
      </div>

      <!-- history -->
      <div class="history">
        <div class="history-title">
          <span>Pack history</span>
          <button class="history-clear" id="clear-history" type="button">Clear</button>
        </div>
        <div class="history-list" id="history-list"></div>
      </div>
    </section>

    <!-- RIGHT PANEL -->
    <section class="right-panel">

      <!-- BOOSTERS AREA -->
      <div class="card-zone">

        <!-- ‚úÖ 3 en haut, 2 en bas ‚Äî pas de glow externe, pas de scroll horizontal -->
        <div class="booster-grid-5" id="booster-grid-5">

          <!-- PLANT -->
          <div class="card-frame card-frame--sm" data-booster="plant" data-selected="true">
            <div class="card-inner">
              <div class="booster-closed booster-mode-idle" data-theme="plant">
                <div class="booster-label">
                  <div class="booster-leaf-icon">üåø</div>
                  <div class="booster-chip">VaultSpin Pack</div>
                  <div class="booster-title">Booster Plante</div>
                  <div class="booster-subtitle">1 carte √† r√©v√©ler</div>
                </div>
              </div>
            </div>
          </div>

          <!-- WATER -->
          <div class="card-frame card-frame--sm" data-booster="water" data-selected="false">
            <div class="card-inner">
              <div class="booster-closed booster-mode-idle" data-theme="water">
                <div class="booster-label">
                  <div class="booster-leaf-icon">üíß</div>
                  <div class="booster-chip">VaultSpin Pack</div>
                  <div class="booster-title">Booster Eau</div>
                  <div class="booster-subtitle">1 carte √† r√©v√©ler</div>
                </div>
              </div>
            </div>
          </div>

          <!-- FIRE -->
          <div class="card-frame card-frame--sm" data-booster="fire" data-selected="false">
            <div class="card-inner">
              <div class="booster-closed booster-mode-idle" data-theme="fire">
                <div class="booster-label">
                  <div class="booster-leaf-icon">üî•</div>
                  <div class="booster-chip">VaultSpin Pack</div>
                  <div class="booster-title">Booster Feu</div>
                  <div class="booster-subtitle">1 carte √† r√©v√©ler</div>
                </div>
              </div>
            </div>
          </div>

          <!-- ‚úÖ MYTHIQUE (baby purple) -->
          <div class="card-frame card-frame--sm" data-booster="mythic" data-selected="false">
            <div class="card-inner">
              <div class="booster-closed booster-mode-idle" data-theme="mythic">
                <div class="booster-label">
                  <div class="booster-leaf-icon">‚ú®</div>
                  <div class="booster-chip">VaultSpin Pack</div>
                  <div class="booster-title">Booster Mythique</div>
                  <div class="booster-subtitle">1 carte √† r√©v√©ler</div>
                </div>
              </div>
            </div>
          </div>

          <!-- ‚úÖ slot 5 (futur) -->
          <div class="card-frame card-frame--sm card-frame--ghost" aria-hidden="true">
            <div class="card-inner">
              <div class="booster-closed booster-mode-idle" data-theme="ghost">
                <div class="booster-label">
                  <div class="booster-leaf-icon">üîí</div>
                  <div class="booster-chip">Soon</div>
                  <div class="booster-title">Bient√¥t</div>
                  <div class="booster-subtitle">1 carte √† r√©v√©ler</div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- DROP TABLE -->
      <div class="drop-table">
        <div class="drop-title" id="drop-title">Cartes potentiellement obtenables</div>

        <!-- PLANT GRID -->
        <div class="drop-grid" id="drop-grid-plant">
          <!-- (inchang√© : tes items d√©j√† pr√©sents) -->
        </div>

        <!-- WATER GRID -->
        <div class="drop-grid" id="drop-grid-water" style="display:none;">
          <!-- (inchang√© : tes items d√©j√† pr√©sents) -->
        </div>

        <!-- FIRE GRID -->
        <div class="drop-grid" id="drop-grid-fire" style="display:none;">
          <!-- (inchang√© : tes items d√©j√† pr√©sents) -->
        </div>

        <!-- ‚úÖ MYTHIQUE GRID -->
        <div class="drop-grid" id="drop-grid-mythic" style="display:none;">
          <!-- EPIC / ULTRA / LEGENDARY / HIDDEN seront remplis √† la PARTIE 5 (liste compl√®te) -->
        </div>
      </div>

      <!-- ‚úÖ L√©gende moins ‚Äúsynth√©tique‚Äù (notamment pour FEU) -->
      <div class="drop-legend" id="drop-legend">
        <span class="leg-item"><span class="leg-dot epic"></span> EPIC ‚Äî cartes standard (valeur < 121‚Ç¨)</span>
        <span class="leg-item"><span class="leg-dot ultra"></span> ULTRA ‚Äî grosses cartes (121‚Ç¨ √† 300‚Ç¨)</span>
        <span class="leg-item"><span class="leg-dot legendary"></span> LEGENDARY ‚Äî top pull (tr√®s rare)</span>
        <span class="leg-item"><span class="leg-dot hidden"></span> HIDDEN ‚Äî pull discret (pas de badge)</span>
      </div>

    </section>
  </div>

<!-- Sounds -->
<audio id="sfx-booster" src="sounds/booster_open.mp3" preload="auto"></audio>
<audio id="sfx-reveal" src="sounds/card_reveal.mp3" preload="auto"></audio>
<audio id="sfx-legendary" src="sounds/legendary_fx.mp3" preload="auto"></audio>
<audio id="sfx-tick" src="sounds/clic_clic.mp3" preload="auto"></audio>

<!-- ‚úÖ APP (AUTH + POINTS + OPEN PACK RPC + UI WIRING) -->
<script type="module">
  import { supabase } from "./js/supabaseClient.js";
  import { BOOSTERS, boosterByKey, buildCardIndex } from "./js/boosters.js";
  import { BoosterEngine } from "./js/boosterEngine.js";

  /********************
   * Constants (align SQL)
   ********************/
  const POINTS_PER_PACK = 25;
  const FREE_PACK_COST_PTS = 2500;

  /********************
   * DOM refs
   ********************/
  const loginBtn  = document.getElementById("vs-login-btn");
  const logoutBtn = document.getElementById("vs-logout-btn");
  const emailEl   = document.getElementById("vs-user-email");

  const paidBtn = document.getElementById("open-pack-btn");
  const freeBtn = document.getElementById("free-pack-btn");

  const dropTitle = document.getElementById("drop-title");

  // Booster cards (3 tiles)
  const boosterTiles = Array.from(document.querySelectorAll(".card-frame[data-booster]"));

  /********************
   * Local-only wallet (d√©mo)
   ********************/
  const VS_WALLET_SPENT_EUR_KEY   = "vaultspin_wallet_spent_eur_v1";
  const VS_WALLET_BALANCE_EUR_KEY = "vaultspin_wallet_balance_eur_v1";

  const PACK_PRICE_EUR = 24.99;
  const EUR_TO_ETH = 1 / 3500;

  function getWalletSpent(){
    const raw = localStorage.getItem(VS_WALLET_SPENT_EUR_KEY);
    const n = raw ? Number(raw) : 0;
    return Number.isFinite(n) ? Math.max(0, n) : 0;
  }
  function setWalletSpent(v){
    localStorage.setItem(VS_WALLET_SPENT_EUR_KEY, String(Math.max(0, Number(v) || 0)));
  }
  function getWalletBalance(){
    const raw = localStorage.getItem(VS_WALLET_BALANCE_EUR_KEY);
    const n = raw ? Number(raw) : 0;
    return Number.isFinite(n) ? Math.max(0, n) : 0;
  }
  function setWalletBalance(v){
    localStorage.setItem(VS_WALLET_BALANCE_EUR_KEY, String(Math.max(0, Number(v) || 0)));
  }
  function fmtEur(n){
    return (Number(n) || 0).toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " ‚Ç¨";
  }
  function fmtEthFromEur(eur){
    const eth = (Number(eur)||0) * EUR_TO_ETH;
    return "‚âà " + eth.toLocaleString("fr-FR", { minimumFractionDigits: 4, maximumFractionDigits: 4 }) + " ETH";
  }
  function renderWallet(){
    const bal = getWalletBalance();
    document.getElementById("wallet-eur").textContent = fmtEur(bal);
    document.getElementById("wallet-eth").textContent = fmtEthFromEur(bal);
    document.getElementById("wallet-hint").innerHTML =
      `Balance : <b>${fmtEur(bal)}</b><br/>Spent : <b>${fmtEur(getWalletSpent())}</b><br/>Pack : <b>${fmtEur(PACK_PRICE_EUR)}</b>`;
  }
  function creditWallet(amount){
    setWalletBalance(getWalletBalance() + (Number(amount) || 0));
    renderWallet();
  }
  function debitPack(){
    const bal = getWalletBalance();
    if (bal < PACK_PRICE_EUR){
      window.__vsSetStatus?.("Fonds insuffisants. Ajoute +100‚Ç¨ dans le wallet.", "error");
      return false;
    }
    setWalletBalance(bal - PACK_PRICE_EUR);
    setWalletSpent(getWalletSpent() + PACK_PRICE_EUR);
    renderWallet();
    return true;
  }

  /********************
   * Status helper (reuse existing HTML)
   ********************/
  function setStatus(text, mode="ok"){
    const t = document.getElementById("status-text");
    const d = document.getElementById("status-dot");
    if (!t || !d) return;
    t.textContent = text;
    d.classList.remove("error","pending");
    if (mode==="error") d.classList.add("error");
    if (mode==="pending") d.classList.add("pending");
  }
  // expose for wallet helpers
  window.__vsSetStatus = setStatus;

  /********************
   * Auth UI
   ********************/
  function setAuthed(label){
    if (emailEl){
      emailEl.style.display = "inline-flex";
      emailEl.textContent = label || "Connect√©";
    }
    if (loginBtn) loginBtn.style.display = "none";
    if (logoutBtn) logoutBtn.style.display = "inline-flex";
  }
  function setNotAuthed(){
    if (emailEl){
      emailEl.style.display = "none";
      emailEl.textContent = "‚Äî";
    }
    if (loginBtn) loginBtn.style.display = "inline-flex";
    if (logoutBtn) logoutBtn.style.display = "none";
  }

  async function setAuthedFromSession(session){
    const { data, error } = await supabase
      .from("profiles")
      .select("username, display_name")
      .eq("id", session.user.id)
      .maybeSingle();

    const label = (!error && data)
      ? (data.display_name || data.username || session.user.email || "Connect√©")
      : (session.user.email || "Connect√©");

    setAuthed(label);
  }

  async function requireAuthOrRedirect(){
    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user){
      window.location.href = "login.html";
      return null;
    }
    // enforce username completion
    try{
      const { data } = await supabase
        .from("profiles")
        .select("username")
        .eq("id", session.user.id)
        .maybeSingle();
      if (!data?.username){
        window.location.href = "profile.html?next=./index.html";
        return null;
      }
    }catch(_){}
    return session;
  }

  /********************
   * Points RPC (server authoritative)
   ********************/
  async function vsGetPoints(){
    const { data, error } = await supabase.rpc("vs_get_points", {});
    if (error) throw error;
    return Number(data || 0);
  }
  async function vsSpendPoints(cost){
    const { data, error } = await supabase.rpc("vs_spend_points", { p_cost: cost });
    if (error) throw error;
    const row = Array.isArray(data) ? data[0] : data;
    return { ok: !!row?.ok, points: Number(row?.points || 0) };
  }

  async function syncPointsToLocalStorage(){
    try{
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user) return;
      const pts = await vsGetPoints();
      localStorage.setItem("vaultspin_points_v1", String(pts));
      window.renderPoints?.(); // (garde ta fonction existante si tu l‚Äôas)
    }catch(e){
      console.warn("syncPointsToLocalStorage failed:", e);
    }
  }

  /********************
   * Open Pack RPC (server authoritative)
   ********************/
  async function openPackRpc(packKey, mode="paid"){
    const { data, error } = await supabase.rpc("vs_open_pack", {
      p_pack_key: String(packKey || "").toUpperCase(),
      p_mode: String(mode || "paid").toLowerCase()
    });
    if (error) throw error;
    // data = jsonb from SQL
    return data;
  }

  /********************
   * BoosterEngine wiring
   ********************/
  const cardIndex = buildCardIndex(); // Map(card_id -> {id,name,img,price})
  let selectedKey = "PLANT";

  const engine = new BoosterEngine({
    booster: BOOSTERS.PLANT,
    cardIndex,
    hooks: {
      openPackRpc: async (packKey, mode) => {
        // paid -> wallet local debit
        if (mode === "paid"){
          if (!debitPack()) throw new Error("Fonds insuffisants.");
        } else {
          // free -> server spend points (ALL) inside vs_open_pack
          // (engine openPack appelle RPC directement)
        }

        // ‚úÖ auth gate
        const s = await requireAuthOrRedirect();
        if (!s) throw new Error("Not authenticated");

        // ‚úÖ server truth
        const res = await openPackRpc(packKey, mode);

        // points local sync after open
        try{
          localStorage.setItem("vaultspin_points_v1", String(res?.points_all ?? 0));
          window.renderPoints?.();
        }catch(_){}

        return res;
      },
      onCollectionChanged: (_entry) => {
        // si tu veux refresh stats/history ici, tu peux.
        // (les √©l√©ments stats/history restent g√©r√©s dans tes scripts UI existants si tu les gardes)
      }
    }
  });

  /********************
   * Booster selection UI
   ********************/
  function setSelectedBoosterUI(packKey){
    const k = String(packKey || "").toUpperCase();
    selectedKey = (k === "WATER" || k === "FIRE") ? k : "PLANT";

    // tile highlight
    boosterTiles.forEach((el) => {
      const b = String(el.getAttribute("data-booster") || "").toLowerCase(); // "plant"|"water"|"fire"
      const normalized = b.toUpperCase(); // "PLANT"|"WATER"|"FIRE"
      el.setAttribute("data-selected", String(normalized === selectedKey));
    });

    // update engine booster
    const booster = boosterByKey(selectedKey);
    if (booster) engine.setBooster(booster);

    // update main button label
    if (paidBtn && booster){
      paidBtn.textContent = `Open ${booster.uiName} ‚Äî ${booster.packPriceEur.toFixed(2).replace(".", ",")} ‚Ç¨`;
    }

    // drop title
    if (dropTitle && booster){
      dropTitle.textContent = `Cartes potentiellement obtenables ¬∑ ${booster.uiName}`;
    }

    setStatus(`S√©lectionn√© : ${booster?.uiName || "Booster"}`, "ok");
  }

  /********************
   * Buttons / overlay bindings
   ********************/
  function bindUI(){
    engine.initAudio();

    // overlay buttons already in HTML
    document.getElementById("open-skip")?.addEventListener("click", () => engine.skipSpinNow());
    document.getElementById("open-close")?.addEventListener("click", () => {
      if (engine.spinning) return;
      engine.closeOverlay();
      engine.uiState = "idle";
      setStatus("Pr√™t. Ouvre un pack.", "ok");
    });

    document.getElementById("result-open-another")?.addEventListener("click", async () => {
      // simple: reopen paid
      await engine.openPack({ mode: "paid" });
    });

    document.getElementById("result-sell")?.addEventListener("click", () => {
      // MVP: on cr√©dite wallet local, sans supprimer c√¥t√© DB (car DB est v√©rit√© d‚Äôopen)
      // si tu veux ‚Äúsell‚Äù r√©el, il faut une table marketplace/transactions.
      const priceText = document.getElementById("result-profit")?.textContent || "";
      // price is already in engine.currentOpen.estimated_value_eur
      const eur = Number(engine?.currentOpen?.estimated_value_eur || 0);
      creditWallet(eur);
      setStatus(`Revendu ‚úÖ +${fmtEur(eur)} (wallet d√©mo)`, "ok");
      const btn = document.getElementById("result-sell");
      if (btn){ btn.disabled = true; }
    });

    // main open buttons
    paidBtn?.addEventListener("click", async () => {
      await engine.openPack({ mode: "paid" });
    });

    freeBtn?.addEventListener("click", async () => {
      // auth gate (engine fera aussi)
      const s = await requireAuthOrRedirect();
      if (!s) return;

      // optionnel: pre-check points UI (server is truth anyway)
      await engine.openPack({ mode: "free" });
    });

    // booster tile click
    boosterTiles.forEach((el) => {
      el.style.cursor = "pointer";
      el.addEventListener("click", () => {
        const raw = String(el.getAttribute("data-booster") || "plant").toUpperCase(); // PLANT/WATER/FIRE
        setSelectedBoosterUI(raw);
      });
    });

    // wallet buttons
    document.getElementById("wallet-topup-100")?.addEventListener("click", () => {
      creditWallet(100);
      setStatus("+100‚Ç¨ ajout√©s ‚úÖ", "ok");
    });
    document.getElementById("reset-data")?.addEventListener("click", () => {
      localStorage.removeItem(VS_WALLET_SPENT_EUR_KEY);
      localStorage.removeItem(VS_WALLET_BALANCE_EUR_KEY);
      setStatus("Reset wallet ‚úÖ", "ok");
      renderWallet();
    });

    // Escape close
    document.addEventListener("keydown", (e) => {
      if (e.key !== "Escape") return;
      const overlay = document.getElementById("open-overlay");
      if (overlay?.classList.contains("on") && !engine.spinning){
        engine.closeOverlay();
        engine.uiState = "idle";
        setStatus("Pr√™t. Ouvre un pack.", "ok");
      }
    });
  }

  /********************
   * Init
   ********************/
  document.addEventListener("DOMContentLoaded", async () => {
    renderWallet();
    bindUI();

    // auth state
    const { data: { session } } = await supabase.auth.getSession();
    if (session?.user){
      await setAuthedFromSession(session);
      await syncPointsToLocalStorage();
    } else {
      setNotAuthed();
    }

    supabase.auth.onAuthStateChange(async (_event, newSession) => {
      if (newSession?.user){
        await setAuthedFromSession(newSession);
        await syncPointsToLocalStorage();
      } else {
        setNotAuthed();
      }
    });

    logoutBtn?.addEventListener("click", async () => {
      await supabase.auth.signOut();
    });

    // default booster
    setSelectedBoosterUI("PLANT");

    // disable free btn until points known (renderPoints doit le g√©rer)
    try { window.renderPoints?.(); } catch(_){}
  });
</script>

<script type="module">
  import { supabase } from "./js/supabaseClient.js";
  import { BOOSTERS, boosterByKey, buildCardIndex } from "./js/boosters.js";

  const cardIndex = buildCardIndex();

  // ---------- DOM refs ----------
  const liveList = document.getElementById("live-list");        // UL / DIV dans ta section LIVE
  const myList   = document.getElementById("my-loots-list");    // optionnel si tu as une section ‚ÄúMes loots‚Äù
  const freeBtn  = document.getElementById("free-pack-btn");
  const ptsEl    = document.getElementById("points-value");     // ex: <span id="points-value"></span>
  const ptsHint  = document.getElementById("points-hint");      // ex: <div id="points-hint"></div>

  // ---------- Config ----------
  const LIVE_LIMIT = 18;
  const MY_LIMIT   = 30;
  const FREE_COST  = 2500;

  function fmtPts(n){ return (Number(n)||0).toLocaleString("fr-FR"); }
  function fmtTs(ts){
    try{
      return new Date(ts).toLocaleString("fr-FR", { day:"2-digit", month:"2-digit", hour:"2-digit", minute:"2-digit" });
    }catch{ return ""; }
  }
  function esc(s){
    return String(s||"").replace(/[&<>"']/g, (c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  // ---------- Points UI ----------
  window.renderPoints = async function renderPoints(){
    let pts = 0;
    try{
      // on lit en local (mis √† jour par PARTIE 5 apr√®s RPC)
      pts = Number(localStorage.getItem("vaultspin_points_v1") || "0") || 0;
    }catch(_){}

    if (ptsEl) ptsEl.textContent = fmtPts(pts);

    if (ptsHint){
      ptsHint.textContent = `Pack gratuit : ${fmtPts(FREE_COST)} pts ¬∑ Tu as ${fmtPts(pts)} pts`;
    }

    if (freeBtn){
      freeBtn.disabled = pts < FREE_COST;
      freeBtn.title = freeBtn.disabled ? `Il faut ${fmtPts(FREE_COST)} pts` : "Ouvrir un pack gratuit (points)";
    }
  };

  // ---------- Card resolve (DB truth -> UI meta) ----------
  function resolveCard(row){
    // row contient card_id + image_url + card_name + estimated_value_eur (depuis SQL)
    const meta = cardIndex.get(row.card_id) || null;
    return {
      pack_key: row.pack_key,
      rarity_key: row.rarity_key,
      name: row.card_name || meta?.name || row.card_id,
      img: row.image_url || meta?.img || "",
      value: Number(row.estimated_value_eur || meta?.price || 0),
      opened_at: row.opened_at
    };
  }

  function rarityLabel(r){
    const rk = String(r||"").toUpperCase();
    if (!rk || rk === "HIDDEN") return "";
    return rk;
  }

  function pillClass(r){
    const rk = String(r||"").toUpperCase();
    if (!rk || rk === "HIDDEN") return "hidden";
    return rk.toLowerCase(); // epic/ultra/legendary
  }

  function boosterUiName(pack_key){
    const b = boosterByKey(pack_key);
    return b?.uiName || String(pack_key||"");
  }

  // ---------- Render helpers ----------
  function renderLootItem(item, { showBooster=true } = {}){
    const rk = rarityLabel(item.rarity_key);
    const pill = rk ? `<span class="live-pill ${esc(pillClass(item.rarity_key))}">${esc(rk)}</span>` : "";
    const booster = showBooster ? `<div class="live-pack">${esc(boosterUiName(item.pack_key))}</div>` : "";

    return `
      <div class="live-item">
        <div class="live-thumb">
          <img src="${esc(item.img)}" alt="${esc(item.name)}" loading="lazy" decoding="async" />
        </div>
        <div class="live-meta">
          <div class="live-top">
            <div class="live-name">${esc(item.name)}</div>
            ${pill}
          </div>
          <div class="live-sub">
            ${booster}
            <div class="live-ts">${esc(fmtTs(item.opened_at))}</div>
          </div>
        </div>
      </div>
    `;
  }

  function mountList(el, html){
    if (!el) return;
    el.innerHTML = html || "";
  }

  // ---------- Queries ----------
  async function fetchLive(){
    // feed public: derni√®res cartes ouvertes (tous users publics)
    const { data, error } = await supabase
      .from("user_cards")
      .select("pack_key, rarity_key, card_id:card_type_index, card_name, image_url, estimated_value_eur, opened_at, user_id")
      .order("opened_at", { ascending: false })
      .limit(LIVE_LIMIT);

    if (error) throw error;

    // NB: on n‚Äôa pas card_id string dans user_cards (on stocke card_type_index)
    // üëâ mais le RPC renvoie card_id ; en DB on a card_type_index.
    // Donc ici on reconstruit via pack_cards pour obtenir card_id string si tu veux matcher le client.
    // Pour MVP: on s‚Äôappuie sur card_name/image_url d√©j√† stock√©s par SQL (ok).
    return (data || []).map(resolveCard);
  }

  async function fetchMy(){
    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user) return [];

    const { data, error } = await supabase
      .from("user_cards")
      .select("pack_key, rarity_key, card_name, image_url, estimated_value_eur, opened_at")
      .eq("user_id", session.user.id)
      .order("opened_at", { ascending: false })
      .limit(MY_LIMIT);

    if (error) throw error;
    return (data || []).map(resolveCard);
  }

  // ---------- Live refresh loop ----------
  let liveTimer = null;

  async function refreshLive(){
    try{
      const items = await fetchLive();
      const html = items.map((it)=>renderLootItem(it, { showBooster:true })).join("");
      mountList(liveList, html);
    }catch(e){
      console.warn("refreshLive failed:", e);
    }
  }

  async function refreshMy(){
    if (!myList) return;
    try{
      const items = await fetchMy();
      const html = items.map((it)=>renderLootItem(it, { showBooster:false })).join("");
      mountList(myList, html || `<div class="empty">Aucun loot pour l'instant.</div>`);
    }catch(e){
      console.warn("refreshMy failed:", e);
    }
  }

  function startLiveLoop(){
    if (liveTimer) clearInterval(liveTimer);
    liveTimer = setInterval(refreshLive, 7000);
  }

  // ---------- Init ----------
  document.addEventListener("DOMContentLoaded", async () => {
    // points UI
    try{ await window.renderPoints?.(); }catch(_){}

    // first load
    await refreshLive();
    await refreshMy();
    startLiveLoop();

    // auth change => refresh ‚Äúmy loots‚Äù + points
    supabase.auth.onAuthStateChange(async () => {
      await refreshMy();
      try{ await window.renderPoints?.(); }catch(_){}
    });
  });
</script>

</body>
</html>
