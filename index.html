<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>VaultSpin ‚Äì Booster Plante (V11.5 ‚Äì UI Polish + Close/Skip Logic + Non-fixed Top)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="animations.css" />

    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }

      /* ‚úÖ Top bar must NOT float when scrolling */
      body{
        min-height:100vh;
        display:flex;
        flex-direction:column;
        align-items:center;
        justify-content:flex-start;
        background:radial-gradient(circle at top,#101827,#020617 60%);
        font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
        color:#e5e7eb;
      }

      .page{
        width:100%; max-width:1200px;
        padding:24px 16px 40px; /* ‚úÖ was 96px to offset fixed header */
        display:flex; flex-direction:column; gap:24px;
      }
      @media (min-width: 900px){ .page{ flex-direction:row; gap:36px; } }

      .left-panel,.right-panel{
        background:radial-gradient(circle at top left,#020617,#020617 70%);
        border-radius:28px;
        border:1px solid rgba(148,163,184,.20);
        padding:22px 22px 24px;
      }
      .left-panel{ flex:1.25; display:flex; flex-direction:column; gap:16px; }
      .right-panel{ flex:1; display:flex; flex-direction:column; gap:18px; }

      h1{
        font-size:28px; font-weight:650; letter-spacing:.08em; text-transform:uppercase;
        color:#f9fafb;
      }
      .subtitle{ font-size:14px; color:#9ca3af; max-width:560px; line-height:1.45; }

      .tag{
        display:inline-flex; align-items:center; gap:8px;
        border-radius:999px; border:1px solid rgba(148,163,184,.30);
        padding:5px 10px;
        font-size:10px; letter-spacing:.16em; text-transform:uppercase;
        background:radial-gradient(circle at top,#111827,#020617 70%);
      }

      .btn-row{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
      .btn-primary{
        border-radius:999px; padding:10px 18px;
        font-size:13px; letter-spacing:.14em; text-transform:uppercase;
        border:none; cursor:pointer;
        display:inline-flex; align-items:center; gap:8px; white-space:nowrap;
        background:radial-gradient(circle at top left,#a855f7,#4f46e5);
        color:#f9fafb; box-shadow:0 0 18px rgba(168,85,247,.45);
        transition:transform .15s ease-out, box-shadow .15s ease-out, opacity .15s ease-out;
      }
      .btn-primary:hover{ transform:translateY(-1px); box-shadow:0 0 22px rgba(168,85,247,.65); }
      .btn-primary:disabled{ opacity:.45; cursor:default; box-shadow:none; }

      .status-line{
        font-size:13px; color:#e5e7eb;
        background:rgba(15,23,42,.55);
        border-radius:999px; padding:8px 14px;
        border:1px solid rgba(148,163,184,.22);
        display:inline-flex; align-items:center; gap:8px;
      }
      .status-dot{ width:8px; height:8px; border-radius:999px; background:#22c55e; }
      .status-dot.error{ background:#f97373; }
      .status-dot.pending{ background:#facc15; }

      .caption{ font-size:12px; color:#9ca3af; line-height:1.4; }

      /* ‚úÖ tiny helper */
      .is-hidden { display:none !important; }

      /* Stats */
      .stats{
        margin-top:4px;
        padding:12px;
        border-radius:20px;
        border:1px solid rgba(148,163,184,.20);
        background:rgba(15,23,42,.35);
        display:grid;
        grid-template-columns: repeat(4, 1fr);
        gap:10px;
      }
      @media (max-width: 720px){ .stats{ grid-template-columns: repeat(2, 1fr); } }

      .stat{
        border-radius:16px;
        border:1px solid rgba(148,163,184,.14);
        background:rgba(2,6,23,.32);
        padding:10px 10px;
        min-height:66px;
      }
      .stat .k{ font-size:10px; letter-spacing:.16em; text-transform:uppercase; color:#9ca3af; }
      .stat .v{ margin-top:5px; font-size:16px; font-weight:850; color:#f9fafb; }
      .stat .s{ margin-top:2px; font-size:11px; color:#9ca3af; }

      /* Best pull */
      .best-pull{ display:flex; align-items:center; gap:10px; margin-top:5px; }
      .best-thumb{
        width:34px; height:34px; border-radius:10px; overflow:hidden;
        border:1px solid rgba(148,163,184,.20);
        background:rgba(15,23,42,.45);
        flex:0 0 auto;
      }
      .best-thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
      .best-meta{ display:flex; flex-direction:column; gap:1px; }
      .best-meta .line1{ font-size:12px; font-weight:800; color:#f9fafb; }
      .best-meta .line2{ font-size:11px; color:#9ca3af; }

      /* History */
      .history{
        margin-top:6px;
        padding:12px;
        border-radius:20px;
        border:1px solid rgba(148,163,184,.20);
        background:rgba(2,6,23,.24);
      }
      .history-title{
        font-size:10px; letter-spacing:.18em; text-transform:uppercase; color:#9ca3af;
        display:flex; justify-content:space-between; align-items:center; gap:10px;
        margin-bottom:10px;
      }
      .history-clear{
        font-size:10px; letter-spacing:.14em; text-transform:uppercase;
        border-radius:999px; padding:6px 10px;
        border:1px solid rgba(148,163,184,.20);
        background:rgba(15,23,42,.40);
        color:#e5e7eb;
        cursor:pointer;
      }
      .history-clear:hover{
        border-color: rgba(165,180,252,.65);
        box-shadow: 0 0 10px rgba(129,140,248,.25);
      }
      .history-list{
        display:flex; flex-direction:column; gap:8px;
        max-height:200px; overflow:auto; padding-right:4px;
      }
      .hist-item{
        display:flex; align-items:center; gap:10px;
        border-radius:14px;
        border:1px solid rgba(148,163,184,.14);
        background:rgba(15,23,42,.28);
        padding:8px 10px;
      }
      .hist-dot{ width:10px; height:10px; border-radius:999px; background:#facc15; flex:0 0 auto; box-shadow:0 0 14px rgba(250,204,21,.25); }
      .hist-dot.rare{ background:#38bdf8; box-shadow:0 0 14px rgba(56,189,248,.25); }
      .hist-dot.ultra{ background:#a855f7; box-shadow:0 0 14px rgba(168,85,247,.25); }
      .hist-dot.legendary{ background:#f97316; box-shadow:0 0 16px rgba(249,115,22,.28); }

      .hist-main{ display:flex; flex-direction:column; gap:1px; min-width:0; }
      .hist-line1{
        font-size:12px; font-weight:800; color:#f9fafb;
        display:flex; gap:8px; align-items:center; min-width:0;
      }
      .pill-mini{
        font-size:10px; letter-spacing:.12em; text-transform:uppercase;
        padding:4px 8px; border-radius:999px;
        border:1px solid rgba(148,163,184,.18);
        background:rgba(2,6,23,.35);
        color:#e5e7eb;
        flex:0 0 auto;
      }
      .hist-line2{ font-size:11px; color:#9ca3af; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

      /* Right preview booster */
      .card-zone{
        width:100%; min-height:420px;
        border-radius:28px;
        border:1px dashed rgba(148,163,184,.30);
        background:radial-gradient(circle at top,#0b1120,#020617 70%);
        display:flex; align-items:center; justify-content:center;
        padding:28px 16px;
        position:relative;
        overflow:hidden;
      }
      .card-frame{
        position:relative;
        width:260px; height:380px;
        border-radius:24px;
        padding:2px;
        background:radial-gradient(circle at top,#22c55e,#064e3b 70%);
        box-shadow:0 0 36px rgba(34,197,94,.45);
      }
      .card-inner{
        width:100%; height:100%;
        border-radius:22px;
        overflow:hidden;
      }

      /* ‚úÖ Top bar in normal flow */
      .top-bar{
        position:relative;
        width:100%;
        max-width:1200px;
        margin:16px auto 0;
        display:flex;
        justify-content:space-between;
        align-items:center;
        padding:0 16px;
        pointer-events:auto;
        z-index:10;
      }
      .top-left,.top-right{ display:flex; align-items:center; gap:12px; }
      .top-logo{ font-size:12px; letter-spacing:.22em; text-transform:uppercase; color:#9ca3af; }

      .top-link{
        font-size:12px; padding:6px 10px;
        border-radius:999px;
        border:1px solid rgba(148,163,184,.45);
        color:#e5e7eb; text-decoration:none;
        letter-spacing:.14em; text-transform:uppercase;
        background:rgba(15,23,42,.85);
      }
      .top-link:hover{ border-color:#a5b4fc; box-shadow:0 0 10px rgba(129,140,248,.4); }

      .wallet-wrap{ position:relative; }
      .wallet-pill{
        display:inline-flex; align-items:center; gap:10px;
        border-radius:999px;
        padding:6px 12px;
        background:radial-gradient(circle at top,#020617,#020617 70%);
        border:1px solid rgba(148,163,184,.45);
        cursor:default;
      }
      .wallet-label{ font-size:10px; letter-spacing:.18em; text-transform:uppercase; color:#9ca3af; }
      .wallet-main{ font-size:12px; font-weight:800; color:#f9fafb; }
      .wallet-sub{ font-size:10px; color:#9ca3af; }

      .wallet-pop{
        position:absolute; right:0; top:44px;
        width:260px;
        border-radius:18px;
        border:1px solid rgba(148,163,184,.20);
        background:rgba(2,6,23,.92);
        backdrop-filter:blur(10px);
        padding:12px;
        display:none;
        box-shadow:0 0 24px rgba(0,0,0,.35);
      }
      .wallet-wrap:hover .wallet-pop{ display:block; }
      .wallet-pop h3{
        margin:0 0 8px 0;
        font-size:11px; letter-spacing:.18em; text-transform:uppercase;
        color:#cbd5e1;
      }
      .wallet-hint{ margin-top:8px; font-size:11px; color:#9ca3af; line-height:1.35; }
      .btn-mini{
        border-radius:999px;
        padding:9px 12px;
        font-size:11px; letter-spacing:.14em; text-transform:uppercase;
        border:1px solid rgba(148,163,184,.20);
        cursor:pointer;
        background:rgba(15,23,42,.55);
        color:#e5e7eb;
      }
      .btn-mini:hover{
        border-color: rgba(165,180,252,.7);
        box-shadow:0 0 10px rgba(129,140,248,.25);
      }

      /* Hover preview float */
      .preview-float{
        position:fixed;
        top:50%;
        right:28px;
        transform:translateY(-50%);
        width:280px;
        aspect-ratio:3/4;
        border-radius:18px;
        overflow:hidden;
        background:rgba(2,6,23,.90);
        border:1px solid rgba(148,163,184,.22);
        box-shadow:0 0 30px rgba(0,0,0,.6);
        opacity:0;
        pointer-events:none;
        transition: opacity .12s ease;
        z-index:120;
      }
      .preview-float.on{ opacity:1; }
      .preview-float img{ width:100%; height:100%; object-fit:cover; display:block; }

      .preview-float-meta{
        position:absolute;
        left:10px; right:10px; bottom:10px;
        display:flex; justify-content:space-between; align-items:center; gap:10px;
      }
      .pf-name{
        font-size:11px; letter-spacing:.12em; text-transform:uppercase;
        font-weight:900;
        color:#e5e7eb;
        padding:6px 10px;
        border-radius:999px;
        border:1px solid rgba(148,163,184,.16);
        background:rgba(2,6,23,.45);
        max-width:70%;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }
      .pf-tag{
        font-size:11px; letter-spacing:.14em; text-transform:uppercase;
        padding:6px 10px; border-radius:999px;
        border:1px solid rgba(148,163,184,.16);
        background:rgba(2,6,23,.45);
        font-weight:900;
      }
      .pf-tag.common{ color:#facc15; }
      .pf-tag.rare{ color:#38bdf8; }
      .pf-tag.ultra{ color:#a855f7; }
      .pf-tag.legendary{ color:#f97316; }

      /* Opening overlay (CSGO-ish bigger) */
      .open-overlay{
        position:fixed; inset:0;
        display:none;
        align-items:center; justify-content:center;
        z-index:140;
        background:rgba(0,0,0,.62);
        backdrop-filter: blur(12px);
        padding:14px;
      }
      .open-overlay.on{ display:flex; }

      .open-modal{
        width:min(1140px, 98vw);
        border-radius:30px;
        border:1px solid rgba(148,163,184,.22);
        background:rgba(2,6,23,.90);
        box-shadow:0 0 52px rgba(0,0,0,.60);
        padding:20px;
        position:relative;
      }

      .open-top{
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        gap:10px;
        margin-bottom:12px;
      }

      .open-top-left{
        display:flex;
        align-items:flex-start;
        gap:12px;
        min-width:0;
      }
      .open-title{
        font-size:12px;
        letter-spacing:.22em;
        text-transform:uppercase;
        color:#cbd5e1;
        font-weight:800;
        white-space:nowrap;
      }
      .open-sub{
        font-size:12px;
        color:#9ca3af;
        margin-top:3px;
      }

      /* Close glow like "Ma collection" */
      .open-close{
        font-size:12px;
        padding:6px 10px;
        border-radius:999px;
        border:1px solid rgba(148,163,184,.45);
        color:#e5e7eb;
        letter-spacing:.14em;
        text-transform:uppercase;
        background:rgba(15,23,42,.85);
        cursor:pointer;
        box-shadow:0 0 10px rgba(129,140,248,.35);
        transition: box-shadow .15s ease-out, border-color .15s ease-out, transform .15s ease-out, opacity .15s ease-out;
        height: fit-content;
      }
      .open-close:hover{
        border-color:#a5b4fc;
        box-shadow:0 0 12px rgba(129,140,248,.45);
        transform: translateY(-1px);
      }
      .open-close:disabled{
        opacity:.45;
        cursor:default;
        box-shadow:none;
        transform:none;
      }

      .open-btn{
        border-radius:999px;
        padding:10px 14px;
        font-size:11px;
        letter-spacing:.14em;
        text-transform:uppercase;
        border:1px solid rgba(148,163,184,.20);
        background:rgba(15,23,42,.55);
        color:#e5e7eb;
        cursor:pointer;
      }
      .open-btn.primary{
        border:none;
        background: radial-gradient(circle at top left, #a855f7, #4f46e5);
        box-shadow: 0 0 18px rgba(168,85,247,.30);
      }
      .open-btn:disabled{ opacity:.45; cursor:default; }

      /* Reel */
      .reel-section{ display:block; }
      .reel-section.hidden{ display:none; }

      .reel-viewport{
        position:relative;
        border-radius:22px;
        border:1px solid rgba(148,163,184,.20);
        background:radial-gradient(circle at top,#0b1120,#020617 70%);
        overflow:hidden;
        padding:18px 12px;
      }

      .reel-strip{
        position:relative;
        height:188px;
        display:flex;
        align-items:center;
      }

      .reel-fade-left,
      .reel-fade-right{
        position:absolute;
        top:0; bottom:0;
        width:140px;
        pointer-events:none;
        z-index:3;
      }
      .reel-fade-left{
        left:0;
        background: linear-gradient(to right, rgba(2,6,23,.94), rgba(2,6,23,0));
      }
      .reel-fade-right{
        right:0;
        background: linear-gradient(to left, rgba(2,6,23,.94), rgba(2,6,23,0));
      }

      /* ‚úÖ Cursor line aligned ONLY on image area */
      .reel-cursor-line{
        position:absolute;
        left:50%;
        top:0px;
        transform:translateX(-50%);
        width:4px;
        height:132px;
        border-radius:999px;
        background: linear-gradient(to bottom, transparent, rgba(250,204,21,.95), transparent);
        box-shadow: 0 0 18px rgba(250,204,21,.55);
        z-index:4;
        pointer-events:none;
        opacity:.98;
      }

      .reel-track{
        display:flex;
        align-items:center;
        gap:12px;
        will-change: transform;
        transform: translateX(0px);
      }
      .reel-track.spinning{
        transition: transform 7.1s cubic-bezier(0.08, 0.84, 0.12, 1);
      }

      .reel-item{
        width:168px;
        height:184px;
        border-radius:20px;
        overflow:hidden;
        border:1px solid rgba(148,163,184,.16);
        background:rgba(15,23,42,.28);
        flex:0 0 auto;
        position:relative;
      }
      .reel-thumb{
        width:100%;
        height:132px;
        overflow:hidden;
        border-bottom:1px solid rgba(148,163,184,.12);
        background:#020617;
      }
      .reel-thumb img{ width:100%; height:100%; object-fit:cover; display:block; }

      .reel-meta{
        padding:10px 12px 12px;
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap:10px;
        min-width:0;
      }
      .reel-name{
        font-size:10px;
        letter-spacing:.12em;
        text-transform:uppercase;
        font-weight:900;
        color:#e5e7eb;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }
      .reel-tag{
        font-size:10px;
        letter-spacing:.12em;
        text-transform:uppercase;
        padding:4px 8px;
        border-radius:999px;
        border:1px solid rgba(148,163,184,.16);
        background:rgba(2,6,23,.35);
        flex:0 0 auto;
        font-weight:900;
      }
      .reel-tag.common{ color:#facc15; }
      .reel-tag.rare{ color:#38bdf8; }
      .reel-tag.ultra{ color:#a855f7; }
      .reel-tag.legendary{ color:#f97316; }

      .open-actions{
        margin-top:12px;
        display:flex;
        justify-content:space-between;
        gap:10px;
        align-items:center;
      }
      .open-actions-left{ font-size:12px; color:#9ca3af; }

      /* Result view: centered, buttons under card */
      .result-section{ display:none; }
      .result-section.on{ display:block; }

      .result-centered{
        display:flex;
        flex-direction:column;
        align-items:center;
        justify-content:center;
        gap:12px;
        padding:6px 0 2px;
      }

      .result-card{
        width:min(480px, 92vw);
        border-radius:22px;
        border:1px solid rgba(148,163,184,.20);
        background:rgba(2,6,23,.35);
        padding:14px;
        transform: translateY(-6px);
      }

      .result-img{
        width:100%;
        aspect-ratio:3/4;
        border-radius:18px;
        overflow:hidden;
        border:1px solid rgba(148,163,184,.22);
        background:#020617;
        position:relative;
      }
      .result-img img{ width:100%; height:100%; object-fit:cover; display:block; }

      .result-meta{
        margin-top:10px;
        display:flex;
        justify-content:space-between;
        align-items:flex-start;
        gap:10px;
      }
      .result-name{
        font-size:12px;
        letter-spacing:.12em;
        text-transform:uppercase;
        font-weight:900;
        color:#f9fafb;
      }
      .result-sub{
        margin-top:6px;
        font-size:12px;
        color:#9ca3af;
        line-height:1.35;
      }
      .result-pill{
        font-size:11px;
        letter-spacing:.14em;
        text-transform:uppercase;
        padding:8px 10px;
        border-radius:999px;
        border:1px solid rgba(148,163,184,.20);
        background:rgba(2,6,23,.35);
        font-weight:900;
        white-space:nowrap;
      }
      .result-pill.common{ color:#facc15; }
      .result-pill.rare{ color:#38bdf8; }
      .result-pill.ultra{ color:#a855f7; }
      .result-pill.legendary{ color:#f97316; }

      .result-btnrow{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        align-items:center;
        justify-content:center;
        margin-top:-2px;
      }

      .result-note{
        font-size:12px;
        color:#9ca3af;
        line-height:1.45;
        text-align:center;
        max-width:560px;
        padding:0 10px;
      }
      .result-foot{
        margin-top:2px;
        font-size:12px;
        color:#9ca3af;
        text-align:center;
        opacity:.9;
      }

      /* Fly to collection animation */
      .fly-out{
        animation: flyToCollection .85s ease-in forwards;
        transform-origin:center;
      }
      @keyframes flyToCollection{
        0%{ transform:translate(0,0) scale(1); opacity:1; }
        60%{ transform:translate(120px,-90px) scale(.92); opacity:.95; }
        100%{ transform:translate(210px,-160px) scale(.72); opacity:0; }
      }

      /* Loot table */
      .drop-table{
        margin-top:10px;
        padding:16px 18px 18px;
        border-radius:24px;
        border:1px solid rgba(148,163,184,.22);
        background:radial-gradient(circle at top left,#020617,#020617 70%);
        display:flex; flex-direction:column; gap:12px;
      }
      .drop-title{
        font-size:11px; letter-spacing:.18em; text-transform:uppercase;
        color:#9ca3af; text-align:center;
      }
      .drop-grid{ display:grid; grid-template-columns: repeat(7, 1fr); gap:14px; justify-items:center; }
      @media (max-width: 1080px){ .drop-grid{ grid-template-columns: repeat(6, 1fr); } }
      @media (max-width: 900px){ .drop-grid{ grid-template-columns: repeat(5, 1fr); } }
      @media (max-width: 740px){ .drop-grid{ grid-template-columns: repeat(4, 1fr); } }

      .drop-item{
        width:92px;
        display:flex; flex-direction:column; align-items:center; gap:6px;
        text-align:center;
        cursor:pointer;
        user-select:none;
      }
      .drop-thumb{
        width:78px; height:100px;
        border-radius:14px;
        overflow:hidden;
        border:1px solid rgba(148,163,184,.22);
        background:#020617;
        transition:transform .16s ease-out, box-shadow .16s ease-out;
      }
      .drop-thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
      .drop-name{
        font-size:10px; letter-spacing:.10em; text-transform:uppercase;
        color:#e5e7eb;
      }
      .drop-meta{ font-size:9px; color:#9ca3af; display:flex; flex-direction:column; gap:2px; }
      .drop-tag{ letter-spacing:.14em; text-transform:uppercase; font-weight:700; }
      .drop-tag.common{ color:#facc15; }
      .drop-tag.rare{ color:#38bdf8; }
      .drop-tag.ultra{ color:#a855f7; }
      .drop-tag.legendary{ color:#f97316; }

      .drop-item[data-rarity="COMMON"]:hover .drop-thumb{ transform:translateY(-2px) scale(1.04); box-shadow:0 0 14px rgba(250,204,21,.35); }
      .drop-item[data-rarity="RARE"]:hover .drop-thumb{ transform:translateY(-2px) scale(1.04); box-shadow:0 0 14px rgba(56,189,248,.35); }
      .drop-item[data-rarity="ULTRA"]:hover .drop-thumb{ transform:translateY(-2px) scale(1.04); box-shadow:0 0 16px rgba(168,85,247,.38); }
      .drop-item[data-rarity="LEGENDARY"]:hover .drop-thumb{ transform:translateY(-2px) scale(1.04); box-shadow:0 0 18px rgba(249,115,22,.42); }
    </style>
  </head>

  <body>
    <!-- Passive hover preview (NO blink) -->
    <div class="preview-float" id="preview-float" aria-hidden="true">
      <img id="preview-img" src="" alt="Preview" />
      <div class="preview-float-meta">
        <div class="pf-name" id="preview-name">‚Äî</div>
        <div class="pf-tag common" id="preview-tag">COMMON</div>
      </div>
    </div>

    <!-- Opening overlay -->
    <div class="open-overlay" id="open-overlay" aria-hidden="true">
      <div class="open-modal" role="dialog" aria-modal="true">
        <div class="open-top">
          <div class="open-top-left">
            <div>
              <div class="open-title">VAULTSPIN ¬∑ OPENING</div>
              <div class="open-sub" id="open-sub">La roulette ralentit et s‚Äôarr√™te sur ta carte.</div>
            </div>

            <!-- ‚úÖ Close present ONLY after opening (result) -->
            <button class="open-close is-hidden" id="open-close" disabled>Close</button>
          </div>

          <div style="display:flex; gap:10px; align-items:center;">
            <!-- ‚úÖ Skip present ONLY during opening (reel) -->
            <button class="open-btn" id="open-skip">Skip</button>
            <button class="open-btn primary" id="open-another" disabled>Open another pack</button>
          </div>
        </div>

        <!-- Reel section -->
        <div class="reel-section" id="reel-section">
          <div class="reel-viewport" id="reel-viewport">
            <div class="reel-fade-left"></div>
            <div class="reel-fade-right"></div>

            <div class="reel-strip">
              <div class="reel-cursor-line"></div>
              <div class="reel-track" id="reel-track"></div>
            </div>
          </div>

          <div class="open-actions">
            <div class="open-actions-left" id="open-hint">Opening‚Ä¶</div>
            <div style="display:flex; gap:10px; align-items:center;">
              <span style="font-size:11px; color:#94a3b8;">La roulette s‚Äôarr√™te sur ta carte.</span>
            </div>
          </div>
        </div>

        <!-- Result-only section -->
        <div class="result-section" id="result-section">
          <div class="result-centered">
            <div class="result-card" id="result-card">
              <div class="result-img" id="result-imgwrap">
                <img id="result-img" src="" alt="Result" />
              </div>
              <div class="result-meta">
                <div>
                  <div class="result-name" id="result-name">‚Äî</div>
                  <div class="result-sub" id="result-desc">‚Äî</div>
                </div>
                <div class="result-pill common" id="result-pill">COMMON</div>
              </div>
            </div>

            <div class="result-btnrow">
              <button class="open-btn primary" id="result-open-another">Open another pack</button>
              <a class="top-link" href="collection.html" style="display:inline-flex; align-items:center; justify-content:center; padding:10px 14px;">
                Ma collection
              </a>
            </div>

            <div class="result-note" id="result-note">
              Tu peux observer ta carte. Quand tu veux : ouvre un autre pack, ou ferme.
            </div>

            <div class="result-foot" id="result-footnote">‚Äî</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚úÖ Top bar (normal flow, not fixed) -->
    <div class="top-bar">
      <div class="top-left">
        <div class="top-logo">VAULTSPIN ¬∑ PACKS HYBRIDES</div>
      </div>
      <div class="top-right">
        <a class="top-link" href="collection.html" id="collection-toplink">Ma collection</a>

        <div class="wallet-wrap">
          <div class="wallet-pill" title="Mode d√©mo : ouvertures infinies">
            <span class="wallet-label">Mon wallet</span>
            <span class="wallet-main" id="wallet-eur">‚àû ‚Ç¨</span>
            <span class="wallet-sub" id="wallet-eth">‚âà ‚àû ETH</span>
          </div>

          <div class="wallet-pop">
            <h3>Wallet (d√©mo)</h3>
            <div class="wallet-hint">
              Mode ‚Äúouvertures infinies‚Äù activ√©.<br/>
              On garde <b>Spent</b> en stats pour le feeling.
            </div>
            <div style="margin-top:10px; display:flex; gap:10px;">
              <button class="btn-mini" id="reset-data">Reset data</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="page">
      <!-- LEFT -->
      <div class="left-panel">
        <div class="tag">VAULTSPIN ¬∑ D√âMO (OFF-CHAIN)</div>

        <div>
          <h1>Open your VaultSpin Pack</h1>
          <p class="subtitle">
            V11.5 : Close/Skip conditionnels (reel vs result), top menu non-fix (ne chevauche plus), overlay CSGO bigger, cursor image-only, r√©sultat centr√© + boutons sous carte, tick sync.
          </p>
        </div>

        <div class="btn-row">
          <button id="open-pack-btn" class="btn-primary">Open VaultSpin Pack ‚Äî 3,99 ‚Ç¨</button>
        </div>

        <div id="status-line" class="status-line">
          <span class="status-dot" id="status-dot"></span>
          <span id="status-text">Mode d√©mo : ouvre des packs sans wallet.</span>
        </div>
        <p class="caption">
          Dans la version finale, le prix sera d√©bit√© de ton wallet VaultSpin (CB ou crypto convertie en ‚Ç¨).
        </p>

        <!-- Stats -->
        <div class="stats">
          <div class="stat">
            <div class="k">Packs opened</div>
            <div class="v" id="stat-opened">0</div>
            <div class="s">Total</div>
          </div>

          <div class="stat">
            <div class="k">Spent</div>
            <div class="v" id="stat-spent">0‚Ç¨</div>
            <div class="s">Local</div>
          </div>

          <div class="stat">
            <div class="k">Last pull</div>
            <div class="v" id="stat-last">‚Äî</div>
            <div class="s" id="stat-last-sub">‚Äî</div>
          </div>

          <div class="stat">
            <div class="k">Best pull</div>
            <div class="best-pull">
              <div class="best-thumb"><img id="stat-best-img" src="images/venusaur_common.png" alt="Best" /></div>
              <div class="best-meta">
                <div class="line1" id="stat-best-line1">‚Äî</div>
                <div class="line2" id="stat-best-line2">‚Äî</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Timeline -->
        <div class="history">
          <div class="history-title">
            <span>Pack history</span>
            <button class="history-clear" id="clear-history">Clear</button>
          </div>
          <div class="history-list" id="history-list"></div>
        </div>

        <div style="margin-top: 6px">
          <div class="caption" id="mint-info">
            En attente d‚Äôune ouverture‚Ä¶ clique sur le bouton pour lancer l‚Äôanimation.
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="right-panel">
        <div class="card-zone">
          <div id="card-frame" class="card-frame">
            <div class="card-inner">
              <div id="booster-closed" class="booster-closed booster-mode-idle">
                <div class="booster-label">
                  <div class="booster-leaf-icon">üåø</div>
                  <div class="booster-chip">VaultSpin Pack</div>
                  <div class="booster-title">Booster Plante</div>
                  <div class="booster-subtitle">1 carte √† r√©v√©ler</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Drops -->
        <div class="drop-table">
          <div class="drop-title">Cartes potentiellement obtenables (hover = preview ¬∑ click = filtre collection)</div>

          <div class="drop-grid" id="drop-grid">
            <!-- COMMON -->
            <div class="drop-item" data-rarity="COMMON" data-name="Bulbizarre" data-img="images/bulbasaur_common.png" data-ct="0">
              <div class="drop-thumb"><img src="images/bulbasaur_common.png" alt="Bulbizarre Common" /></div>
              <div class="drop-name">Bulbizarre</div>
              <div class="drop-meta"><span>70% de chance</span><span class="drop-tag common">Common</span></div>
            </div>

            <div class="drop-item" data-rarity="COMMON" data-name="Herbizarre" data-img="images/ivysaur_common.png" data-ct="1">
              <div class="drop-thumb"><img src="images/ivysaur_common.png" alt="Herbizarre Common" /></div>
              <div class="drop-name">Herbizarre</div>
              <div class="drop-meta"><span>70% de chance</span><span class="drop-tag common">Common</span></div>
            </div>

            <div class="drop-item" data-rarity="COMMON" data-name="Florizarre" data-img="images/venusaur_common.png" data-ct="2">
              <div class="drop-thumb"><img src="images/venusaur_common.png" alt="Florizarre Common" /></div>
              <div class="drop-name">Florizarre</div>
              <div class="drop-meta"><span>70% de chance</span><span class="drop-tag common">Common</span></div>
            </div>

            <!-- RARE -->
            <div class="drop-item" data-rarity="RARE" data-name="Bulbizarre" data-img="images/bulbasaur_rare.png" data-ct="3">
              <div class="drop-thumb"><img src="images/bulbasaur_rare.png" alt="Bulbizarre Rare" /></div>
              <div class="drop-name">Bulbizarre</div>
              <div class="drop-meta"><span>20% de chance</span><span class="drop-tag rare">Rare</span></div>
            </div>

            <div class="drop-item" data-rarity="RARE" data-name="Herbizarre" data-img="images/ivysaur_rare.png" data-ct="4">
              <div class="drop-thumb"><img src="images/ivysaur_rare.png" alt="Herbizarre Rare" /></div>
              <div class="drop-name">Herbizarre</div>
              <div class="drop-meta"><span>20% de chance</span><span class="drop-tag rare">Rare</span></div>
            </div>

            <div class="drop-item" data-rarity="RARE" data-name="Florizarre" data-img="images/venusaur_rare.png" data-ct="5">
              <div class="drop-thumb"><img src="images/venusaur_rare.png" alt="Florizarre Rare" /></div>
              <div class="drop-name">Florizarre</div>
              <div class="drop-meta"><span>20% de chance</span><span class="drop-tag rare">Rare</span></div>
            </div>

            <!-- ULTRA -->
            <div class="drop-item" data-rarity="ULTRA" data-name="Bulbizarre" data-img="images/bulbasaur_ultra.png" data-ct="6">
              <div class="drop-thumb"><img src="images/bulbasaur_ultra.png" alt="Bulbizarre Ultra" /></div>
              <div class="drop-name">Bulbizarre</div>
              <div class="drop-meta"><span>9% de chance</span><span class="drop-tag ultra">Ultra</span></div>
            </div>

            <div class="drop-item" data-rarity="ULTRA" data-name="Herbizarre" data-img="images/ivysaur_ultra.png" data-ct="7">
              <div class="drop-thumb"><img src="images/ivysaur_ultra.png" alt="Herbizarre Ultra" /></div>
              <div class="drop-name">Herbizarre</div>
              <div class="drop-meta"><span>9% de chance</span><span class="drop-tag ultra">Ultra</span></div>
            </div>

            <div class="drop-item" data-rarity="ULTRA" data-name="Florizarre" data-img="images/venusaur_ultra.png" data-ct="8">
              <div class="drop-thumb"><img src="images/venusaur_ultra.png" alt="Florizarre Ultra" /></div>
              <div class="drop-name">Florizarre</div>
              <div class="drop-meta"><span>9% de chance</span><span class="drop-tag ultra">Ultra</span></div>
            </div>

            <!-- LEGENDARY -->
            <div class="drop-item" data-rarity="LEGENDARY" data-name="Bulbizarre" data-img="images/bulbasaur_legendary.png" data-ct="9">
              <div class="drop-thumb"><img src="images/bulbasaur_legendary.png" alt="Bulbizarre Legendary" /></div>
              <div class="drop-name">Bulbizarre</div>
              <div class="drop-meta"><span>1% de chance</span><span class="drop-tag legendary">Legendary</span></div>
            </div>

            <div class="drop-item" data-rarity="LEGENDARY" data-name="Herbizarre" data-img="images/ivysaur_legendary.png" data-ct="10">
              <div class="drop-thumb"><img src="images/ivysaur_legendary.png" alt="Herbizarre Legendary" /></div>
              <div class="drop-name">Herbizarre</div>
              <div class="drop-meta"><span>1% de chance</span><span class="drop-tag legendary">Legendary</span></div>
            </div>

            <div class="drop-item" data-rarity="LEGENDARY" data-name="Florizarre" data-img="images/venusaur_legendary.png" data-ct="11">
              <div class="drop-thumb"><img src="images/venusaur_legendary.png" alt="Florizarre Legendary" /></div>
              <div class="drop-name">Florizarre</div>
              <div class="drop-meta"><span>1% de chance</span><span class="drop-tag legendary">Legendary</span></div>
            </div>

            <div class="drop-item" data-rarity="LEGENDARY" data-name="Plante" data-img="images/plant_legendary.png" data-ct="12">
              <div class="drop-thumb"><img src="images/plant_legendary.png" alt="Plante Legendary" /></div>
              <div class="drop-name">Plante</div>
              <div class="drop-meta"><span>1% de chance</span><span class="drop-tag legendary">Legendary</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sounds -->
    <audio id="sfx-booster" src="sounds/booster_open.mp3" preload="auto"></audio>
    <audio id="sfx-reveal" src="sounds/card_reveal.mp3" preload="auto"></audio>
    <audio id="sfx-legendary" src="sounds/legendary_fx.mp3" preload="auto"></audio>
    <audio id="sfx-tick" src="sounds/clic_clic.mp3" preload="auto"></audio>

    <script>
      /********************
       * STORAGE KEYS
       ********************/
      const VS_COLLECTION_KEY = "vaultspin_collection_v1";
      const VS_TOKEN_COUNTER_KEY = "vaultspin_demo_token_counter_v1";

      /********************
       * ECONOMY (‚àû wallet)
       ********************/
      const PACK_PRICE_EUR = 3.99;

      /********************
       * Cards config
       ********************/
      const CARD_IMAGE_BY_INDEX = {
        0:"images/bulbasaur_common.png",
        1:"images/ivysaur_common.png",
        2:"images/venusaur_common.png",
        3:"images/bulbasaur_rare.png",
        4:"images/ivysaur_rare.png",
        5:"images/venusaur_rare.png",
        6:"images/bulbasaur_ultra.png",
        7:"images/ivysaur_ultra.png",
        8:"images/venusaur_ultra.png",
        9:"images/bulbasaur_legendary.png",
        10:"images/ivysaur_legendary.png",
        11:"images/venusaur_legendary.png",
        12:"images/plant_legendary.png",
      };

      const CARD_NAME_BY_INDEX = {
        0:"Bulbizarre", 1:"Herbizarre", 2:"Florizarre",
        3:"Bulbizarre", 4:"Herbizarre", 5:"Florizarre",
        6:"Bulbizarre", 7:"Herbizarre", 8:"Florizarre",
        9:"Bulbizarre", 10:"Herbizarre", 11:"Florizarre",
        12:"Plante",
      };

      const CARD_RARITY_BY_INDEX = { 0:0,1:0,2:0, 3:1,4:1,5:1, 6:2,7:2,8:2, 9:3,10:3,11:3,12:3 };
      const CARD_WEIGHT_BY_INDEX = { 0:7000,1:7000,2:7000, 3:2000,4:2000,5:2000, 6:900,7:900,8:900, 9:100,10:100,11:100,12:100 };

      const RARITY_ORDER = ["COMMON","RARE","ULTRA","LEGENDARY"];

      function rarityToLabel(num){ return ({0:"Common",1:"Rare",2:"Ultra",3:"Legendary"})[num] || "Common"; }
      function rarityKeyFromNum(num){ return (num===0)?"COMMON":(num===1)?"RARE":(num===2)?"ULTRA":(num===3)?"LEGENDARY":"COMMON"; }

      function pickWeightedCardIndex(){
        let total = 0;
        for (const k in CARD_WEIGHT_BY_INDEX) total += CARD_WEIGHT_BY_INDEX[k];
        const roll = Math.floor(Math.random() * total);
        let c = 0;
        for (const k in CARD_WEIGHT_BY_INDEX){
          c += CARD_WEIGHT_BY_INDEX[k];
          if (roll < c) return parseInt(k, 10);
        }
        return 0;
      }

      /********************
       * Collection helpers
       ********************/
      function getCollection(){
        try{ return JSON.parse(localStorage.getItem(VS_COLLECTION_KEY) || "[]"); }
        catch{ return []; }
      }
      function setCollection(arr){ localStorage.setItem(VS_COLLECTION_KEY, JSON.stringify(arr)); }

      function nextLocalTokenId(){
        const raw = localStorage.getItem(VS_TOKEN_COUNTER_KEY);
        const n = raw ? Number(raw) : 1;
        const next = Number.isFinite(n) && n > 0 ? n : 1;
        localStorage.setItem(VS_TOKEN_COUNTER_KEY, String(next + 1));
        return next;
      }

      function pushToCollection(entry){
        const arr = getCollection();
        arr.unshift(entry);
        setCollection(arr);
      }

      /********************
       * UI state
       ********************/
      const UI_STATE = { IDLE:"idle", OPENING:"opening", RESULT:"result" };
      let uiState = UI_STATE.IDLE;

      let sfxBooster=null, sfxReveal=null, sfxLegendary=null, sfxTickSrc=null;
      let tickA=null, tickB=null, tickFlip=false;
      let lastTickAt = 0;

      function sleep(ms){ return new Promise((r)=>setTimeout(r, ms)); }
      function isBusy(){ return uiState !== UI_STATE.IDLE; }

      function setStatus(text, mode="ok"){
        const t = document.getElementById("status-text");
        const d = document.getElementById("status-dot");
        t.textContent = text;
        d.classList.remove("error","pending");
        if (mode==="error") d.classList.add("error");
        if (mode==="pending") d.classList.add("pending");
      }

      function playSound(el){
        if(!el) return;
        try{ el.currentTime=0; el.play().catch(()=>{}); }catch(_){}
      }

      function hardResetTicks(){
        lastTickAt = 0;
        try{
          if (tickA){ tickA.pause(); tickA.currentTime = 0; }
          if (tickB){ tickB.pause(); tickB.currentTime = 0; }
        }catch(_){}
      }

      function playTick(force=false){
        const now = performance.now();
        if (!force && (now - lastTickAt < 58)) return;
        lastTickAt = now;

        const a = tickFlip ? tickA : tickB;
        tickFlip = !tickFlip;
        if (!a) return;
        try{
          a.currentTime = 0;
          a.play().catch(()=>{});
        }catch(_){}
      }

      function formatDate(ts){
        const d = new Date(ts);
        return d.toLocaleString("fr-FR", { day:"2-digit", month:"2-digit", year:"2-digit", hour:"2-digit", minute:"2-digit" });
      }

      function bestPullFromCollection(arr){
        if (!arr.length) return null;
        let best = arr[0];
        for (const c of arr){
          if (RARITY_ORDER.indexOf(c.rarityKey) > RARITY_ORDER.indexOf(best.rarityKey)) best = c;
        }
        return best;
      }

      function renderStats(){
        const arr = getCollection();
        const opened = arr.length;
        const spent = opened * PACK_PRICE_EUR;
        const last = opened ? arr[0] : null;
        const best = opened ? bestPullFromCollection(arr) : null;

        document.getElementById("stat-opened").textContent = String(opened);
        document.getElementById("stat-spent").textContent = spent.toLocaleString("fr-FR", { maximumFractionDigits: 2 }) + "‚Ç¨";

        if (last){
          document.getElementById("stat-last").textContent = "#" + last.tokenId;
          document.getElementById("stat-last-sub").textContent = last.rarityLabel;
        } else {
          document.getElementById("stat-last").textContent = "‚Äî";
          document.getElementById("stat-last-sub").textContent = "‚Äî";
        }

        if (best){
          document.getElementById("stat-best-img").src = best.img;
          document.getElementById("stat-best-line1").textContent = best.rarityLabel + " #" + best.tokenId;
          document.getElementById("stat-best-line2").textContent = formatDate(best.ts);
        } else {
          document.getElementById("stat-best-line1").textContent = "‚Äî";
          document.getElementById("stat-best-line2").textContent = "‚Äî";
        }
      }

      function dotClassForRarityKey(k){
        if (k==="LEGENDARY") return "legendary";
        if (k==="ULTRA") return "ultra";
        if (k==="RARE") return "rare";
        return "common";
      }

      function renderHistory(){
        const list = document.getElementById("history-list");
        const arr = getCollection().slice(0, 12);
        list.innerHTML = "";

        if (!arr.length){
          const empty = document.createElement("div");
          empty.className = "caption";
          empty.textContent = "Aucun pack ouvert pour l‚Äôinstant.";
          list.appendChild(empty);
          return;
        }

        for (const c of arr){
          const row = document.createElement("div");
          row.className = "hist-item";

          const dot = document.createElement("div");
          dot.className = "hist-dot " + dotClassForRarityKey(c.rarityKey);

          const main = document.createElement("div");
          main.className = "hist-main";

          const l1 = document.createElement("div");
          l1.className = "hist-line1";
          l1.innerHTML = `<span>#${c.tokenId}</span><span class="pill-mini">${c.rarityLabel}</span>`;

          const l2 = document.createElement("div");
          l2.className = "hist-line2";
          l2.textContent = formatDate(c.ts);

          main.appendChild(l1);
          main.appendChild(l2);

          row.appendChild(dot);
          row.appendChild(main);

          list.appendChild(row);
        }
      }

      /********************
       * Opening overlay helpers
       ********************/
      function openOverlay(){
        const o = document.getElementById("open-overlay");
        if (!o.classList.contains("on")){
          o.classList.add("on");
          o.setAttribute("aria-hidden","false");
        }
      }
      function closeOverlay(){
        const o = document.getElementById("open-overlay");
        o.classList.remove("on");
        o.setAttribute("aria-hidden","true");
      }

      // ‚úÖ During opening: SKIP visible, CLOSE hidden
      function showReel(){
        document.getElementById("reel-section").classList.remove("hidden");
        document.getElementById("result-section").classList.remove("on");

        document.getElementById("open-skip").classList.remove("is-hidden");
        document.getElementById("open-close").classList.add("is-hidden");

        document.getElementById("open-close").disabled = true;
        document.getElementById("open-another").disabled = true;

        document.getElementById("open-skip").disabled = false;
        document.getElementById("open-hint").textContent = "Opening‚Ä¶";
        document.getElementById("open-sub").textContent = "La roulette ralentit et s‚Äôarr√™te sur ta carte.";
      }

      // ‚úÖ After opening: CLOSE visible, SKIP hidden
      function showResult(){
        document.getElementById("reel-section").classList.add("hidden");
        document.getElementById("result-section").classList.add("on");

        document.getElementById("open-skip").classList.add("is-hidden");
        document.getElementById("open-close").classList.remove("is-hidden");

        document.getElementById("open-close").disabled = false;
      }

      /********************
       * Reel logic
       ********************/
      const REEL_TOTAL_ITEMS = 60;
      let spinning = false;
      let stopIndex = 0;
      let currentOpen = null;
      let rafId = null;
      let lastIndexUnderCursor = -1;

      function buildReelItems(winningCt){
        const arr = [];
        for (let i=0;i<REEL_TOTAL_ITEMS;i++) arr.push(pickWeightedCardIndex());
        stopIndex = Math.max(20, REEL_TOTAL_ITEMS - 10);
        arr[stopIndex] = winningCt;
        return arr;
      }

      function escapeHtml(s){
        return String(s || "").replace(/[&<>"']/g, (c) => ({
          "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
        }[c]));
      }

      function renderReel(reelItems){
        const track = document.getElementById("reel-track");
        track.innerHTML = "";
        track.classList.remove("spinning");
        track.style.transition = "";
        track.style.transform = "translateX(0px)";
        void track.offsetHeight;

        for (let i=0;i<reelItems.length;i++){
          const ct = reelItems[i];
          const rarityNum = CARD_RARITY_BY_INDEX[ct] ?? 0;
          const rk = rarityKeyFromNum(rarityNum);

          const el = document.createElement("div");
          el.className = "reel-item";
          el.setAttribute("data-i", String(i));
          el.innerHTML = `
            <div class="reel-thumb">
              <img src="${CARD_IMAGE_BY_INDEX[ct]}" alt="${escapeHtml(CARD_NAME_BY_INDEX[ct] || ("Card"))}"/>
            </div>
            <div class="reel-meta">
              <div class="reel-name">${escapeHtml(CARD_NAME_BY_INDEX[ct] || ("Card"))}</div>
              <div class="reel-tag ${rk.toLowerCase()}">${rk}</div>
            </div>
          `;
          track.appendChild(el);
        }
      }

      function getStepPx(){
        const track = document.getElementById("reel-track");
        const first = track.firstElementChild;
        if (!first) return 180;
        const w = first.getBoundingClientRect().width;
        const gap = parseFloat(getComputedStyle(track).gap || "12") || 12;
        return w + gap;
      }

      function getTranslateX(el){
        const tr = getComputedStyle(el).transform;
        if (!tr || tr === "none") return 0;
        const m = tr.match(/matrix\(([^)]+)\)/);
        if (!m) return 0;
        const parts = m[1].split(",").map(x => parseFloat(x.trim()));
        return Number.isFinite(parts[4]) ? parts[4] : 0;
      }

      function startTickLoop(){
        const track = document.getElementById("reel-track");
        const viewport = document.getElementById("reel-viewport");

        lastIndexUnderCursor = -1;

        const loop = () => {
          if (!spinning) return;
          const x = getTranslateX(track);
          const step = getStepPx();
          const vw = viewport.getBoundingClientRect().width;
          const cursorX = vw / 2;

          const offset = -x;
          const idx = Math.floor((offset + cursorX) / step);

          if (idx !== lastIndexUnderCursor){
            lastIndexUnderCursor = idx;
            playTick();
          }

          rafId = requestAnimationFrame(loop);
        };

        rafId = requestAnimationFrame(loop);
      }

      function stopTickLoop(){
        if (rafId) cancelAnimationFrame(rafId);
        rafId = null;
      }

      async function spinToStop(){
        spinning = true;
        setStatus("Ouverture : roulette en cours‚Ä¶", "pending");

        const track = document.getElementById("reel-track");
        const viewport = document.getElementById("reel-viewport");

        track.classList.remove("spinning");
        track.style.transition = "";
        track.style.transform = "translateX(0px)";
        void track.offsetHeight;

        const step = getStepPx();
        const vw = viewport.getBoundingClientRect().width;
        const cursorX = vw / 2;
        const targetCenter = stopIndex * step + (step / 2);
        const targetTranslate = targetCenter - cursorX;

        const jitter = (Math.random()*6) - 3;
        const finalX = -(targetTranslate + jitter);

        hardResetTicks();
        playSound(sfxBooster);
        playTick(true);

        startTickLoop();

        track.classList.add("spinning");
        requestAnimationFrame(() => {
          track.style.transform = `translateX(${finalX}px)`;
        });

        await new Promise((resolve) => {
          track.addEventListener("transitionend", resolve, { once:true });
        });

        spinning = false;
        stopTickLoop();
      }

      function skipSpinNow(){
        if (!spinning) return;
        const track = document.getElementById("reel-track");
        const viewport = document.getElementById("reel-viewport");

        track.classList.remove("spinning");

        const step = getStepPx();
        const vw = viewport.getBoundingClientRect().width;
        const cursorX = vw / 2;
        const targetCenter = stopIndex * step + (step / 2);
        const targetTranslate = targetCenter - cursorX;
        const finalX = -(targetTranslate);

        track.style.transition = "transform 260ms cubic-bezier(.2,.8,.2,1)";
        track.style.transform = `translateX(${finalX}px)`;
      }

      function fillResultUI(){
        const { rarityNum, rarityKey, imgSrc, name, tokenId, ts } = currentOpen;

        document.getElementById("open-sub").textContent = `‚úÖ Tu as obtenu : ${name} ¬∑ ${rarityToLabel(rarityNum)}`;
        document.getElementById("result-img").src = imgSrc;
        document.getElementById("result-name").textContent = `${name} ‚Äî #${tokenId}`;
        document.getElementById("result-desc").textContent = `${rarityToLabel(rarityNum)} ¬∑ ${formatDate(ts)}`;

        const pill = document.getElementById("result-pill");
        pill.textContent = rarityKey;
        pill.className = "result-pill " + rarityKey.toLowerCase();

        document.getElementById("result-footnote").textContent =
          `Ajout√©e √† ta collection : tokenId ${tokenId} ‚Ä¢ ${rarityToLabel(rarityNum)}`;
      }

      function commitToCollection(){
        const { winningCt, rarityNum, rarityKey, imgSrc, name, tokenId, ts } = currentOpen;
        const entry = {
          tokenId,
          ts,
          priceEur: PACK_PRICE_EUR,
          rarity: rarityNum,
          rarityLabel: rarityToLabel(rarityNum),
          rarityKey,
          cardTypeIndex: winningCt,
          img: imgSrc,
          name
        };
        pushToCollection(entry);

        document.getElementById("mint-info").textContent =
          `Carte ajout√©e √† ta collection ‚Äî tokenId ${tokenId} ‚Ä¢ ${entry.rarityLabel}`;

        renderStats();
        renderHistory();
      }

      async function openPackRoulette(){
        if (isBusy()) return;

        uiState = UI_STATE.OPENING;
        const mainBtn = document.getElementById("open-pack-btn");
        mainBtn.disabled = true;

        openOverlay();
        showReel();
        hardResetTicks();

        const winningCt = pickWeightedCardIndex();
        const rarityNum = CARD_RARITY_BY_INDEX[winningCt] ?? 0;
        const rarityKey = rarityKeyFromNum(rarityNum);
        const imgSrc = CARD_IMAGE_BY_INDEX[winningCt] ?? CARD_IMAGE_BY_INDEX[0];
        const name = CARD_NAME_BY_INDEX[winningCt] || ("Card");
        const tokenId = nextLocalTokenId();
        const ts = Date.now();

        currentOpen = { winningCt, rarityNum, rarityKey, imgSrc, name, tokenId, ts };

        const reelItems = buildReelItems(winningCt);
        renderReel(reelItems);

        await sleep(60);
        await spinToStop();

        playSound(sfxReveal);
        if (rarityKey === "LEGENDARY") playSound(sfxLegendary);

        commitToCollection();
        fillResultUI();

        uiState = UI_STATE.RESULT;

        document.getElementById("open-another").disabled = false;

        // ‚úÖ switch UI states (hide skip/show close)
        showResult();

        setStatus("Pack ouvert ‚úÖ Carte ajout√©e √† ta collection.", "ok");
        mainBtn.disabled = false;
      }

      async function flyThenOpenAnother(){
        hardResetTicks();

        const imgwrap = document.getElementById("result-imgwrap");
        imgwrap.classList.add("fly-out");
        await sleep(850);
        imgwrap.classList.remove("fly-out");

        uiState = UI_STATE.IDLE;
        await openPackRoulette();
      }

      function openCollectionFiltered(cardTypeIndex){
        window.location.href = "collection.html?ct=" + encodeURIComponent(String(cardTypeIndex));
      }

      function resetAllData(){
        localStorage.removeItem(VS_COLLECTION_KEY);
        localStorage.removeItem(VS_TOKEN_COUNTER_KEY);
        setStatus("Donn√©es reset ‚úÖ", "ok");
        renderStats();
        renderHistory();
      }

      /* Hover preview float */
      function setPreview({ img, name, rarity }){
        const box = document.getElementById("preview-float");
        document.getElementById("preview-img").src = img || "";
        document.getElementById("preview-name").textContent = name || "‚Äî";
        const tag = document.getElementById("preview-tag");
        tag.textContent = rarity || "COMMON";
        tag.className = "pf-tag " + String(rarity || "COMMON").toLowerCase();
        box.classList.add("on");
        box.setAttribute("aria-hidden","false");
      }
      function clearPreview(){
        const box = document.getElementById("preview-float");
        box.classList.remove("on");
        box.setAttribute("aria-hidden","true");
      }

      document.addEventListener("DOMContentLoaded", () => {
        sfxBooster = document.getElementById("sfx-booster");
        sfxReveal = document.getElementById("sfx-reveal");
        sfxLegendary = document.getElementById("sfx-legendary");
        sfxTickSrc = document.getElementById("sfx-tick");

        try{
          const src = sfxTickSrc ? sfxTickSrc.getAttribute("src") : null;
          if (src){
            tickA = new Audio(src);
            tickB = new Audio(src);
            tickA.preload = "auto";
            tickB.preload = "auto";
            tickA.volume = 0.55;
            tickB.volume = 0.55;
          }
        }catch(_){}

        renderStats();
        renderHistory();

        document.getElementById("open-pack-btn").addEventListener("click", openPackRoulette);

        document.getElementById("open-skip").addEventListener("click", () => {
          skipSpinNow();
        });

        document.getElementById("open-another").addEventListener("click", async () => {
          await flyThenOpenAnother();
        });

        document.getElementById("result-open-another").addEventListener("click", async () => {
          await flyThenOpenAnother();
        });

        document.getElementById("open-close").addEventListener("click", () => {
          if (spinning) return;
          closeOverlay();
          uiState = UI_STATE.IDLE;
          hardResetTicks();
        });

        document.addEventListener("keydown", (e) => {
          if (e.key !== "Escape") return;
          const overlay = document.getElementById("open-overlay");
          if (overlay.classList.contains("on") && !spinning && uiState === UI_STATE.RESULT){
            closeOverlay();
            uiState = UI_STATE.IDLE;
            hardResetTicks();
          }
        });

        document.getElementById("reset-data").addEventListener("click", resetAllData);
        document.getElementById("clear-history").addEventListener("click", () => {
          localStorage.removeItem(VS_COLLECTION_KEY);
          setStatus("History cleared ‚úÖ", "ok");
          renderStats();
          renderHistory();
        });

        document.querySelectorAll(".drop-item").forEach((el) => {
          const img = el.getAttribute("data-img");
          const name = el.getAttribute("data-name");
          const rarity = el.getAttribute("data-rarity");
          const ct = el.getAttribute("data-ct");

          let timer = null;

          el.addEventListener("mouseenter", () => {
            timer = setTimeout(() => setPreview({ img, name, rarity }), 90);
          });
          el.addEventListener("mouseleave", () => {
            if (timer) clearTimeout(timer);
            clearPreview();
          });

          el.addEventListener("click", (e) => {
            e.preventDefault();
            clearPreview();
            openCollectionFiltered(ct);
          });
        });
      });
    </script>
  </body>
</html>
