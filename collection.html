<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>VaultSpin – Collection</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }

      body{
        min-height:100vh;
        background: radial-gradient(circle at top, #101827, #020617 60%);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color:#e5e7eb;
      }

      .wrap{
        width:100%;
        max-width:1200px;
        margin:0 auto;
        padding:90px 16px 50px;
        display:flex;
        flex-direction:column;
        gap:16px;
      }

      /* Top bar */
      .top-bar{
        position:fixed;
        top:16px;
        left:50%;
        transform:translateX(-50%);
        width:100%;
        max-width:1200px;
        display:flex;
        justify-content:space-between;
        align-items:center;
        padding:0 16px;
        z-index:30;
        pointer-events:none;
      }
      .top-left,.top-right{
        pointer-events:auto;
        display:flex;
        align-items:center;
        gap:10px;
        flex-wrap:wrap;
      }
      .top-logo{
        font-size:12px;
        letter-spacing:.22em;
        text-transform:uppercase;
        color:#9ca3af;
      }
      .pill{
        border-radius:999px;
        border:1px solid rgba(148,163,184,.22);
        background: rgba(15,23,42,.55);
        padding:8px 12px;
        font-size:11px;
        letter-spacing:.14em;
        text-transform:uppercase;
        color:#e5e7eb;
        cursor:default;
      }
      .btn{
        border-radius:999px;
        border:1px solid rgba(148,163,184,.22);
        background: rgba(15,23,42,.55);
        padding:9px 12px;
        font-size:11px;
        letter-spacing:.14em;
        text-transform:uppercase;
        color:#e5e7eb;
        cursor:pointer;
        transition: box-shadow .15s ease-out, transform .15s ease-out, border-color .15s ease-out, opacity .15s ease-out;
      }
      .btn:hover{
        transform: translateY(-1px);
        border-color: rgba(165,180,252,.7);
        box-shadow: 0 0 12px rgba(129,140,248,.25);
      }
      .btn.primary{
        border:none;
        background: radial-gradient(circle at top left, #a855f7, #4f46e5);
        box-shadow: 0 0 18px rgba(168,85,247,.35);
      }
      .btn.primary:hover{
        box-shadow: 0 0 22px rgba(168,85,247,.55);
      }

      /* Header cards */
      .panel{
        background: radial-gradient(circle at top left, #020617, #020617 70%);
        border-radius:26px;
        border: 1px solid rgba(148,163,184,.20);
        padding:18px;
        display:flex;
        flex-direction:column;
        gap:14px;
      }

      .title-row{
        display:flex;
        justify-content:space-between;
        align-items:flex-start;
        gap:12px;
        flex-wrap:wrap;
      }

      h1{
        font-size:22px;
        font-weight:800;
        letter-spacing:.10em;
        text-transform:uppercase;
        color:#f9fafb;
      }
      .sub{
        font-size:13px;
        color:#9ca3af;
        line-height:1.4;
        max-width:760px;
        margin-top:4px;
      }

      .controls{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        align-items:center;
      }

      .filters{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        align-items:center;
        padding-top:4px;
      }

      .input{
        width:min(520px, 100%);
        border-radius:999px;
        border:1px solid rgba(148,163,184,.20);
        background: rgba(15,23,42,.40);
        padding:10px 12px;
        color:#e5e7eb;
        outline:none;
        font-size:13px;
      }

      select{
        border-radius:999px;
        border:1px solid rgba(148,163,184,.20);
        background: rgba(15,23,42,.40);
        padding:10px 12px;
        color:#e5e7eb;
        outline:none;
        font-size:13px;
      }

      .stats-row{
        display:flex;
        flex-wrap:wrap;
        gap:10px;
      }

      .stat{
        border-radius:18px;
        border:1px solid rgba(148,163,184,.14);
        background: rgba(2,6,23,.28);
        padding:12px;
        min-width:200px;
        flex:1;
      }
      .stat .k{
        font-size:10px;
        letter-spacing:.16em;
        text-transform:uppercase;
        color:#9ca3af;
      }
      .stat .v{
        margin-top:6px;
        font-size:18px;
        font-weight:900;
        color:#f9fafb;
      }
      .stat .s{
        margin-top:3px;
        font-size:12px;
        color:#9ca3af;
      }

      /* LISTE VERTICALE */
      .grid{
        display:flex;
        flex-direction:column;
        gap:12px;
      }

      /* Cards en “row” */
      .card{
        border-radius:20px;
        border:1px solid rgba(148,163,184,.18);
        background: rgba(15,23,42,.28);
        padding:10px;
        display:flex;
        flex-direction:row;
        gap:12px;
        align-items:stretch;
        transition: transform .15s ease-out, box-shadow .15s ease-out, border-color .15s ease-out;
        cursor:default;
        user-select:none;
      }
      .card:hover{
        transform: translateY(-2px);
        border-color: rgba(165,180,252,.55);
        box-shadow: 0 0 16px rgba(129,140,248,.18);
      }

      /* Thumb fixe */
      .thumb{
        width:92px;
        flex:0 0 auto;
        aspect-ratio: 3 / 4;
        border-radius:16px;
        overflow:hidden;
        border:1px solid rgba(148,163,184,.18);
        background: rgba(2,6,23,.55);
      }
      .thumb img{
        width:100%;
        height:100%;
        object-fit:contain;
        object-position:center;
        display:block;
        padding:6px;
        background: transparent;
      }

      .meta{
        flex:1;
        display:flex;
        justify-content:space-between;
        align-items:flex-start;
        gap:10px;
        min-width:0;
      }

      .name{
        font-size:11px;
        letter-spacing:.10em;
        text-transform:uppercase;
        font-weight:900;
        color:#f9fafb;
        line-height:1.2;
        min-width:0;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
        max-width:100%;
      }
      .ct{
        font-size:11px;
        color:#9ca3af;
        margin-top:6px;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }
      .price{
        margin-top:6px;
        font-size:11px;
        color:#cbd5e1;
        letter-spacing:.06em;
      }

      .badges{
        display:flex;
        flex-direction:column;
        gap:8px;
        align-items:flex-end;
        flex:0 0 auto;
      }

      .tag{
        font-size:10px;
        letter-spacing:.14em;
        text-transform:uppercase;
        font-weight:900;
        padding:6px 9px;
        border-radius:999px;
        border:1px solid rgba(148,163,184,.16);
        background: rgba(2,6,23,.35);
        white-space:nowrap;
      }

      .tag.epic{ color:#38bdf8; }
      .tag.ultra{ color:#a855f7; }
      .tag.legendary{ color:#f97316; }
      .tag.hidden{ color:#9ca3af; }

      .tag.pack{
        border-color: rgba(148,163,184,.20);
        background: rgba(15,23,42,.55);
        color:#e5e7eb;
      }

      .owned{
        font-size:10px;
        letter-spacing:.14em;
        text-transform:uppercase;
        padding:6px 9px;
        border-radius:999px;
        border:1px solid rgba(148,163,184,.18);
        background: rgba(15,23,42,.35);
        color:#e5e7eb;
        cursor:pointer;
      }
      .owned:hover{
        border-color: rgba(165,180,252,.7);
        box-shadow: 0 0 10px rgba(129,140,248,.18);
      }

      .hint{
        font-size:12px;
        color:#9ca3af;
        line-height:1.45;
      }

      /* Modal preview */
      .modal{
        position:fixed;
        inset:0;
        display:none;
        align-items:center;
        justify-content:center;
        z-index:80;
        background: rgba(0,0,0,.55);
        backdrop-filter: blur(10px);
        padding:16px;
      }
      .modal.on{ display:flex; }
      .modal-card{
        width: min(430px, 92vw);
        border-radius:24px;
        border:1px solid rgba(148,163,184,.20);
        background: rgba(2,6,23,.86);
        box-shadow: 0 0 34px rgba(0,0,0,.5);
        padding:14px;
        position:relative;
        animation: popIn 140ms ease-out;
      }
      @keyframes popIn{ from{ transform:scale(.985); opacity:0; } to{ transform:scale(1); opacity:1; } }

      .modal-img{
        width:100%;
        aspect-ratio:3/4;
        border-radius:18px;
        overflow:hidden;
        border:1px solid rgba(148,163,184,.22);
        background: rgba(2,6,23,.55);
      }
      .modal-img img{
        width:100%;
        height:100%;
        object-fit:contain;
        object-position:center;
        display:block;
        padding:10px;
        background: transparent;
      }

      .modal-meta{
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap:10px;
        margin-top:10px;
      }
      .modal-name{
        font-size:12px;
        letter-spacing:.12em;
        text-transform:uppercase;
        font-weight:900;
        color:#e5e7eb;
        min-width:0;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }
      .modal-tag{
        font-size:11px;
        letter-spacing:.14em;
        text-transform:uppercase;
        padding:6px 10px;
        border-radius:999px;
        border:1px solid rgba(148,163,184,.20);
        background: rgba(15,23,42,.55);
        color:#e5e7eb;
        white-space:nowrap;
      }
      .modal-price{
        margin-top:10px;
        font-size:12px;
        color:#cbd5e1;
        letter-spacing:.08em;
      }

      .modal-close{
        position:absolute;
        right:10px;
        top:10px;
        border:1px solid rgba(148,163,184,.20);
        background: rgba(15,23,42,.55);
        color:#e5e7eb;
        border-radius:999px;
        padding:8px 10px;
        cursor:pointer;
        font-size:12px;
      }
      .modal-close:hover{
        border-color: rgba(165,180,252,.7);
        box-shadow: 0 0 10px rgba(129,140,248,.25);
      }

      .chip{
        display:inline-flex;
        align-items:center;
        gap:8px;
        border-radius:999px;
        border:1px solid rgba(148,163,184,.20);
        background: rgba(15,23,42,.40);
        padding:8px 12px;
        font-size:11px;
        color:#e5e7eb;
      }
      .chip strong{ color:#f9fafb; }
      .chip a{ color:#a5b4fc; text-decoration: underline; }
      .chip a:hover{ color:#c4b5fd; }

      .top-link{
        font-size:12px;
        padding:6px 10px;
        height:34px;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        border-radius:999px;
        border:1px solid rgba(148,163,184,.45);
        color:#e5e7eb;
        text-decoration:none;
        letter-spacing:.14em;
        text-transform:uppercase;
        background:rgba(15,23,42,.85);
      }
      .top-link:hover{
        border-color:#a5b4fc;
        box-shadow:0 0 10px rgba(129,140,248,.4);
      }

      @media (max-width: 520px){
        .card{ gap:10px; }
        .thumb{ width:84px; }
        .ct{ white-space:normal; }
      }
    </style>
  </head>

  <body>
    <!-- Top bar -->
    <div class="top-bar">
      <div class="top-left">
        <div class="top-logo">VAULTSPIN · COLLECTION</div>
        <div class="pill" id="filter-pill" style="display:none;"></div>
      </div>
      <div class="top-right">
        <a class="top-link" href="leaderboard.html">Leaderboard</a>
        <span id="vs-user-email" class="top-link" style="display:none; max-width:220px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">—</span>
        <a id="vs-login-btn" class="top-link" href="login.html">Connexion</a>
        <button class="btn" id="vs-logout-btn" style="display:none;">Déconnexion</button>

        <button class="btn" id="back-packs">Retour packs</button>
        <button class="btn primary" id="clear-filter" style="display:none;">Clear filter</button>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true">
        <button class="modal-close" id="modal-close">✕</button>
        <div class="modal-img">
          <img id="modal-img" src="" alt="Preview" />
        </div>
        <div class="modal-meta">
          <div class="modal-name" id="modal-name">—</div>
          <div class="modal-tag" id="modal-tag" style="display:none;">—</div>
        </div>
        <div class="modal-price" id="modal-price">Valeur estimée : —</div>
      </div>
    </div>

    <div class="wrap">
      <div class="panel">
        <div class="title-row">
          <div>
            <h1>Ma collection</h1>
            <div class="sub">
              Vue “Stacks” : groupé par <b>pack</b> + <b>cardTypeIndex</b>.
              Clique sur <b>Owned</b> pour filtrer. Filtre aussi via <b>?pack=PLANT|WATER|FIRE&ct=</b>.
              <br/>
              ✅ Source of truth = Supabase <b>user_cards</b> (si connecté). Sinon fallback localStorage (démo).
            </div>
          </div>

          <div class="controls">
            <button class="btn" id="export-json">Export JSON</button>
            <button class="btn" id="reset-data">Reset data (local)</button>
          </div>
        </div>

        <div class="filters">
          <input class="input" id="search" placeholder="Search (pack / rarity / index / name / price)..." />

          <select id="pack">
            <option value="ALL">Pack: All</option>
            <option value="PLANT">Pack: PLANT</option>
            <option value="WATER">Pack: WATER</option>
            <option value="FIRE">Pack: FIRE</option>
          </select>

          <select id="rarity">
            <option value="ALL">Rarity: All</option>
            <option value="LEGENDARY">Rarity: LEGENDARY</option>
            <option value="ULTRA">Rarity: ULTRA</option>
            <option value="EPIC">Rarity: EPIC</option>
            <option value="HIDDEN">Rarity: HIDDEN</option>
          </select>

          <select id="sort">
            <option value="rarity_desc">Sort: rarity ↓</option>
            <option value="rarity_asc">Sort: rarity ↑</option>
            <option value="owned_desc">Sort: owned ↓</option>
            <option value="owned_asc">Sort: owned ↑</option>
            <option value="price_desc">Sort: price ↓</option>
            <option value="price_asc">Sort: price ↑</option>
            <option value="index_asc">Sort: index ↑</option>
            <option value="index_desc">Sort: index ↓</option>
          </select>
        </div>

        <div class="stats-row">
          <div class="stat">
            <div class="k">Total items</div>
            <div class="v" id="stat-total">0</div>
            <div class="s">NFTs enregistrés</div>
          </div>
          <div class="stat">
            <div class="k">Unique stacks</div>
            <div class="v" id="stat-unique">0</div>
            <div class="s">pack + cardTypeIndex distincts</div>
          </div>
          <div class="stat">
            <div class="k">Best pull</div>
            <div class="v" id="stat-best">—</div>
            <div class="s" id="stat-best-sub">—</div>
          </div>
          <div class="stat">
            <div class="k">Vault value</div>
            <div class="v" id="stat-vault">0€</div>
            <div class="s">Somme (DB: estimated_value_eur)</div>
          </div>
        </div>

        <div class="hint" id="hint">
          Astuce : clique sur une carte pour la voir en grand.
        </div>
      </div>

      <div class="panel">
        <div class="chip" id="empty-state" style="display:none;">
          Aucune carte pour l’instant. Retourne ouvrir un pack sur
          <a href="index.html">la page packs</a>.
        </div>

        <div class="grid" id="grid"></div>
      </div>
    </div>

    <script type="module">
      import { supabase } from "./js/supabaseClient.js";

      /********************
       * STORAGE (fallback)
       ********************/
      const VS_COLLECTION_KEY = "vaultspin_collection_v1";

      /********************
       * Catalog (OPTIONNEL)
       * - Sert seulement de fallback d’affichage si DB n’a pas image_url/card_name.
       ********************/
      const CATALOG = {
        PLANT: {
          0:  { name:"Phyllali PCA",   img:"images/phyllali_PCA.png" },
          1:  { name:"Aéromite",       img:"images/aeromite.png" },
          2:  { name:"Germignon",      img:"images/germignon.png" },
          3:  { name:"Astronelle",     img:"images/astronelle.png" },
          4:  { name:"Chétiflor",      img:"images/chetiflor.png" },
          5:  { name:"Jungko",         img:"images/jungko.png" },
          6:  { name:"Chenipan",       img:"images/chenipan.png" },
          7:  { name:"Énergie Plante", img:"images/energie_plante.png" },
          8:  { name:"Majaspic",       img:"images/majaspic.png" },
          9:  { name:"Mimitoss",       img:"images/mimitoss.png" },
          10: { name:"Florizarre",     img:"images/florizarre.png" },
          11: { name:"Nidoking",       img:"images/nidoking.png" },
          12: { name:"Noeufnoeuf",     img:"images/noeufnoeuf.png" },
          13: { name:"Paras",          img:"images/paras.png" },
          14: { name:"Phyllali",       img:"images/phyllali.png" },
          15: { name:"Boskara",        img:"images/boskara.png" },
          16: { name:"Filentrappe",    img:"images/filentrappe.png" },
          17: { name:"Peterson",       img:"images/peterson.png" },
          18: { name:"Scovilain",      img:"images/scovilain.png" }
        },
        WATER: {
          // fallback optionnel (DB fournit déjà card_name/image_url normalement)
        },
        FIRE: {
          // fallback optionnel (DB fournit déjà card_name/image_url normalement)
        }
      };

      function catalogFor(packKey, ct){
        const pk = (packKey || "PLANT").toUpperCase();
        return (CATALOG[pk] && CATALOG[pk][Number(ct)]) ? CATALOG[pk][Number(ct)] : null;
      }

      /********************
       * Pack inference (IMPORTANT)
       * - Si pack_key n’existe pas en DB (anciens inserts), on guess via ct.
       * - Convention recommandée:
       *    PLANT: 0..99
       *    WATER: 100..199
       *    FIRE : 200..299 (ou 200+)
       ********************/
      function guessPackKeyFromCt(ct){
        const n = Number(ct);
        if (!Number.isFinite(n)) return "PLANT";
        if (n >= 200) return "FIRE";
        if (n >= 100) return "WATER";
        return "PLANT";
      }

      function normalizePackKey(input, ct){
        const raw = String(input || "").trim().toLowerCase();

        // support "plant|water|fire" (boosterKey index.html)
        if (raw === "plant") return "PLANT";
        if (raw === "water") return "WATER";
        if (raw === "fire")  return "FIRE";

        // support "PLANT|WATER|FIRE"
        const up = String(input || "").trim().toUpperCase();
        if (up === "PLANT" || up === "WATER" || up === "FIRE") return up;

        // fallback: infer from ct
        return guessPackKeyFromCt(ct);
      }

      /********************
       * Formatting
       ********************/
      function fmtEur(n){
        return (Number(n) || 0).toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " €";
      }
      function fmtDate(ts){
        const d = new Date(ts);
        return d.toLocaleString("fr-FR", { day:"2-digit", month:"2-digit", year:"2-digit", hour:"2-digit", minute:"2-digit" });
      }

      function escapeHtml(s){
        return String(s || "").replace(/[&<>"']/g, (c) => ({
          "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
        }[c]));
      }
      function escapeAttr(s){
        return String(s || "").replace(/"/g, "&quot;");
      }

      /********************
       * URL filters
       ********************/
      function getFiltersFromUrl(){
        const p = new URLSearchParams(window.location.search);
        const ctRaw = p.get("ct");
        const pack = (p.get("pack") || "").toUpperCase();
        const ct = ctRaw === null ? null : Number(ctRaw);

        const packOk = (pack === "PLANT" || pack === "WATER" || pack === "FIRE") ? pack : null;
        const ctOk = (ctRaw === null) ? null : (Number.isFinite(ct) ? ct : null);

        return { pack: packOk, ct: ctOk };
      }

      function setPackCtInUrl(pack, ct){
        const url = new URL(window.location.href);
        if (pack) url.searchParams.set("pack", String(pack).toUpperCase());
        else url.searchParams.delete("pack");

        if (ct !== null && ct !== undefined) url.searchParams.set("ct", String(ct));
        else url.searchParams.delete("ct");

        window.location.href = url.toString();
      }

      function clearFilterInUrl(){
        const url = new URL(window.location.href);
        url.searchParams.delete("pack");
        url.searchParams.delete("ct");
        window.location.href = url.toString();
      }

      /********************
       * Rarity helpers (DB authoritative)
       ********************/
      const RARITY_ORDER = ["HIDDEN","EPIC","ULTRA","LEGENDARY"]; // for sorting
      function rarityRank(k){
        const kk = (k || "").toUpperCase();
        const i = RARITY_ORDER.indexOf(kk);
        return i === -1 ? 0 : i;
      }
      function rarityClass(k){
        const kk = (k || "").toUpperCase();
        if (kk === "LEGENDARY") return "legendary";
        if (kk === "ULTRA") return "ultra";
        if (kk === "EPIC") return "epic";
        if (kk === "HIDDEN") return "hidden";
        return "";
      }

      /********************
       * Modal
       ********************/
      function openModal({ img, name, rarity, price }){
        document.getElementById("modal-img").src = img || "";
        document.getElementById("modal-name").textContent = name || "—";

        const tag = document.getElementById("modal-tag");
        if (rarity){
          tag.style.display = "inline-flex";
          tag.textContent = rarity;
        } else {
          tag.style.display = "none";
          tag.textContent = "";
        }

        document.getElementById("modal-price").textContent = "Valeur estimée : " + fmtEur(price || 0);

        const modal = document.getElementById("modal");
        modal.classList.add("on");
        modal.setAttribute("aria-hidden", "false");
      }
      function closeModal(){
        const modal = document.getElementById("modal");
        modal.classList.remove("on");
        modal.setAttribute("aria-hidden", "true");
      }

      /********************
       * Data (DB-first)
       ********************/
      let SOURCE = "local"; // "db" | "local"
      let CARDS = [];       // normalized list

      function getLocalCollection(){
        try { return JSON.parse(localStorage.getItem(VS_COLLECTION_KEY) || "[]"); }
        catch { return []; }
      }

      function normalizeFromLocal(localArr){
        // local schema (démo): { tokenId, ts, priceEur/valueEur, rarityKey, cardTypeIndex, img, name, boosterKey }
        return (localArr || []).map(x => {
          const ct = Number(x.cardTypeIndex ?? -1);
          const packKey = normalizePackKey((x.pack_key || x.boosterKey || x.pack || ""), ct);
          return {
            source: "local",
            dbId: null,
            pack_key: packKey,
            tokenId: x.tokenId ?? null,
            ts: x.ts ?? Date.now(),
            cardTypeIndex: ct,
            rarity_key: (x.rarityKey || x.rarity_key || "").toUpperCase() || null,
            img: x.img || "",
            name: x.name || "",
            estimated_value_eur: Number(x.priceEur ?? x.valueEur ?? x.estimated_value_eur ?? 0) || 0
          };
        }).filter(x => Number.isFinite(x.cardTypeIndex) && x.cardTypeIndex >= 0);
      }

      function normalizeFromDb(rows){
        // db schema: user_cards: { id, token_id, pack_key, card_type_index, rarity_key, image_url, card_name, estimated_value_eur, opened_at }
        return (rows || []).map(r => {
          const ct = Number(r.card_type_index ?? -1);
          const packKey = normalizePackKey(r.pack_key, ct);

          const cat = catalogFor(packKey, ct);
          const ts = r.opened_at ? new Date(r.opened_at).getTime() : Date.now();

          return {
            source: "db",
            dbId: r.id,
            pack_key: packKey,
            tokenId: r.token_id ?? null,
            ts,
            cardTypeIndex: ct,
            rarity_key: (r.rarity_key || "").toUpperCase() || null,
            img: r.image_url || (cat && cat.img) || "",
            name: r.card_name || (cat && cat.name) || ("Card #" + ct),
            estimated_value_eur: Number(r.estimated_value_eur ?? 0) || 0
          };
        }).filter(x => Number.isFinite(x.cardTypeIndex) && x.cardTypeIndex >= 0);
      }

      async function fetchDbCards(){
        const { data: { session } } = await supabase.auth.getSession();
        if (!session?.user) return null;

        const { data, error } = await supabase
          .from("user_cards")
          .select("id, token_id, pack_key, card_type_index, rarity_key, image_url, card_name, estimated_value_eur, opened_at")
          .order("opened_at", { ascending:false })
          .limit(5000);

        if (error) throw error;
        return data || [];
      }

      function vaultValue(items){
        let sum = 0;
        for (const x of items){
          sum += Number(x.estimated_value_eur || 0) || 0;
        }
        return sum;
      }

      function bestPull(items){
        if (!items.length) return null;
        let best = items[0];
        for (const c of items){
          const aR = rarityRank(c.rarity_key);
          const bR = rarityRank(best.rarity_key);
          if (aR > bR) best = c;
          else if (aR === bR){
            const ap = Number(c.estimated_value_eur || 0) || 0;
            const bp = Number(best.estimated_value_eur || 0) || 0;
            if (ap > bp) best = c;
          }
        }
        return best;
      }

      function groupByStack(items){
        const map = new Map();

        for (const x of items){
          const ct = Number(x.cardTypeIndex ?? -1);
          if (!Number.isFinite(ct) || ct < 0) continue;

          const pk = normalizePackKey(x.pack_key, ct);
          const key = pk + ":" + String(ct);

          if (!map.has(key)){
            map.set(key, {
              key,
              pack_key: pk,
              cardTypeIndex: ct,
              img: x.img || "",
              name: x.name || ("Card #" + ct),
              owned: 0,
              lastTs: 0,
              lastTokenId: null,
              price: Number(x.estimated_value_eur || 0) || 0,
              rarity_key: (x.rarity_key || "").toUpperCase() || null
            });
          }

          const g = map.get(key);
          g.owned += 1;

          const ts = Number(x.ts || 0) || 0;
          if (ts > g.lastTs){
            g.lastTs = ts;
            g.lastTokenId = x.tokenId ?? null;
          }

          const px = Number(x.estimated_value_eur || 0) || 0;
          if (px > g.price) g.price = px;

          const rk = (x.rarity_key || "").toUpperCase();
          if (rk && rarityRank(rk) > rarityRank(g.rarity_key)) g.rarity_key = rk;

          if (!g.img && x.img) g.img = x.img;
          if ((!g.name || g.name.startsWith("Card #")) && x.name) g.name = x.name;
        }

        return Array.from(map.values());
      }

      /********************
       * UI source hint
       ********************/
      function setSourceChip(){
        const hint = document.getElementById("hint");
        hint.innerHTML = SOURCE === "db"
          ? `✅ Source : <b>Supabase</b> (user_cards).`
          : `ℹ️ Source : <b>localStorage</b> (démo). Connecte-toi pour voir ta vraie collection (multi-device).`;
      }

      /********************
       * Rendering
       ********************/
      function render(){
        const grid = document.getElementById("grid");
        const empty = document.getElementById("empty-state");

        const search = (document.getElementById("search").value || "").trim().toLowerCase();
        const sort = document.getElementById("sort").value;

        const packSel = (document.getElementById("pack").value || "ALL").toUpperCase();
        const raritySel = (document.getElementById("rarity").value || "ALL").toUpperCase();

        const urlFilters = getFiltersFromUrl();
        const ctFilter = urlFilters.ct;
        const packFilterFromUrl = urlFilters.pack;

        let items = CARDS.slice();

        // Apply pack dropdown + URL pack
        if (packFilterFromUrl){
          items = items.filter(x => normalizePackKey(x.pack_key, x.cardTypeIndex) === packFilterFromUrl);
        } else if (packSel !== "ALL"){
          items = items.filter(x => normalizePackKey(x.pack_key, x.cardTypeIndex) === packSel);
        }

        // Apply rarity dropdown
        if (raritySel !== "ALL"){
          items = items.filter(x => (x.rarity_key || "").toUpperCase() === raritySel);
        }

        // Apply ct from URL
        if (ctFilter !== null){
          items = items.filter(x => Number(x.cardTypeIndex) === ctFilter);
        }

        // Stats
        document.getElementById("stat-total").textContent = String(items.length);
        document.getElementById("stat-vault").textContent =
          (vaultValue(items)).toLocaleString("fr-FR", { maximumFractionDigits: 2 }) + "€";

        const best = bestPull(items);
        if (best){
          document.getElementById("stat-best").textContent = (best.rarity_key || "—");
          document.getElementById("stat-best-sub").textContent =
            `${normalizePackKey(best.pack_key, best.cardTypeIndex)} · ct ${best.cardTypeIndex} · ${fmtDate(best.ts || Date.now())}`;
        } else {
          document.getElementById("stat-best").textContent = "—";
          document.getElementById("stat-best-sub").textContent = "—";
        }

        // Group stacks
        let stacks = groupByStack(items);
        document.getElementById("stat-unique").textContent = String(stacks.length);

        // Search
        if (search){
          stacks = stacks.filter(s => {
            const hay = [
              s.pack_key,
              String(s.cardTypeIndex),
              (s.name || "").toLowerCase(),
              (s.rarity_key || "").toLowerCase(),
              String(s.price || 0),
              "owned " + String(s.owned),
            ].join(" ");
            return hay.includes(search);
          });
        }

        // Sort
        stacks.sort((a,b) => {
          const ra = rarityRank(a.rarity_key);
          const rb = rarityRank(b.rarity_key);

          if (sort === "rarity_desc") return (rb - ra) || (b.price - a.price) || (b.owned - a.owned);
          if (sort === "rarity_asc") return (ra - rb) || (b.price - a.price) || (b.owned - a.owned);

          if (sort === "owned_desc") return (b.owned - a.owned) || (rb - ra) || (b.price - a.price);
          if (sort === "owned_asc") return (a.owned - b.owned) || (rb - ra) || (b.price - a.price);

          if (sort === "price_desc") return (b.price - a.price) || (rb - ra) || (b.owned - a.owned);
          if (sort === "price_asc") return (a.price - b.price) || (rb - ra) || (b.owned - a.owned);

          if (sort === "index_desc") return b.cardTypeIndex - a.cardTypeIndex;
          return a.cardTypeIndex - b.cardTypeIndex;
        });

        // Empty state
        grid.innerHTML = "";
        empty.style.display = (!CARDS.length) ? "inline-flex" : "none";

        if (!stacks.length){
          const d = document.createElement("div");
          d.className = "chip";
          d.innerHTML = `<span>Aucun résultat.</span>`;
          grid.appendChild(d);
          return;
        }

        for (const s of stacks){
          const card = document.createElement("div");
          card.className = "card";
          card.setAttribute("data-ct", String(s.cardTypeIndex));

          const thumb = document.createElement("div");
          thumb.className = "thumb";
          thumb.innerHTML = `<img src="${escapeAttr(s.img)}" alt="${escapeAttr(s.name)}"/>`;

          const meta = document.createElement("div");
          meta.className = "meta";

          const left = document.createElement("div");
          left.style.minWidth = "0";
          left.innerHTML = `
            <div class="name">${escapeHtml(s.name)}</div>
            <div class="ct">pack: ${escapeHtml(s.pack_key)} · cardTypeIndex: ${s.cardTypeIndex} · last: #${s.lastTokenId ?? "—"} · ${s.lastTs ? fmtDate(s.lastTs) : "—"}</div>
            <div class="price">Valeur estimée : ${fmtEur(s.price)}</div>
          `;

          const badges = document.createElement("div");
          badges.className = "badges";

          // Pack badge
          const packTag = document.createElement("div");
          packTag.className = "tag pack";
          packTag.textContent = s.pack_key;
          badges.appendChild(packTag);

          // Rarity badge
          if (s.rarity_key){
            const tag = document.createElement("div");
            tag.className = "tag " + rarityClass(s.rarity_key);
            tag.textContent = s.rarity_key;
            badges.appendChild(tag);
          }

          const owned = document.createElement("button");
          owned.className = "owned";
          owned.type = "button";
          owned.textContent = "Owned · " + s.owned;
          owned.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            setPackCtInUrl(s.pack_key, s.cardTypeIndex);
          });

          badges.appendChild(owned);

          meta.appendChild(left);
          meta.appendChild(badges);

          card.appendChild(thumb);
          card.appendChild(meta);

          card.addEventListener("click", () => {
            openModal({
              img: s.img,
              name: `${s.name} (${s.pack_key} · ct ${s.cardTypeIndex})`,
              rarity: s.rarity_key || "",
              price: s.price || 0
            });
          });

          grid.appendChild(card);
        }

        // Filter pill UI
        const pill = document.getElementById("filter-pill");
        const clearBtn = document.getElementById("clear-filter");

        const activePack = packFilterFromUrl;
        const activeCt = ctFilter;

        if (activePack || activeCt !== null){
          pill.style.display = "inline-flex";
          pill.textContent = `Filter: ${activePack ? ("pack=" + activePack) : ""}${activePack && activeCt !== null ? " · " : ""}${activeCt !== null ? ("ct=" + activeCt) : ""}`;
          clearBtn.style.display = "inline-flex";
        } else {
          pill.style.display = "none";
          clearBtn.style.display = "none";
        }
      }

      /********************
       * Actions
       ********************/
      function exportJson(){
        const data = CARDS.slice();
        const blob = new Blob([JSON.stringify({ source: SOURCE, items: data }, null, 2)], { type:"application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "vaultspin_collection.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function resetLocalData(){
        localStorage.removeItem(VS_COLLECTION_KEY);
        closeModal();
        if (SOURCE === "local"){
          CARDS = normalizeFromLocal(getLocalCollection());
          render();
        }
      }

      /********************
       * Auth UI
       ********************/
      const loginBtn  = document.getElementById("vs-login-btn");
      const logoutBtn = document.getElementById("vs-logout-btn");
      const emailEl   = document.getElementById("vs-user-email");

      function setAuthed(label){
        if (emailEl){
          emailEl.style.display = "inline-flex";
          emailEl.textContent = label || "Connecté";
        }
        if (loginBtn) loginBtn.style.display = "none";
        if (logoutBtn) logoutBtn.style.display = "inline-flex";
      }
      function setNotAuthed(){
        if (emailEl){
          emailEl.style.display = "none";
          emailEl.textContent = "—";
        }
        if (loginBtn) loginBtn.style.display = "inline-flex";
        if (logoutBtn) logoutBtn.style.display = "none";
      }

      async function setAuthedFromSession(session){
        const { data, error } = await supabase
          .from("profiles")
          .select("username, display_name")
          .eq("id", session.user.id)
          .maybeSingle();

        const label = (!error && data)
          ? (data.display_name || data.username || session.user.email || "Connecté")
          : (session.user.email || "Connecté");

        setAuthed(label);
      }

      async function refreshFromDb(){
        const rows = await fetchDbCards();
        if (!rows) return;

        SOURCE = "db";
        CARDS = normalizeFromDb(rows);
        setSourceChip();
        render();
      }

      /********************
       * INIT
       ********************/
      document.addEventListener("DOMContentLoaded", async () => {
        // Nav
        document.getElementById("back-packs").addEventListener("click", () => {
          window.location.href = "index.html";
        });
        document.getElementById("clear-filter").addEventListener("click", () => {
          clearFilterInUrl();
        });

        // Actions
        document.getElementById("export-json").addEventListener("click", exportJson);
        document.getElementById("reset-data").addEventListener("click", resetLocalData);

        // Modal
        document.getElementById("modal-close").addEventListener("click", closeModal);
        document.getElementById("modal").addEventListener("click", (e) => { if (e.target.id === "modal") closeModal(); });
        document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

        // Filters
        document.getElementById("search").addEventListener("input", render);
        document.getElementById("sort").addEventListener("change", render);
        document.getElementById("pack").addEventListener("change", render);
        document.getElementById("rarity").addEventListener("change", render);

        // URL -> dropdown pack (nice UX)
        const urlF = getFiltersFromUrl();
        if (urlF.pack){
          document.getElementById("pack").value = urlF.pack;
        }

        // Fallback initial: local
        SOURCE = "local";
        CARDS = normalizeFromLocal(getLocalCollection());
        setSourceChip();
        render();

        // Auth state initial
        const { data: { session } } = await supabase.auth.getSession();
        if (session?.user){
          await setAuthedFromSession(session);
          await refreshFromDb();
        } else {
          setNotAuthed();
        }

        // React to auth changes
        supabase.auth.onAuthStateChange(async (_event, newSession) => {
          if (newSession?.user){
            await setAuthedFromSession(newSession);
            await refreshFromDb();
          } else {
            setNotAuthed();
            SOURCE = "local";
            CARDS = normalizeFromLocal(getLocalCollection());
            setSourceChip();
            render();
          }
        });

        logoutBtn?.addEventListener("click", async () => {
          await supabase.auth.signOut();
        });
      });
    </script>
  </body>
</html>
