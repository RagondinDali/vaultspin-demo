<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>VaultSpin ‚Äì Ma collection</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Ethers v6 UMD -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>

    <!-- Animations (optionnel, m√™me fichier que index) -->
    <link rel="stylesheet" href="animations.css" />

    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        min-height: 100vh;
        display: flex;
        align-items: stretch;
        justify-content: center;
        background: radial-gradient(circle at top, #101827, #020617 60%);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        color: #e5e7eb;
      }

      .page {
        width: 100%;
        max-width: 1200px;
        padding: 32px 16px 40px;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      @media (min-width: 900px) {
        .page {
          flex-direction: row;
          gap: 32px;
        }
      }

      .sidebar,
      .main {
        background: radial-gradient(circle at top left, #020617, #020617 70%);
        border-radius: 32px;
        border: 1px solid rgba(148, 163, 184, 0.2);
        padding: 24px 24px 28px;
      }

      .sidebar {
        flex: 0.85;
        display: flex;
        flex-direction: column;
        gap: 14px;
        max-width: 360px;
      }

      .main {
        flex: 1.6;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .tag {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.3);
        padding: 4px 10px;
        font-size: 10px;
        letter-spacing: 0.16em;
        text-transform: uppercase;
        color: #e5e7eb;
        background: radial-gradient(circle at top, #111827, #020617 70%);
      }

      h1 {
        font-size: 24px;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #f9fafb;
      }

      .subtitle {
        font-size: 13px;
        color: #9ca3af;
      }

      .pill {
        border-radius: 999px;
        border: 1px solid #374151;
        padding: 6px 10px;
        font-size: 11px;
        color: #e5e7eb;
        background: rgba(15, 23, 42, 0.7);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .pill span {
        opacity: 0.7;
      }

      .status-line {
        font-size: 13px;
        color: #e5e7eb;
        background: rgba(15, 23, 42, 0.6);
        border-radius: 999px;
        padding: 8px 14px;
        border: 1px solid #374151;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: #22c55e;
      }

      .status-dot.error {
        background: #f97373;
      }

      .status-dot.pending {
        background: #facc15;
      }

      .filters {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }

      .filter-select {
        background: rgba(15, 23, 42, 0.9);
        border-radius: 999px;
        border: 1px solid #4b5563;
        padding: 6px 10px;
        font-size: 12px;
        color: #e5e7eb;
        outline: none;
      }

      .filter-select:focus {
        border-color: #a855f7;
      }

      .collection-grid {
        margin-top: 8px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 14px;
      }

      .card-item {
        border-radius: 18px;
        border: 1px solid rgba(148, 163, 184, 0.3);
        background: radial-gradient(circle at top, #020617, #020617 70%);
        padding: 10px 10px 12px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .card-image-wrapper {
        border-radius: 14px;
        overflow: hidden;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: #020617;
        height: 180px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .card-image-wrapper img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .card-meta-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 11px;
      }

      .card-name {
        font-weight: 500;
      }

      .token-id-badge {
        font-size: 10px;
        opacity: 0.8;
      }

      .rarity-badge {
        font-size: 10px;
        letter-spacing: 0.14em;
        text-transform: uppercase;
      }

      .rarity-common {
        color: #facc15;
      }
      .rarity-rare {
        color: #38bdf8;
      }
      .rarity-ultra {
        color: #a855f7;
      }
      .rarity-legendary {
        color: #f97316;
      }

      .card-meta-bottom {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 10px;
        color: #9ca3af;
        margin-top: 2px;
      }

      .redeem-pill {
        border-radius: 999px;
        padding: 2px 8px;
        border: 1px solid #374151;
        font-size: 10px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .redeem-pill.badge-ok {
        border-color: #22c55e;
        color: #bbf7d0;
      }

      .redeem-pill.badge-pending {
        border-color: #facc15;
        color: #fef9c3;
      }

      .redeem-pill.badge-none {
        border-color: #4b5563;
      }

      .empty-state {
        margin-top: 16px;
        font-size: 13px;
        color: #9ca3af;
      }
    </style>
  </head>

  <body>
    <div class="page">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="tag">VAULTSPIN ¬∑ COLLECTION</div>
        <div>
          <h1>Ma collection</h1>
          <p class="subtitle">
            Visualise toutes tes cartes VaultSpin li√©es √† ton compte.
            Les cartes et statuts de redeem sont lus directement sur le contrat
            VaultSpin V4 (read-only, sans MetaMask).
          </p>
        </div>

        <div class="pill">
          <span>Contrat :</span>
          <span id="contract-short">0x6279‚Ä¶34D</span>
        </div>

        <div id="status-line" class="status-line">
          <span class="status-dot" id="status-dot"></span>
          <span id="status-text">Initialisation de la collection‚Ä¶</span>
        </div>

        <p style="font-size: 12px; color: #9ca3af; margin-top: 4px">
          Les donn√©es on-chain (rarit√©, redeem, lien physique) sont extraites
          via <code>getTokenInfo(tokenId)</code>. L‚Äôappli serveur fournit
          simplement la liste des tokenIds associ√©s √† ton compte.
        </p>
      </aside>

      <!-- Main collection area -->
      <main class="main">
        <div class="filters">
          <span style="font-size: 12px; color: #9ca3af">Filtres :</span>
          <select id="filter-rarity" class="filter-select">
            <option value="ALL">Toutes raret√©s</option>
            <option value="0">Common</option>
            <option value="1">Rare</option>
            <option value="2">Ultra</option>
            <option value="3">Legendary</option>
          </select>
          <select id="filter-redeem" class="filter-select">
            <option value="ALL">Tous statuts</option>
            <option value="PENDING">Redeem demand√©</option>
            <option value="REDEEMED">D√©j√† redeem</option>
            <option value="NONE">Aucun redeem</option>
          </select>
        </div>

        <div id="collection-grid" class="collection-grid"></div>

        <div id="empty-state" class="empty-state" style="display: none">
          Aucune carte trouv√©e pour ce compte. Ouvre un pack pour commencer ta
          collection !
        </div>
      </main>
    </div>

    <script>
      /********************
       * CONFIG CHAIN     *
       ********************/

      const CONTRACT_ADDRESS =
        "0x6279B83Fd6093c5cAf2989cc428197D7A7d7342D";

      // üëâ √Ä remplacer par ton endpoint RPC Sepolia (Infura, Alchemy...)
      // Pour une d√©mo, tu peux mettre un endpoint public.
      const SEPOLIA_RPC_URL = "https://sepolia.infura.io/v3/YOUR_INFURA_KEY";

      const CONTRACT_ABI = [
        // getTokenInfo(uint256)
        {
          inputs: [{ internalType: "uint256", name: "tokenId", type: "uint256" }],
          name: "getTokenInfo",
          outputs: [
            {
              components: [
                { internalType: "uint256", name: "tokenId", type: "uint256" },
                { internalType: "uint8", name: "rarity", type: "uint8" },
                {
                  internalType: "uint256",
                  name: "cardTypeIndex",
                  type: "uint256",
                },
                { internalType: "string", name: "cardName", type: "string" },
                { internalType: "string", name: "uri", type: "string" },
                { internalType: "bool", name: "redeemed", type: "bool" },
                { internalType: "uint256", name: "physicalId", type: "uint256" },
                { internalType: "bool", name: "redeemAsked", type: "bool" },
              ],
              internalType: "struct VaultSpin.TokenInfo",
              name: "",
              type: "tuple",
            },
          ],
          stateMutability: "view",
          type: "function",
        },
      ];

      /********************
       * ASSETS LOCAUX    *
       ********************/

      const CARD_IMAGE_BY_INDEX = {
        0: "images/bulbasaur_common.png",
        1: "images/ivysaur_common.png",
        2: "images/venusaur_common.png",
        3: "images/bulbasaur_rare.png",
        4: "images/ivysaur_rare.png",
        5: "images/venusaur_rare.png",
        6: "images/bulbasaur_ultra.png",
        7: "images/ivysaur_ultra.png",
        8: "images/venusaur_ultra.png",
        9: "images/bulbasaur_legendary.png",
        10: "images/ivysaur_legendary.png",
        11: "images/venusaur_legendary.png",
        12: "images/plant_legendary.png",
      };

      const RARITY_LABEL = {
        0: "Common",
        1: "Rare",
        2: "Ultra",
        3: "Legendary",
      };

      const RARITY_CLASS = {
        0: "rarity-common",
        1: "rarity-rare",
        2: "rarity-ultra",
        3: "rarity-legendary",
      };

      /********************
       * √âTAT FRONT       *
       ********************/

      let provider;
      let contract;
      let allCards = []; // tableau de TokenInfo enrichi (avec image, rarityNum, etc.)

      function setStatus(text, mode = "ok") {
        const statusText = document.getElementById("status-text");
        const dot = document.getElementById("status-dot");
        if (!statusText || !dot) return;

        statusText.textContent = text;
        dot.classList.remove("error", "pending");
        if (mode === "error") dot.classList.add("error");
        if (mode === "pending") dot.classList.add("pending");
      }

      function shortAddress(addr) {
        if (!addr) return "0x‚Ä¶";
        return addr.slice(0, 6) + "‚Ä¶" + addr.slice(-4);
      }

      function normalizeRarity(r) {
        if (typeof r === "number") return r;
        if (typeof r === "bigint") return Number(r);
        if (typeof r === "string" && /^\d+$/.test(r)) return parseInt(r, 10);
        return 0;
      }

      /********************
       * INIT CONTRACT    *
       ********************/

      async function initContract() {
        try {
          provider = new ethers.JsonRpcProvider(SEPOLIA_RPC_URL);
          contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);

          const contractShort = document.getElementById("contract-short");
          if (contractShort) {
            contractShort.textContent = shortAddress(CONTRACT_ADDRESS);
          }

          setStatus("Contrat charg√©. R√©cup√©ration de ta collection‚Ä¶", "pending");
        } catch (err) {
          console.error(err);
          setStatus("Erreur d'initialisation du contrat.", "error");
        }
      }

      /********************
       * CHARGEMENT DATA  *
       ********************/

      async function fetchUserTokenIds() {
        // üëâ C'est ici que tu branches ton backend.
        // Le backend conna√Æt l'utilisateur (session / token / email),
        // et renvoie la liste de tokenIds associ√©s √† son compte.
        //
        // Exemple (pseudo-code c√¥t√© front) :
        // const res = await fetch("/api/my-tokens");
        // const data = await res.json(); // ex: { tokenIds: [1, 2, 5, 9] }
        // return data.tokenIds;
        //
        // Pour la d√©mo, on met des tokenIds en dur :
        return [1, 2, 3, 4, 5]; // <-- √Ä remplacer par ta vraie source
      }

      async function loadCollection() {
        if (!contract) return;

        try {
          const tokenIds = await fetchUserTokenIds();

          if (!tokenIds || tokenIds.length === 0) {
            setStatus("Aucun NFT associ√© √† ce compte.", "ok");
            document.getElementById("empty-state").style.display = "block";
            return;
          }

          const infos = [];
          for (const id of tokenIds) {
            try {
              const info = await contract.getTokenInfo(id);
              // info = { tokenId, rarity, cardTypeIndex, cardName, uri, redeemed, physicalId, redeemAsked }
              const rarityNum = normalizeRarity(info.rarity);
              const cardTypeIdx = Number(info.cardTypeIndex);
              const img =
                CARD_IMAGE_BY_INDEX[cardTypeIdx] || "images/venusaur_common.png";

              infos.push({
                tokenId: Number(info.tokenId),
                rarityNum,
                cardTypeIndex: cardTypeIdx,
                cardName: info.cardName,
                uri: info.uri,
                redeemed: info.redeemed,
                physicalId: Number(info.physicalId || 0),
                redeemAsked: info.redeemAsked,
                image: img,
              });
            } catch (errInner) {
              console.warn("Erreur getTokenInfo pour tokenId", id, errInner);
            }
          }

          allCards = infos;
          setStatus(
            "Collection charg√©e : " + allCards.length + " carte(s) trouv√©e(s).",
            "ok"
          );
          renderCollection();
        } catch (err) {
          console.error(err);
          setStatus("Erreur lors du chargement de la collection.", "error");
        }
      }

      /********************
       * RENDER           *
       ********************/

      function renderCollection() {
        const grid = document.getElementById("collection-grid");
        const empty = document.getElementById("empty-state");
        const rarityFilter = document.getElementById("filter-rarity").value;
        const redeemFilter = document.getElementById("filter-redeem").value;

        grid.innerHTML = "";

        let filtered = [...allCards];

        // Filtre raret√©
        if (rarityFilter !== "ALL") {
          const rnum = parseInt(rarityFilter, 10);
          filtered = filtered.filter((c) => c.rarityNum === rnum);
        }

        // Filtre redeem
        if (redeemFilter !== "ALL") {
          filtered = filtered.filter((c) => {
            if (redeemFilter === "PENDING") return c.redeemAsked && !c.redeemed;
            if (redeemFilter === "REDEEMED") return c.redeemed;
            if (redeemFilter === "NONE")
              return !c.redeemAsked && !c.redeemed && c.physicalId !== 0;
            return true;
          });
        }

        if (filtered.length === 0) {
          empty.style.display = "block";
          return;
        } else {
          empty.style.display = "none";
        }

        for (const card of filtered) {
          const cardDiv = document.createElement("div");
          cardDiv.className = "card-item";

          const imgWrapper = document.createElement("div");
          imgWrapper.className = "card-image-wrapper";

          const img = document.createElement("img");
          img.src = card.image;
          img.alt = card.cardName || "VaultSpin Card";

          imgWrapper.appendChild(img);
          cardDiv.appendChild(imgWrapper);

          const metaTop = document.createElement("div");
          metaTop.className = "card-meta-top";

          const nameSpan = document.createElement("div");
          nameSpan.className = "card-name";
          nameSpan.textContent = card.cardName || "VaultSpin Card";

          const tokenSpan = document.createElement("div");
          tokenSpan.className = "token-id-badge";
          tokenSpan.textContent = "# " + card.tokenId;

          metaTop.appendChild(nameSpan);
          metaTop.appendChild(tokenSpan);
          cardDiv.appendChild(metaTop);

          const rarityDiv = document.createElement("div");
          rarityDiv.className =
            "rarity-badge " + (RARITY_CLASS[card.rarityNum] || "");
          rarityDiv.textContent = RARITY_LABEL[card.rarityNum] || "Common";
          cardDiv.appendChild(rarityDiv);

          const metaBottom = document.createElement("div");
          metaBottom.className = "card-meta-bottom";

          const physSpan = document.createElement("div");
          if (card.physicalId && card.physicalId !== 0) {
            physSpan.textContent = "Physical ID: " + card.physicalId;
          } else {
            physSpan.textContent = "Pas de carte physique li√©e";
          }

          const redeemSpan = document.createElement("div");
          redeemSpan.className = "redeem-pill";

          if (card.redeemed) {
            redeemSpan.classList.add("badge-ok");
            redeemSpan.textContent = "Redeem valid√©";
          } else if (card.redeemAsked) {
            redeemSpan.classList.add("badge-pending");
            redeemSpan.textContent = "Redeem demand√©";
          } else if (card.physicalId && card.physicalId !== 0) {
            redeemSpan.classList.add("badge-none");
            redeemSpan.textContent = "Redeem possible";
          } else {
            redeemSpan.classList.add("badge-none");
            redeemSpan.textContent = "NFT digital uniquement";
          }

          metaBottom.appendChild(physSpan);
          metaBottom.appendChild(redeemSpan);

          cardDiv.appendChild(metaBottom);

          grid.appendChild(cardDiv);
        }
      }

      /********************
       * INIT DOM         *
       ********************/

      document.addEventListener("DOMContentLoaded", async () => {
        setStatus("Initialisation de la collection‚Ä¶", "pending");

        const raritySelect = document.getElementById("filter-rarity");
        const redeemSelect = document.getElementById("filter-redeem");

        raritySelect.addEventListener("change", renderCollection);
        redeemSelect.addEventListener("change", renderCollection);

        await initContract();
        await loadCollection();
      });
    </script>
  </body>
</html>
