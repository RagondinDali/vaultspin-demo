<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>VaultSpin – Collection (V10)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }

      body{
        min-height:100vh;
        background: radial-gradient(circle at top, #101827, #020617 60%);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color:#e5e7eb;
      }

      .wrap{
        width:100%;
        max-width:1200px;
        margin:0 auto;
        padding:90px 16px 50px;
        display:flex;
        flex-direction:column;
        gap:16px;
      }

      /* Top bar */
      .top-bar{
        position:fixed;
        top:16px;
        left:50%;
        transform:translateX(-50%);
        width:100%;
        max-width:1200px;
        display:flex;
        justify-content:space-between;
        align-items:center;
        padding:0 16px;
        z-index:30;
        pointer-events:none;
      }
      .top-left,.top-right{
        pointer-events:auto;
        display:flex;
        align-items:center;
        gap:10px;
      }
      .top-logo{
        font-size:12px;
        letter-spacing:.22em;
        text-transform:uppercase;
        color:#9ca3af;
      }
      .pill{
        border-radius:999px;
        border:1px solid rgba(148,163,184,.22);
        background: rgba(15,23,42,.55);
        padding:8px 12px;
        font-size:11px;
        letter-spacing:.14em;
        text-transform:uppercase;
        color:#e5e7eb;
        cursor:default;
      }
      .btn{
        border-radius:999px;
        border:1px solid rgba(148,163,184,.22);
        background: rgba(15,23,42,.55);
        padding:9px 12px;
        font-size:11px;
        letter-spacing:.14em;
        text-transform:uppercase;
        color:#e5e7eb;
        cursor:pointer;
        transition: box-shadow .15s ease-out, transform .15s ease-out, border-color .15s ease-out, opacity .15s ease-out;
      }
      .btn:hover{
        transform: translateY(-1px);
        border-color: rgba(165,180,252,.7);
        box-shadow: 0 0 12px rgba(129,140,248,.25);
      }
      .btn.primary{
        border:none;
        background: radial-gradient(circle at top left, #a855f7, #4f46e5);
        box-shadow: 0 0 18px rgba(168,85,247,.35);
      }
      .btn.primary:hover{
        box-shadow: 0 0 22px rgba(168,85,247,.55);
      }

      /* Header cards */
      .panel{
        background: radial-gradient(circle at top left, #020617, #020617 70%);
        border-radius:26px;
        border: 1px solid rgba(148,163,184,.20);
        padding:18px;
        display:flex;
        flex-direction:column;
        gap:14px;
      }

      .title-row{
        display:flex;
        justify-content:space-between;
        align-items:flex-start;
        gap:12px;
        flex-wrap:wrap;
      }

      h1{
        font-size:22px;
        font-weight:800;
        letter-spacing:.10em;
        text-transform:uppercase;
        color:#f9fafb;
      }
      .sub{
        font-size:13px;
        color:#9ca3af;
        line-height:1.4;
        max-width:760px;
        margin-top:4px;
      }

      .controls{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        align-items:center;
      }

      .filters{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        align-items:center;
        padding-top:4px;
      }

      .input{
        width:min(520px, 100%);
        border-radius:999px;
        border:1px solid rgba(148,163,184,.20);
        background: rgba(15,23,42,.40);
        padding:10px 12px;
        color:#e5e7eb;
        outline:none;
        font-size:13px;
      }

      select{
        border-radius:999px;
        border:1px solid rgba(148,163,184,.20);
        background: rgba(15,23,42,.40);
        padding:10px 12px;
        color:#e5e7eb;
        outline:none;
        font-size:13px;
      }

      .stats-row{
        display:flex;
        flex-wrap:wrap;
        gap:10px;
      }

      .stat{
        border-radius:18px;
        border:1px solid rgba(148,163,184,.14);
        background: rgba(2,6,23,.28);
        padding:12px;
        min-width:200px;
        flex:1;
      }
      .stat .k{
        font-size:10px;
        letter-spacing:.16em;
        text-transform:uppercase;
        color:#9ca3af;
      }
      .stat .v{
        margin-top:6px;
        font-size:18px;
        font-weight:900;
        color:#f9fafb;
      }
      .stat .s{
        margin-top:3px;
        font-size:12px;
        color:#9ca3af;
      }

      /* ✅ V10 : LISTE VERTICALE (au lieu de grid horizontal) */
      .grid{
        display:flex;
        flex-direction:column;
        gap:12px;
      }

      /* ✅ Cards en “row” */
      .card{
        border-radius:20px;
        border:1px solid rgba(148,163,184,.18);
        background: rgba(15,23,42,.28);
        padding:10px;
        display:flex;
        flex-direction:row;
        gap:12px;
        align-items:stretch;
        transition: transform .15s ease-out, box-shadow .15s ease-out, border-color .15s ease-out;
        cursor:default;
        user-select:none;
      }
      .card:hover{
        transform: translateY(-2px);
        border-color: rgba(165,180,252,.55);
        box-shadow: 0 0 16px rgba(129,140,248,.18);
      }

      /* ✅ Thumb fixe */
      .thumb{
        width:92px;
        flex:0 0 auto;
        aspect-ratio: 3 / 4;
        border-radius:16px;
        overflow:hidden;
        border:1px solid rgba(148,163,184,.18);
        background: rgba(2,6,23,.35);
      }
      .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }

      /* ✅ Meta prend la place */
      .meta{
        flex:1;
        display:flex;
        justify-content:space-between;
        align-items:flex-start;
        gap:10px;
        min-width:0;
      }

      .name{
        font-size:11px;
        letter-spacing:.10em;
        text-transform:uppercase;
        font-weight:900;
        color:#f9fafb;
        line-height:1.2;
        min-width:0;
      }
      .ct{
        font-size:11px;
        color:#9ca3af;
        margin-top:6px;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }

      .badges{
        display:flex;
        flex-direction:column;
        gap:8px;
        align-items:flex-end;
        flex:0 0 auto;
      }

      .tag{
        font-size:10px;
        letter-spacing:.14em;
        text-transform:uppercase;
        font-weight:900;
        padding:6px 9px;
        border-radius:999px;
        border:1px solid rgba(148,163,184,.16);
        background: rgba(2,6,23,.35);
      }

      .tag.common{ color:#facc15; }
      .tag.rare{ color:#38bdf8; }
      .tag.ultra{ color:#a855f7; }
      .tag.legendary{ color:#f97316; }

      .owned{
        font-size:10px;
        letter-spacing:.14em;
        text-transform:uppercase;
        padding:6px 9px;
        border-radius:999px;
        border:1px solid rgba(148,163,184,.18);
        background: rgba(15,23,42,.35);
        color:#e5e7eb;
        cursor:pointer;
      }
      .owned:hover{
        border-color: rgba(165,180,252,.7);
        box-shadow: 0 0 10px rgba(129,140,248,.18);
      }

      .hint{
        font-size:12px;
        color:#9ca3af;
        line-height:1.45;
      }

      /* Modal preview (center) */
      .modal{
        position:fixed;
        inset:0;
        display:none;
        align-items:center;
        justify-content:center;
        z-index:80;
        background: rgba(0,0,0,.55);
        backdrop-filter: blur(10px);
      }
      .modal.on{ display:flex; }
      .modal-card{
        width: min(430px, 92vw);
        border-radius:24px;
        border:1px solid rgba(148,163,184,.20);
        background: rgba(2,6,23,.86);
        box-shadow: 0 0 34px rgba(0,0,0,.5);
        padding:14px;
        position:relative;
        animation: popIn 140ms ease-out;
      }
      @keyframes popIn{ from{ transform:scale(.985); opacity:0; } to{ transform:scale(1); opacity:1; } }

      .modal-img{
        width:100%;
        aspect-ratio:3/4;
        border-radius:18px;
        overflow:hidden;
        border:1px solid rgba(148,163,184,.22);
        background: rgba(15,23,42,.45);
      }
      .modal-img img{ width:100%; height:100%; object-fit:cover; display:block; }

      .modal-meta{
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap:10px;
        margin-top:10px;
      }
      .modal-name{
        font-size:12px;
        letter-spacing:.12em;
        text-transform:uppercase;
        font-weight:900;
        color:#e5e7eb;
      }
      .modal-tag{
        font-size:11px;
        letter-spacing:.14em;
        text-transform:uppercase;
        padding:6px 10px;
        border-radius:999px;
        border:1px solid rgba(148,163,184,.20);
        background: rgba(15,23,42,.55);
        color:#e5e7eb;
      }

      .modal-close{
        position:absolute;
        right:10px;
        top:10px;
        border:1px solid rgba(148,163,184,.20);
        background: rgba(15,23,42,.55);
        color:#e5e7eb;
        border-radius:999px;
        padding:8px 10px;
        cursor:pointer;
        font-size:12px;
      }
      .modal-close:hover{
        border-color: rgba(165,180,252,.7);
        box-shadow: 0 0 10px rgba(129,140,248,.25);
      }

      .chip{
        display:inline-flex;
        align-items:center;
        gap:8px;
        border-radius:999px;
        border:1px solid rgba(148,163,184,.20);
        background: rgba(15,23,42,.40);
        padding:8px 12px;
        font-size:11px;
        color:#e5e7eb;
      }
      .chip strong{ color:#f9fafb; }
      .chip a{ color:#a5b4fc; text-decoration: underline; }
      .chip a:hover{ color:#c4b5fd; }

      /* ✅ Mobile : badges à droite mais mieux “stackés” */
      @media (max-width: 520px){
        .card{ gap:10px; }
        .thumb{ width:84px; }
        .ct{ white-space:normal; }
      }
    </style>
  </head>

  <body>
    <!-- Top bar -->
    <div class="top-bar">
      <div class="top-left">
        <div class="top-logo">VAULTSPIN · COLLECTION</div>
        <div class="pill" id="filter-pill" style="display:none;"></div>
      </div>
      <div class="top-right">
        <button class="btn" id="back-packs">Retour packs</button>
        <button class="btn primary" id="clear-filter" style="display:none;">Clear filter</button>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true">
        <button class="modal-close" id="modal-close">✕</button>
        <div class="modal-img">
          <img id="modal-img" src="" alt="Preview" />
        </div>
        <div class="modal-meta">
          <div class="modal-name" id="modal-name">—</div>
          <div class="modal-tag" id="modal-tag">—</div>
        </div>
      </div>
    </div>

    <div class="wrap">
      <div class="panel">
        <div class="title-row">
          <div>
            <h1>Ma collection</h1>
            <div class="sub">
              Vue “Stacks” : cartes groupées par <b>cardTypeIndex</b>. Clique sur le badge
              <b>Owned</b> pour filtrer. Le filtre est aussi supporté via <b>?ct=</b>.
              <br/>
              ✅ V10 : affichage <b>vertical</b> (liste) pour éviter les sorties d’écran.
            </div>
          </div>

          <div class="controls">
            <button class="btn" id="export-json">Export JSON</button>
            <button class="btn" id="reset-data">Reset data</button>
          </div>
        </div>

        <div class="filters">
          <input class="input" id="search" placeholder="Search (rarity / index / name)..." />
          <select id="sort">
            <option value="rarity_desc">Sort: rarity ↓</option>
            <option value="rarity_asc">Sort: rarity ↑</option>
            <option value="owned_desc">Sort: owned ↓</option>
            <option value="owned_asc">Sort: owned ↑</option>
            <option value="index_asc">Sort: index ↑</option>
            <option value="index_desc">Sort: index ↓</option>
          </select>
        </div>

        <div class="stats-row">
          <div class="stat">
            <div class="k">Total items</div>
            <div class="v" id="stat-total">0</div>
            <div class="s">NFTs (démo) enregistrés</div>
          </div>
          <div class="stat">
            <div class="k">Unique types</div>
            <div class="v" id="stat-unique">0</div>
            <div class="s">cardTypeIndex distincts</div>
          </div>
          <div class="stat">
            <div class="k">Best rarity</div>
            <div class="v" id="stat-best">—</div>
            <div class="s" id="stat-best-sub">—</div>
          </div>
        </div>

        <div class="hint" id="hint">
          Astuce : clique sur une carte pour la voir en grand.
        </div>
      </div>

      <div class="panel">
        <div class="chip" id="empty-state" style="display:none;">
          Aucune carte pour l’instant. Retourne ouvrir un pack sur
          <a href="index.html">la page packs</a>.
        </div>

        <div class="grid" id="grid"></div>
      </div>
    </div>

    <script>
      /********************
       * Compatible avec V9/V10
       ********************/
      const VS_COLLECTION_KEY = "vaultspin_collection_v1";

      const RARITY_ORDER = ["COMMON","RARE","ULTRA","LEGENDARY"];
      const RARITY_LABEL = { COMMON:"Common", RARE:"Rare", ULTRA:"Ultra", LEGENDARY:"Legendary" };

      function rarityKeyFromNum(num){
        if (num === 0) return "COMMON";
        if (num === 1) return "RARE";
        if (num === 2) return "ULTRA";
        if (num === 3) return "LEGENDARY";
        return "COMMON";
      }

      function getCollection(){
        try { return JSON.parse(localStorage.getItem(VS_COLLECTION_KEY) || "[]"); }
        catch { return []; }
      }

      function setCollection(arr){
        localStorage.setItem(VS_COLLECTION_KEY, JSON.stringify(arr));
      }

      function getCtFilterFromUrl(){
        const p = new URLSearchParams(window.location.search);
        const ct = p.get("ct");
        if (ct === null) return null;
        const n = Number(ct);
        return Number.isFinite(n) ? n : null;
      }

      function setCtInUrl(ct){
        const url = new URL(window.location.href);
        url.searchParams.set("ct", String(ct));
        window.location.href = url.toString();
      }

      function clearCtInUrl(){
        const url = new URL(window.location.href);
        url.searchParams.delete("ct");
        window.location.href = url.toString();
      }

      function fmtDate(ts){
        const d = new Date(ts);
        return d.toLocaleString("fr-FR", { day:"2-digit", month:"2-digit", year:"2-digit", hour:"2-digit", minute:"2-digit" });
      }

      function bestPull(arr){
        if (!arr.length) return null;
        let best = arr[0];
        for (const c of arr){
          const ak = c.rarityKey || rarityKeyFromNum(c.rarity || 0);
          const bk = best.rarityKey || rarityKeyFromNum(best.rarity || 0);
          if (RARITY_ORDER.indexOf(ak) > RARITY_ORDER.indexOf(bk)) best = c;
        }
        return best;
      }

      function groupByCardType(arr){
        const map = new Map();
        for (const x of arr){
          const ct = Number(x.cardTypeIndex ?? -1);
          if (!map.has(ct)){
            const rk = x.rarityKey || rarityKeyFromNum(x.rarity || 0);
            map.set(ct, {
              cardTypeIndex: ct,
              rarityKey: rk,
              rarityLabel: x.rarityLabel || RARITY_LABEL[rk] || "Common",
              img: x.img || "",
              name: x.name || ("Card #" + ct),
              owned: 0,
              lastTs: 0,
              lastTokenId: null
            });
          }
          const g = map.get(ct);
          g.owned += 1;
          if ((x.ts || 0) > g.lastTs){
            g.lastTs = x.ts || 0;
            g.lastTokenId = x.tokenId ?? null;
          }
        }
        return Array.from(map.values()).filter(x => x.cardTypeIndex >= 0);
      }

      function rarityClass(k){
        if (k === "LEGENDARY") return "legendary";
        if (k === "ULTRA") return "ultra";
        if (k === "RARE") return "rare";
        return "common";
      }

      /********************
       * Modal preview
       ********************/
      function openModal({ img, name, rarity }){
        document.getElementById("modal-img").src = img || "";
        document.getElementById("modal-name").textContent = name || "—";
        document.getElementById("modal-tag").textContent = rarity || "—";
        const modal = document.getElementById("modal");
        modal.classList.add("on");
        modal.setAttribute("aria-hidden", "false");
      }

      function closeModal(){
        const modal = document.getElementById("modal");
        modal.classList.remove("on");
        modal.setAttribute("aria-hidden", "true");
      }

      /********************
       * Rendering
       ********************/
      function render(){
        const grid = document.getElementById("grid");
        const empty = document.getElementById("empty-state");

        const ctFilter = getCtFilterFromUrl();
        const search = (document.getElementById("search").value || "").trim().toLowerCase();
        const sort = document.getElementById("sort").value;

        let items = getCollection();

        // Apply URL filter first
        if (ctFilter !== null){
          items = items.filter(x => Number(x.cardTypeIndex) === ctFilter);
        }

        // Stats base (before grouping)
        document.getElementById("stat-total").textContent = String(items.length);

        const best = bestPull(items);
        if (best){
          const rk = best.rarityKey || rarityKeyFromNum(best.rarity || 0);
          document.getElementById("stat-best").textContent = RARITY_LABEL[rk] || best.rarityLabel || "Common";
          document.getElementById("stat-best-sub").textContent = fmtDate(best.ts || Date.now());
        } else {
          document.getElementById("stat-best").textContent = "—";
          document.getElementById("stat-best-sub").textContent = "—";
        }

        // Group stacks
        let stacks = groupByCardType(items);

        document.getElementById("stat-unique").textContent = String(stacks.length);

        // Search on stacks
        if (search){
          stacks = stacks.filter(s => {
            const hay = [
              String(s.cardTypeIndex),
              (s.name || "").toLowerCase(),
              (s.rarityKey || "").toLowerCase(),
              (s.rarityLabel || "").toLowerCase(),
              "owned " + String(s.owned)
            ].join(" ");
            return hay.includes(search);
          });
        }

        // Sort
        stacks.sort((a,b) => {
          const ra = RARITY_ORDER.indexOf(a.rarityKey);
          const rb = RARITY_ORDER.indexOf(b.rarityKey);

          if (sort === "rarity_desc") return rb - ra;
          if (sort === "rarity_asc") return ra - rb;

          if (sort === "owned_desc") return (b.owned - a.owned) || (rb - ra);
          if (sort === "owned_asc") return (a.owned - b.owned) || (rb - ra);

          if (sort === "index_desc") return b.cardTypeIndex - a.cardTypeIndex;
          return a.cardTypeIndex - b.cardTypeIndex;
        });

        // Empty state
        grid.innerHTML = "";
        if (!getCollection().length){
          empty.style.display = "inline-flex";
        } else {
          empty.style.display = "none";
        }

        if (!stacks.length){
          const d = document.createElement("div");
          d.className = "chip";
          d.innerHTML = `<span>Aucun résultat.</span>`;
          grid.appendChild(d);
          return;
        }

        // Render stack cards (✅ vertical list rows)
        for (const s of stacks){
          const card = document.createElement("div");
          card.className = "card";
          card.setAttribute("data-ct", String(s.cardTypeIndex));
          card.setAttribute("data-img", s.img);
          card.setAttribute("data-name", s.name);
          card.setAttribute("data-rk", s.rarityKey);

          const thumb = document.createElement("div");
          thumb.className = "thumb";
          thumb.innerHTML = `<img src="${s.img}" alt="${s.name}"/>`;

          const meta = document.createElement("div");
          meta.className = "meta";

          const left = document.createElement("div");
          left.style.minWidth = "0";
          left.innerHTML = `
            <div class="name">${escapeHtml(s.name)}</div>
            <div class="ct">cardTypeIndex: ${s.cardTypeIndex} · last: #${s.lastTokenId ?? "—"} · ${s.lastTs ? fmtDate(s.lastTs) : "—"}</div>
          `;

          const badges = document.createElement("div");
          badges.className = "badges";

          const tag = document.createElement("div");
          tag.className = "tag " + rarityClass(s.rarityKey);
          tag.textContent = s.rarityLabel;

          const owned = document.createElement("button");
          owned.className = "owned";
          owned.type = "button";
          owned.textContent = "Owned · " + s.owned;

          // Owned badge click => filter on this card
          owned.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            setCtInUrl(s.cardTypeIndex);
          });

          badges.appendChild(tag);
          badges.appendChild(owned);

          meta.appendChild(left);
          meta.appendChild(badges);

          card.appendChild(thumb);
          card.appendChild(meta);

          // Click = preview persistent
          card.addEventListener("click", () => {
            openModal({
              img: s.img,
              name: s.name + " (ct " + s.cardTypeIndex + ")",
              rarity: s.rarityLabel
            });
          });

          grid.appendChild(card);
        }

        // Update filter pill UI
        const pill = document.getElementById("filter-pill");
        const clearBtn = document.getElementById("clear-filter");
        if (ctFilter !== null){
          pill.style.display = "inline-flex";
          pill.textContent = "Filter: ct=" + ctFilter;
          clearBtn.style.display = "inline-flex";
        } else {
          pill.style.display = "none";
          clearBtn.style.display = "none";
        }
      }

      function escapeHtml(s){
        return String(s || "").replace(/[&<>"']/g, (c) => ({
          "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
        }[c]));
      }

      /********************
       * Actions
       ********************/
      function exportJson(){
        const data = getCollection();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type:"application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "vaultspin_collection.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function resetData(){
        localStorage.removeItem(VS_COLLECTION_KEY);
        closeModal();
        render();
      }

      /********************
       * Init
       ********************/
      document.addEventListener("DOMContentLoaded", () => {
        // buttons
        document.getElementById("back-packs").addEventListener("click", () => {
          window.location.href = "index.html";
        });
        document.getElementById("clear-filter").addEventListener("click", () => {
          clearCtInUrl();
        });
        document.getElementById("export-json").addEventListener("click", exportJson);
        document.getElementById("reset-data").addEventListener("click", resetData);

        // modal
        document.getElementById("modal-close").addEventListener("click", closeModal);
        document.getElementById("modal").addEventListener("click", (e) => {
          if (e.target.id === "modal") closeModal();
        });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeModal();
        });

        // filters
        document.getElementById("search").addEventListener("input", render);
        document.getElementById("sort").addEventListener("change", render);

        render();
      });
    </script>
  </body>
</html>
