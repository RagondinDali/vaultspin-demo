<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>VaultSpin – Collection</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }

      body{
        min-height:100vh;
        background: radial-gradient(circle at top, #101827, #020617 60%);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color:#e5e7eb;
      }

      .wrap{
        width:100%;
        max-width:1200px;
        margin:0 auto;
        padding:90px 16px 50px;
        display:flex;
        flex-direction:column;
        gap:16px;
      }

      /* Top bar */
      .top-bar{
        position:fixed;
        top:16px;
        left:50%;
        transform:translateX(-50%);
        width:100%;
        max-width:1200px;
        display:flex;
        justify-content:space-between;
        align-items:center;
        padding:0 16px;
        z-index:30;
        pointer-events:none;
      }
      .top-left,.top-right{
        pointer-events:auto;
        display:flex;
        align-items:center;
        gap:10px;
        flex-wrap:wrap;
      }
      .top-logo{
        font-size:12px;
        letter-spacing:.22em;
        text-transform:uppercase;
        color:#9ca3af;
      }
      .pill{
        border-radius:999px;
        border:1px solid rgba(148,163,184,.22);
        background: rgba(15,23,42,.55);
        padding:8px 12px;
        font-size:11px;
        letter-spacing:.14em;
        text-transform:uppercase;
        color:#e5e7eb;
        cursor:default;
      }
      .btn{
        border-radius:999px;
        border:1px solid rgba(148,163,184,.22);
        background: rgba(15,23,42,.55);
        padding:9px 12px;
        font-size:11px;
        letter-spacing:.14em;
        text-transform:uppercase;
        color:#e5e7eb;
        cursor:pointer;
        transition: box-shadow .15s ease-out, transform .15s ease-out, border-color .15s ease-out, opacity .15s ease-out;
      }
      .btn:hover{
        transform: translateY(-1px);
        border-color: rgba(165,180,252,.7);
        box-shadow: 0 0 12px rgba(129,140,248,.25);
      }
      .btn.primary{
        border:none;
        background: radial-gradient(circle at top left, #a855f7, #4f46e5);
        box-shadow: 0 0 18px rgba(168,85,247,.35);
      }
      .btn.primary:hover{
        box-shadow: 0 0 22px rgba(168,85,247,.55);
      }

      /* Header cards */
      .panel{
        background: radial-gradient(circle at top left, #020617, #020617 70%);
        border-radius:26px;
        border: 1px solid rgba(148,163,184,.20);
        padding:18px;
        display:flex;
        flex-direction:column;
        gap:14px;
      }

      .title-row{
        display:flex;
        justify-content:space-between;
        align-items:flex-start;
        gap:12px;
        flex-wrap:wrap;
      }

      h1{
        font-size:22px;
        font-weight:800;
        letter-spacing:.10em;
        text-transform:uppercase;
        color:#f9fafb;
      }
      .sub{
        font-size:13px;
        color:#9ca3af;
        line-height:1.4;
        max-width:760px;
        margin-top:4px;
      }

      .controls{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        align-items:center;
      }

      .filters{
        display:flex;
        gap:10px;
        flex-wrap:wrap;
        align-items:center;
        padding-top:4px;
      }

      .input{
        width:min(520px, 100%);
        border-radius:999px;
        border:1px solid rgba(148,163,184,.20);
        background: rgba(15,23,42,.40);
        padding:10px 12px;
        color:#e5e7eb;
        outline:none;
        font-size:13px;
      }

      select{
        border-radius:999px;
        border:1px solid rgba(148,163,184,.20);
        background: rgba(15,23,42,.40);
        padding:10px 12px;
        color:#e5e7eb;
        outline:none;
        font-size:13px;
      }

      .stats-row{
        display:flex;
        flex-wrap:wrap;
        gap:10px;
      }

      .stat{
        border-radius:18px;
        border:1px solid rgba(148,163,184,.14);
        background: rgba(2,6,23,.28);
        padding:12px;
        min-width:200px;
        flex:1;
      }
      .stat .k{
        font-size:10px;
        letter-spacing:.16em;
        text-transform:uppercase;
        color:#9ca3af;
      }
      .stat .v{
        margin-top:6px;
        font-size:18px;
        font-weight:900;
        color:#f9fafb;
      }
      .stat .s{
        margin-top:3px;
        font-size:12px;
        color:#9ca3af;
      }

      /* LISTE VERTICALE */
      .grid{
        display:flex;
        flex-direction:column;
        gap:12px;
      }

      /* Cards en “row” */
      .card{
        border-radius:20px;
        border:1px solid rgba(148,163,184,.18);
        background: rgba(15,23,42,.28);
        padding:10px;
        display:flex;
        flex-direction:row;
        gap:12px;
        align-items:stretch;
        transition: transform .15s ease-out, box-shadow .15s ease-out, border-color .15s ease-out;
        cursor:default;
        user-select:none;
      }
      .card:hover{
        transform: translateY(-2px);
        border-color: rgba(165,180,252,.55);
        box-shadow: 0 0 16px rgba(129,140,248,.18);
      }

      /* Thumb fixe */
      .thumb{
        width:92px;
        flex:0 0 auto;
        aspect-ratio: 3 / 4;
        border-radius:16px;
        overflow:hidden;
        border:1px solid rgba(148,163,184,.18);
        background: rgba(2,6,23,.55);
      }
      .thumb img{
        width:100%;
        height:100%;
        object-fit:contain;
        object-position:center;
        display:block;
        padding:6px;
        background: transparent;
      }

      .meta{
        flex:1;
        display:flex;
        justify-content:space-between;
        align-items:flex-start;
        gap:10px;
        min-width:0;
      }

      .name{
        font-size:11px;
        letter-spacing:.10em;
        text-transform:uppercase;
        font-weight:900;
        color:#f9fafb;
        line-height:1.2;
        min-width:0;
      }
      .ct{
        font-size:11px;
        color:#9ca3af;
        margin-top:6px;
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }
      .price{
        margin-top:6px;
        font-size:11px;
        color:#cbd5e1;
        letter-spacing:.06em;
      }

      .badges{
        display:flex;
        flex-direction:column;
        gap:8px;
        align-items:flex-end;
        flex:0 0 auto;
      }

      .tag{
        font-size:10px;
        letter-spacing:.14em;
        text-transform:uppercase;
        font-weight:900;
        padding:6px 9px;
        border-radius:999px;
        border:1px solid rgba(148,163,184,.16);
        background: rgba(2,6,23,.35);
      }

      .tag.epic{ color:#38bdf8; }
      .tag.ultra{ color:#a855f7; }
      .tag.legendary{ color:#f97316; }

      .owned{
        font-size:10px;
        letter-spacing:.14em;
        text-transform:uppercase;
        padding:6px 9px;
        border-radius:999px;
        border:1px solid rgba(148,163,184,.18);
        background: rgba(15,23,42,.35);
        color:#e5e7eb;
        cursor:pointer;
      }
      .owned:hover{
        border-color: rgba(165,180,252,.7);
        box-shadow: 0 0 10px rgba(129,140,248,.18);
      }

      .hint{
        font-size:12px;
        color:#9ca3af;
        line-height:1.45;
      }

      /* Modal preview */
      .modal{
        position:fixed;
        inset:0;
        display:none;
        align-items:center;
        justify-content:center;
        z-index:80;
        background: rgba(0,0,0,.55);
        backdrop-filter: blur(10px);
      }
      .modal.on{ display:flex; }
      .modal-card{
        width: min(430px, 92vw);
        border-radius:24px;
        border:1px solid rgba(148,163,184,.20);
        background: rgba(2,6,23,.86);
        box-shadow: 0 0 34px rgba(0,0,0,.5);
        padding:14px;
        position:relative;
        animation: popIn 140ms ease-out;
      }
      @keyframes popIn{ from{ transform:scale(.985); opacity:0; } to{ transform:scale(1); opacity:1; } }

      .modal-img{
        width:100%;
        aspect-ratio:3/4;
        border-radius:18px;
        overflow:hidden;
        border:1px solid rgba(148,163,184,.22);
        background: rgba(2,6,23,.55);
      }
      .modal-img img{
        width:100%;
        height:100%;
        object-fit:contain;
        object-position:center;
        display:block;
        padding:10px;
        background: transparent;
      }

      .modal-meta{
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap:10px;
        margin-top:10px;
      }
      .modal-name{
        font-size:12px;
        letter-spacing:.12em;
        text-transform:uppercase;
        font-weight:900;
        color:#e5e7eb;
      }
      .modal-tag{
        font-size:11px;
        letter-spacing:.14em;
        text-transform:uppercase;
        padding:6px 10px;
        border-radius:999px;
        border:1px solid rgba(148,163,184,.20);
        background: rgba(15,23,42,.55);
        color:#e5e7eb;
      }
      .modal-price{
        margin-top:10px;
        font-size:12px;
        color:#cbd5e1;
        letter-spacing:.08em;
      }

      .modal-close{
        position:absolute;
        right:10px;
        top:10px;
        border:1px solid rgba(148,163,184,.20);
        background: rgba(15,23,42,.55);
        color:#e5e7eb;
        border-radius:999px;
        padding:8px 10px;
        cursor:pointer;
        font-size:12px;
      }
      .modal-close:hover{
        border-color: rgba(165,180,252,.7);
        box-shadow: 0 0 10px rgba(129,140,248,.25);
      }

      .chip{
        display:inline-flex;
        align-items:center;
        gap:8px;
        border-radius:999px;
        border:1px solid rgba(148,163,184,.20);
        background: rgba(15,23,42,.40);
        padding:8px 12px;
        font-size:11px;
        color:#e5e7eb;
      }
      .chip strong{ color:#f9fafb; }
      .chip a{ color:#a5b4fc; text-decoration: underline; }
      .chip a:hover{ color:#c4b5fd; }

      .top-link{
        font-size:12px;
        padding:6px 10px;
        height:34px;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        border-radius:999px;
        border:1px solid rgba(148,163,184,.45);
        color:#e5e7eb;
        text-decoration:none;
        letter-spacing:.14em;
        text-transform:uppercase;
        background:rgba(15,23,42,.85);
      }
      .top-link:hover{
        border-color:#a5b4fc;
        box-shadow:0 0 10px rgba(129,140,248,.4);
      }

      @media (max-width: 520px){
        .card{ gap:10px; }
        .thumb{ width:84px; }
        .ct{ white-space:normal; }
      }
    </style>
  </head>

  <body>
    <!-- Top bar -->
    <div class="top-bar">
      <div class="top-left">
        <div class="top-logo">VAULTSPIN · COLLECTION</div>
        <div class="pill" id="filter-pill" style="display:none;"></div>
      </div>
      <div class="top-right">
        <a class="top-link" href="leaderboard.html">Leaderboard</a>
        <span id="vs-user-email" class="top-link" style="display:none; max-width:220px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">—</span>
        <a id="vs-login-btn" class="top-link" href="login.html">Connexion</a>
        <button class="btn" id="vs-logout-btn" style="display:none;">Déconnexion</button>

        <button class="btn" id="back-packs">Retour packs</button>
        <button class="btn primary" id="clear-filter" style="display:none;">Clear filter</button>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true">
        <button class="modal-close" id="modal-close">✕</button>
        <div class="modal-img">
          <img id="modal-img" src="" alt="Preview" />
        </div>
        <div class="modal-meta">
          <div class="modal-name" id="modal-name">—</div>
          <div class="modal-tag" id="modal-tag" style="display:none;">—</div>
        </div>
        <div class="modal-price" id="modal-price">Valeur estimée : —</div>
      </div>
    </div>

    <div class="wrap">
      <div class="panel">
        <div class="title-row">
          <div>
            <h1>Ma collection</h1>
            <div class="sub">
              Vue “Stacks” : cartes groupées par <b>cardTypeIndex</b>.
              Clique sur <b>Owned</b> pour filtrer. Filtre aussi via <b>?ct=</b>.
              <br/>
              ✅ Source of truth = Supabase <b>user_cards</b> (si connecté). Sinon fallback localStorage.
            </div>
          </div>

          <div class="controls">
            <button class="btn" id="export-json">Export JSON</button>
            <button class="btn" id="reset-data">Reset data (local)</button>
          </div>
        </div>

        <div class="filters">
          <input class="input" id="search" placeholder="Search (rarity / index / name / price)..." />
          <select id="sort">
            <option value="rarity_desc">Sort: rarity ↓</option>
            <option value="rarity_asc">Sort: rarity ↑</option>
            <option value="owned_desc">Sort: owned ↓</option>
            <option value="owned_asc">Sort: owned ↑</option>
            <option value="price_desc">Sort: price ↓</option>
            <option value="price_asc">Sort: price ↑</option>
            <option value="index_asc">Sort: index ↑</option>
            <option value="index_desc">Sort: index ↓</option>
          </select>
        </div>

        <div class="stats-row">
          <div class="stat">
            <div class="k">Total items</div>
            <div class="v" id="stat-total">0</div>
            <div class="s">NFTs enregistrés</div>
          </div>
          <div class="stat">
            <div class="k">Unique types</div>
            <div class="v" id="stat-unique">0</div>
            <div class="s">cardTypeIndex distincts</div>
          </div>
          <div class="stat">
            <div class="k">Best pull</div>
            <div class="v" id="stat-best">—</div>
            <div class="s" id="stat-best-sub">—</div>
          </div>
          <div class="stat">
            <div class="k">Vault value</div>
            <div class="v" id="stat-vault">0€</div>
            <div class="s">Somme des valeurs estimées</div>
          </div>
        </div>

        <div class="hint" id="hint">
          Astuce : clique sur une carte pour la voir en grand.
        </div>
      </div>

      <div class="panel">
        <div class="chip" id="empty-state" style="display:none;">
          Aucune carte pour l’instant. Retourne ouvrir un pack sur
          <a href="index.html">la page packs</a>.
        </div>

        <div class="grid" id="grid"></div>
      </div>
    </div>

    <script>
      /********************
       * STORAGE (fallback)
       ********************/
      const VS_COLLECTION_KEY = "vaultspin_collection_v1";

      /********************
       * PRICES (source of truth — identique à index)
       ********************/
      const CARD_PRICE_EUR_BY_INDEX = {
        0: 5.50,
        1: 135,
        2: 60,
        3: 70,
        4: 109,
        5: 209,
        6: 69,
        7: 129,
        8: 70,
        9: 109,
        10: 1350,
        11: 199,
        12: 109,
        13: 109,
        14: 77,
        15: 15.50,
        16: 4.00,
        17: 3.00,
        18: 7.00
      };

      function fmtEur(n){
        return (Number(n) || 0).toLocaleString("fr-FR", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " €";
      }

      /********************
       * RARITY logic
       ********************/
      const CT_FLORIZARRE = 10;

      const CT_PCA = 0;
      const CT_BOSKARA = 15;
      const CT_FILENTRAPPE = 16;
      const CT_PETERSON = 17;
      const CT_SCOVILAIN = 18;
      const HIDDEN_SET = new Set([CT_PCA, CT_BOSKARA, CT_FILENTRAPPE, CT_PETERSON, CT_SCOVILAIN]);

      const ULTRA_BUCKET = new Set([1, 5, 7, 11]);
      const EPIC_BUCKET  = new Set([2, 3, 4, 6, 8, 9, 12, 13, 14]);

      const RARITY_ORDER = ["EPIC","ULTRA","LEGENDARY"]; // hidden: -1
      const RARITY_LABEL = { EPIC:"EPIC", ULTRA:"ULTRA", LEGENDARY:"LEGENDARY" };

      function rarityKeyForCt(ct){
        const n = Number(ct);
        if (HIDDEN_SET.has(n)) return "";
        if (n === CT_FLORIZARRE) return "LEGENDARY";
        if (ULTRA_BUCKET.has(n)) return "ULTRA";
        if (EPIC_BUCKET.has(n)) return "EPIC";
        const price = CARD_PRICE_EUR_BY_INDEX[n] ?? 0;
        if (price > 300) return "LEGENDARY";
        if (price >= 121) return "ULTRA";
        return "EPIC";
      }

      function rarityRank(rk){
        if (!rk) return -1;
        return RARITY_ORDER.indexOf(rk);
      }

      function rarityClass(k){
        if (k === "LEGENDARY") return "legendary";
        if (k === "ULTRA") return "ultra";
        if (k === "EPIC") return "epic";
        return "";
      }

      /********************
       * Local catalog (ct -> meta)
       ********************/
      const CARD_CATALOG = {
        0:  { name:"Phyllali PCA",   img:"images/phyllali_PCA.png" },
        1:  { name:"Aéromite",       img:"images/aeromite.png" },
        2:  { name:"Germignon",      img:"images/germignon.png" },
        3:  { name:"Astronelle",     img:"images/astronelle.png" },
        4:  { name:"Chétiflor",      img:"images/chetiflor.png" },
        5:  { name:"Jungko",         img:"images/jungko.png" },
        6:  { name:"Chenipan",       img:"images/chenipan.png" },
        7:  { name:"Énergie Plante", img:"images/energie_plante.png" },
        8:  { name:"Majaspic",       img:"images/majaspic.png" },
        9:  { name:"Mimitoss",       img:"images/mimitoss.png" },
        10: { name:"Florizarre",     img:"images/florizarre.png" },
        11: { name:"Nidoking",       img:"images/nidoking.png" },
        12: { name:"Noeufnoeuf",     img:"images/noeufnoeuf.png" },
        13: { name:"Paras",          img:"images/paras.png" },
        14: { name:"Phyllali",       img:"images/phyllali.png" },
        15: { name:"Boskara",        img:"images/boskara.png" },
        16: { name:"Filentrappe",    img:"images/filentrappe.png" },
        17: { name:"Peterson",       img:"images/peterson.png" },
        18: { name:"Scovilain",      img:"images/scovilain.png" }
      };

      function catalogForCt(ct){
        return CARD_CATALOG[Number(ct)] || null;
      }

      function getLocalCollection(){
        try { return JSON.parse(localStorage.getItem(VS_COLLECTION_KEY) || "[]"); }
        catch { return []; }
      }

      function setLocalCollection(arr){
        localStorage.setItem(VS_COLLECTION_KEY, JSON.stringify(arr));
      }

      function getCtFilterFromUrl(){
        const p = new URLSearchParams(window.location.search);
        const ct = p.get("ct");
        if (ct === null) return null;
        const n = Number(ct);
        return Number.isFinite(n) ? n : null;
      }

      function setCtInUrl(ct){
        const url = new URL(window.location.href);
        url.searchParams.set("ct", String(ct));
        window.location.href = url.toString();
      }

      function clearCtInUrl(){
        const url = new URL(window.location.href);
        url.searchParams.delete("ct");
        window.location.href = url.toString();
      }

      function fmtDate(ts){
        const d = new Date(ts);
        return d.toLocaleString("fr-FR", { day:"2-digit", month:"2-digit", year:"2-digit", hour:"2-digit", minute:"2-digit" });
      }

      function bestPull(arr){
        if (!arr.length) return null;
        let best = arr[0];
        for (const c of arr){
          const aCt = Number(c.cardTypeIndex ?? -1);
          const bCt = Number(best.cardTypeIndex ?? -1);
          const aR = rarityRank(rarityKeyForCt(aCt));
          const bR = rarityRank(rarityKeyForCt(bCt));
          if (aR > bR) best = c;
          else if (aR === bR){
            const ap = CARD_PRICE_EUR_BY_INDEX[aCt] ?? 0;
            const bp = CARD_PRICE_EUR_BY_INDEX[bCt] ?? 0;
            if (ap > bp) best = c;
          }
        }
        return best;
      }

      function vaultValue(arr){
        let sum = 0;
        for (const x of arr){
          const ct = Number(x.cardTypeIndex ?? -1);
          if (!Number.isFinite(ct) || ct < 0) continue;
          sum += (CARD_PRICE_EUR_BY_INDEX[ct] ?? 0);
        }
        return sum;
      }

      function groupByCardType(arr){
        const map = new Map();

        for (const x of arr){
          const ct = Number(x.cardTypeIndex ?? -1);
          if (!Number.isFinite(ct) || ct < 0) continue;

          const cat = catalogForCt(ct);
          const price = CARD_PRICE_EUR_BY_INDEX[ct] ?? 0;
          const rk = rarityKeyForCt(ct);

          if (!map.has(ct)){
            map.set(ct, {
              cardTypeIndex: ct,
              rarityKey: rk,
              rarityLabel: rk ? (RARITY_LABEL[rk] || rk) : "",
              img: x.img || (cat && cat.img) || "",
              name: x.name || (cat && cat.name) || ("Card #" + ct),
              owned: 0,
              lastTs: 0,
              lastTokenId: null,
              price
            });
          }

          const g = map.get(ct);
          g.owned += 1;

          const betterImg = x.img || (cat && cat.img) || "";
          const betterName = x.name || (cat && cat.name) || "";
          if (!g.img && betterImg) g.img = betterImg;
          if (!g.name || g.name.startsWith("Card #")) if (betterName) g.name = betterName;

          if ((x.ts || 0) > g.lastTs){
            g.lastTs = x.ts || 0;
            g.lastTokenId = x.tokenId ?? null;
          }

          g.price = price;
          g.rarityKey = rk;
          g.rarityLabel = rk ? (RARITY_LABEL[rk] || rk) : "";
        }

        return Array.from(map.values());
      }

      /********************
       * Modal
       ********************/
      function openModal({ img, name, rarity, price }){
        document.getElementById("modal-img").src = img || "";
        document.getElementById("modal-name").textContent = name || "—";

        const tag = document.getElementById("modal-tag");
        if (rarity){
          tag.style.display = "inline-flex";
          tag.textContent = rarity;
        } else {
          tag.style.display = "none";
          tag.textContent = "";
        }

        document.getElementById("modal-price").textContent = "Valeur estimée : " + fmtEur(price || 0);

        const modal = document.getElementById("modal");
        modal.classList.add("on");
        modal.setAttribute("aria-hidden", "false");
      }

      function closeModal(){
        const modal = document.getElementById("modal");
        modal.classList.remove("on");
        modal.setAttribute("aria-hidden", "true");
      }

      /********************
       * DB-first state
       ********************/
      let SOURCE = "local";   // "db" | "local"
      let CARDS = [];         // normalized list

      function normalizeFromLocal(localArr){
        // local schema: { tokenId, ts, priceEur, rarityKey, cardTypeIndex, img, name }
        return (localArr || []).map(x => ({
          tokenId: x.tokenId ?? null,
          ts: x.ts ?? Date.now(),
          cardTypeIndex: Number(x.cardTypeIndex ?? -1),
          img: x.img || "",
          name: x.name || "",
          estimated_value_eur: Number(x.priceEur ?? (CARD_PRICE_EUR_BY_INDEX[Number(x.cardTypeIndex)] ?? 0)) || 0
        })).filter(x => Number.isFinite(x.cardTypeIndex) && x.cardTypeIndex >= 0);
      }

      function normalizeFromDb(rows){
        // db schema: user_cards: { id, token_id, card_type_index, rarity_key, image_url, card_name, estimated_value_eur, opened_at }
        return (rows || []).map(r => {
          const ct = Number(r.card_type_index ?? -1);
          const cat = catalogForCt(ct);
          const ts = r.opened_at ? new Date(r.opened_at).getTime() : Date.now();
          return {
            dbId: r.id,
            tokenId: r.token_id ?? null,
            ts,
            cardTypeIndex: ct,
            img: r.image_url || (cat && cat.img) || "",
            name: r.card_name || (cat && cat.name) || ("Card #" + ct),
            estimated_value_eur: Number(r.estimated_value_eur ?? (CARD_PRICE_EUR_BY_INDEX[ct] ?? 0)) || 0
          };
        }).filter(x => Number.isFinite(x.cardTypeIndex) && x.cardTypeIndex >= 0);
      }

      /********************
       * Rendering
       ********************/
      function render(){
        const grid = document.getElementById("grid");
        const empty = document.getElementById("empty-state");

        const ctFilter = getCtFilterFromUrl();
        const search = (document.getElementById("search").value || "").trim().toLowerCase();
        const sort = document.getElementById("sort").value;

        let items = CARDS.slice();

        if (ctFilter !== null){
          items = items.filter(x => Number(x.cardTypeIndex) === ctFilter);
        }

        // Stats base
        document.getElementById("stat-total").textContent = String(items.length);
        document.getElementById("stat-vault").textContent =
          (vaultValue(items)).toLocaleString("fr-FR", { maximumFractionDigits: 2 }) + "€";

        const best = bestPull(items);
        if (best){
          const ct = Number(best.cardTypeIndex ?? -1);
          const rk = rarityKeyForCt(ct);
          document.getElementById("stat-best").textContent = rk ? rk : "PCA";
          document.getElementById("stat-best-sub").textContent = fmtDate(best.ts || Date.now());
        } else {
          document.getElementById("stat-best").textContent = "—";
          document.getElementById("stat-best-sub").textContent = "—";
        }

        // Group stacks
        let stacks = groupByCardType(items);
        document.getElementById("stat-unique").textContent = String(stacks.length);

        // Search
        if (search){
          stacks = stacks.filter(s => {
            const hay = [
              String(s.cardTypeIndex),
              (s.name || "").toLowerCase(),
              (s.rarityKey || "").toLowerCase(),
              (s.rarityLabel || "").toLowerCase(),
              String(s.price || 0),
              "owned " + String(s.owned),
              (HIDDEN_SET.has(s.cardTypeIndex) ? "pca" : "")
            ].join(" ");
            return hay.includes(search);
          });
        }

        // Sort
        stacks.sort((a,b) => {
          const ra = rarityRank(a.rarityKey);
          const rb = rarityRank(b.rarityKey);

          if (sort === "rarity_desc") return rb - ra;
          if (sort === "rarity_asc") return ra - rb;

          if (sort === "owned_desc") return (b.owned - a.owned) || (rb - ra);
          if (sort === "owned_asc") return (a.owned - b.owned) || (rb - ra);

          if (sort === "price_desc") return (b.price - a.price) || (rb - ra);
          if (sort === "price_asc") return (a.price - b.price) || (rb - ra);

          if (sort === "index_desc") return b.cardTypeIndex - a.cardTypeIndex;
          return a.cardTypeIndex - b.cardTypeIndex;
        });

        // Empty state
        grid.innerHTML = "";
        if (!CARDS.length){
          empty.style.display = "inline-flex";
        } else {
          empty.style.display = "none";
        }

        if (!stacks.length){
          const d = document.createElement("div");
          d.className = "chip";
          d.innerHTML = `<span>Aucun résultat.</span>`;
          grid.appendChild(d);
          return;
        }

        for (const s of stacks){
          const card = document.createElement("div");
          card.className = "card";
          card.setAttribute("data-ct", String(s.cardTypeIndex));

          const thumb = document.createElement("div");
          thumb.className = "thumb";
          thumb.innerHTML = `<img src="${escapeAttr(s.img)}" alt="${escapeAttr(s.name)}"/>`;

          const meta = document.createElement("div");
          meta.className = "meta";

          const left = document.createElement("div");
          left.style.minWidth = "0";
          left.innerHTML = `
            <div class="name">${escapeHtml(s.name)}</div>
            <div class="ct">cardTypeIndex: ${s.cardTypeIndex} · last: #${s.lastTokenId ?? "—"} · ${s.lastTs ? fmtDate(s.lastTs) : "—"}</div>
            <div class="price">Valeur estimée : ${fmtEur(s.price)}</div>
          `;

          const badges = document.createElement("div");
          badges.className = "badges";

          if (s.rarityKey){
            const tag = document.createElement("div");
            tag.className = "tag " + rarityClass(s.rarityKey);
            tag.textContent = s.rarityLabel;
            badges.appendChild(tag);
          }

          const owned = document.createElement("button");
          owned.className = "owned";
          owned.type = "button";
          owned.textContent = "Owned · " + s.owned;
          owned.addEventListener("click", (e) => {
            e.preventDefault();
            e.stopPropagation();
            setCtInUrl(s.cardTypeIndex);
          });

          badges.appendChild(owned);

          meta.appendChild(left);
          meta.appendChild(badges);

          card.appendChild(thumb);
          card.appendChild(meta);

          card.addEventListener("click", () => {
            openModal({
              img: s.img,
              name: s.name + " (ct " + s.cardTypeIndex + ")",
              rarity: s.rarityLabel,
              price: s.price
            });
          });

          grid.appendChild(card);
        }

        // Filter pill UI
        const pill = document.getElementById("filter-pill");
        const clearBtn = document.getElementById("clear-filter");
        if (ctFilter !== null){
          const cat = catalogForCt(ctFilter);
          pill.style.display = "inline-flex";
          pill.textContent = cat ? `Filter: ct=${ctFilter} · ${cat.name}` : `Filter: ct=${ctFilter}`;
          clearBtn.style.display = "inline-flex";
        } else {
          pill.style.display = "none";
          clearBtn.style.display = "none";
        }
      }

      function escapeHtml(s){
        return String(s || "").replace(/[&<>"']/g, (c) => ({
          "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;"
        }[c]));
      }

      function escapeAttr(s){
        return String(s || "").replace(/"/g, "&quot;");
      }

      /********************
       * Actions
       ********************/
      function exportJson(){
        const data = CARDS.slice();
        const blob = new Blob([JSON.stringify({ source: SOURCE, items: data }, null, 2)], { type:"application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "vaultspin_collection.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function resetLocalData(){
        localStorage.removeItem(VS_COLLECTION_KEY);
        closeModal();
        // si on est en local: refresh
        if (SOURCE === "local"){
          CARDS = normalizeFromLocal(getLocalCollection());
          render();
        }
      }

      function setSourceChip(){
        const hint = document.getElementById("hint");
        hint.innerHTML = SOURCE === "db"
          ? `✅ Source : <b>Supabase</b> (user_cards).`
          : `ℹ️ Source : <b>localStorage</b> (démo). Connecte-toi pour voir ta vraie collection.`;
      }

      /********************
       * Init (base)
       ********************/
      document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("back-packs").addEventListener("click", () => {
          window.location.href = "index.html";
        });
        document.getElementById("clear-filter").addEventListener("click", () => {
          clearCtInUrl();
        });
        document.getElementById("export-json").addEventListener("click", exportJson);
        document.getElementById("reset-data").addEventListener("click", resetLocalData);

        document.getElementById("modal-close").addEventListener("click", closeModal);
        document.getElementById("modal").addEventListener("click", (e) => {
          if (e.target.id === "modal") closeModal();
        });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeModal();
        });

        document.getElementById("search").addEventListener("input", render);
        document.getElementById("sort").addEventListener("change", render);

        // Fallback initial: local
        SOURCE = "local";
        CARDS = normalizeFromLocal(getLocalCollection());
        setSourceChip();
        render();
      });
    </script>

    <!-- ✅ AUTH + DB read (Supabase) -->
    <script type="module">
      import { supabase } from "./js/supabaseClient.js";

      const loginBtn  = document.getElementById("vs-login-btn");
      const logoutBtn = document.getElementById("vs-logout-btn");
      const emailEl   = document.getElementById("vs-user-email");

      // === OPTIONAL: upload local -> db once (désactivé) ===
      const ENABLE_LOCAL_TO_DB_MIGRATION = false;

      function setAuthed(label){
        if (emailEl){
          emailEl.style.display = "inline-flex";
          emailEl.textContent = label || "Connecté";
        }
        if (loginBtn) loginBtn.style.display = "none";
        if (logoutBtn) logoutBtn.style.display = "inline-flex";
      }
      function setNotAuthed(){
        if (emailEl){
          emailEl.style.display = "none";
          emailEl.textContent = "—";
        }
        if (loginBtn) loginBtn.style.display = "inline-flex";
        if (logoutBtn) logoutBtn.style.display = "none";
      }

      async function setAuthedFromSession(session){
        const { data, error } = await supabase
          .from("profiles")
          .select("username, display_name")
          .eq("id", session.user.id)
          .maybeSingle();

        const label = (!error && data)
          ? (data.display_name || data.username || session.user.email || "Connecté")
          : (session.user.email || "Connecté");

        setAuthed(label);
      }

      async function fetchDbCards(){
        const { data: { session } } = await supabase.auth.getSession();
        if (!session?.user) return null;

        // On charge tout (MVP). Si tu veux pagination après, je te le fais.
        const { data, error } = await supabase
          .from("user_cards")
          .select("id, token_id, card_type_index, rarity_key, image_url, card_name, estimated_value_eur, opened_at")
          .order("opened_at", { ascending:false })
          .limit(5000);

        if (error) throw error;
        return data || [];
      }

      async function maybeMigrateLocalToDb(){
        if (!ENABLE_LOCAL_TO_DB_MIGRATION) return;

        const { data: { session } } = await supabase.auth.getSession();
        if (!session?.user) return;

        const localRaw = localStorage.getItem("vaultspin_collection_v1");
        if (!localRaw) return;

        let local = [];
        try{ local = JSON.parse(localRaw || "[]"); }catch{ local = []; }
        if (!Array.isArray(local) || !local.length) return;

        // Upload best-effort: on n'essaie pas de dédoublonner dans ce MVP
        // (en prod: on mettrait un unique (user_id, token_id) ou (user_id, opened_at, card_type_index))
        const rows = local.slice(0, 2000).map(x => ({
          user_id: session.user.id,
          token_id: x.tokenId ?? null,
          card_type_index: Number(x.cardTypeIndex ?? -1),
          rarity_key: x.rarityKey || null,
          image_url: x.img || null,
          card_name: x.name || null,
          estimated_value_eur: Number(x.priceEur ?? 0) || 0,
          opened_at: x.ts ? new Date(x.ts).toISOString() : new Date().toISOString()
        })).filter(r => Number.isFinite(r.card_type_index) && r.card_type_index >= 0);

        if (!rows.length) return;

        const { error } = await supabase.from("user_cards").insert(rows);
        if (!error){
          // Optionnel: clear local pour éviter double source
          // localStorage.removeItem("vaultspin_collection_v1");
        }
      }

      async function refreshFromDb(){
        const rows = await fetchDbCards();
        if (!rows) return;

        // bascule DB-first (variables globales du script non-module)
        window.SOURCE = "db";
        window.CARDS = window.normalizeFromDb(rows);
        window.setSourceChip();
        window.render();
      }

      // INIT AUTH STATE
      const { data: { session } } = await supabase.auth.getSession();
      if (session?.user){
        await setAuthedFromSession(session);
        await maybeMigrateLocalToDb();
        await refreshFromDb();
      } else {
        setNotAuthed();
      }

      // React to auth changes
      supabase.auth.onAuthStateChange(async (_event, newSession) => {
        if (newSession?.user){
          await setAuthedFromSession(newSession);
          await maybeMigrateLocalToDb();
          await refreshFromDb();
        } else {
          setNotAuthed();
          // back to local fallback
          window.SOURCE = "local";
          window.CARDS = window.normalizeFromLocal(window.getLocalCollection());
          window.setSourceChip();
          window.render();
        }
      });

      logoutBtn?.addEventListener("click", async () => {
        await supabase.auth.signOut();
      });
    </script>

    <!-- Expose helpers to module scope (small bridge) -->
    <script>
      // Bridge: rendre accessibles au module (sans re-écrire tout en module)
      // (Ces noms existent déjà dans le script principal)
      window.getLocalCollection = window.getLocalCollection || (function(){
        try { return JSON.parse(localStorage.getItem("vaultspin_collection_v1") || "[]"); }
        catch { return []; }
      });

      // expose functions/vars expected by module
      // NOTE: normalizeFromDb / normalizeFromLocal / render / setSourceChip sont déclarées dans le <script> principal
    </script>
  </body>
</html>
