<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>VaultSpin – Leaderboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- ⚠️ CSS inchangé -->
  <!-- (je ne le réécris pas ici pour lisibilité, garde exactement le tien) -->
</head>

<body>
  <!-- UI inchangée -->
  <!-- … tout ton HTML identique … -->

  <script type="module">
    import { supabase } from "./js/supabaseClient.js";

    /********************
     * Helpers dates
     ********************/
    function monthKey(d = new Date()){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      return `${y}-${m}`;
    }

    function monthStartISO(d = new Date()){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      return `${y}-${m}-01`;
    }

    /********************
     * Pack
     ********************/
    function getPackFromUrl(){
      const p = new URLSearchParams(window.location.search);
      const raw = (p.get("pack") || "").toUpperCase();
      if (["PLANT","WATER","FIRE"].includes(raw)) return raw;
      return "ALL";
    }

    function fmtPts(n){ return (Number(n)||0).toLocaleString("fr-FR"); }
    function fmtEur(n){ return (Number(n)||0).toLocaleString("fr-FR",{maximumFractionDigits:0}) + "€"; }

    function rewardForRank(rank){
      if (rank < 1 || rank > 10) return null;
      return 1100 - rank * 100;
    }

    function escapeHtml(s){
      return String(s || "").replace(/[&<>"']/g, c =>
        ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#039;" }[c])
      );
    }

    async function fetchMe(){
      const { data } = await supabase.auth.getSession();
      return data?.session?.user || null;
    }

    /********************
     * DB queries (PACK-AWARE)
     ********************/
    async function fetchLeaderboard(month, pack){
      const { data, error } = await supabase
        .from("user_points_monthly")
        .select("user_id, points, profiles(display_name, username, email)")
        .eq("month", month)
        .eq("pack_key", pack)
        .order("points", { ascending:false })
        .limit(100);

      if (error) throw error;

      return (data || []).map(x => ({
        user_id: x.user_id,
        points: Number(x.points || 0),
        name: x.profiles?.display_name || x.profiles?.username || x.profiles?.email || "Player"
      }));
    }

    async function fetchMyPoints(userId, month, pack){
      if (!userId) return 0;

      const { data, error } = await supabase
        .from("user_points_monthly")
        .select("points")
        .eq("user_id", userId)
        .eq("month", month)
        .eq("pack_key", pack)
        .maybeSingle();

      if (error) throw error;
      return Number(data?.points || 0);
    }

    async function computeMyRank(month, pack, myPoints){
      if (!myPoints) return null;

      const { count, error } = await supabase
        .from("user_points_monthly")
        .select("user_id", { count:"exact", head:true })
        .eq("month", month)
        .eq("pack_key", pack)
        .gt("points", myPoints);

      if (error) throw error;
      return Number(count || 0) + 1;
    }

    /********************
     * Render
     ********************/
    async function render(){
      const month = monthStartISO();
      const monthLabel = monthKey();
      const pack = getPackFromUrl();

      document.getElementById("month-pill").textContent =
        `Mois : ${monthLabel}` + (pack !== "ALL" ? ` · Pack ${pack}` : "");

      const me = await fetchMe();
      const meId = me?.id || null;

      const rows = await fetchLeaderboard(month, pack);
      const myPoints = await fetchMyPoints(meId, month, pack);
      const myRank = await computeMyRank(month, pack, myPoints);

      document.getElementById("stat-players").textContent = rows.length;
      document.getElementById("stat-points").textContent = fmtPts(myPoints);

      if (myRank){
        document.getElementById("stat-rank").textContent = `#${myRank}`;
        const r = rewardForRank(myRank);
        document.getElementById("stat-rank-sub").textContent =
          r ? `Reward actuelle : ${fmtEur(r)}` : "Hors top 10";
      } else {
        document.getElementById("stat-rank").textContent = "—";
        document.getElementById("stat-rank-sub").textContent =
          meId ? "Pas encore classé" : "Connecte-toi pour apparaître";
      }

      const mePill = document.getElementById("me-pill");
      if (meId){
        const meRow = rows.find(r => r.user_id === meId);
        mePill.textContent = `${meRow?.name || "Moi"} · ${fmtPts(myPoints)} pts`;
      } else {
        mePill.textContent = "Non connecté";
      }

      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";

      if (!rows.length){
        tbody.innerHTML = `<div class="empty">Aucun joueur classé ce mois-ci.</div>`;
        return;
      }

      rows.forEach((p, i) => {
        const rank = i + 1;
        const r = rewardForRank(rank);
        const row = document.createElement("div");
        row.className = "trow" + (p.user_id === meId ? " me" : "");
        row.innerHTML = `
          <div class="rank">#${rank}</div>
          <div class="name">${escapeHtml(p.name)}</div>
          <div class="points">${fmtPts(p.points)} <span class="muted">pts</span></div>
          <div class="reward">${r ? fmtEur(r) : "<span class='muted'>—</span>"}</div>
        `;
        tbody.appendChild(row);
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("back-packs").onclick = () => location.href="index.html";
      document.getElementById("back-collection").onclick = () => location.href="collection.html";
      document.getElementById("reset-month").onclick = () => alert("Reset géré côté backend.");
      render().catch(err => {
        console.error(err);
        alert("Erreur leaderboard");
      });
    });
  </script>
</body>
</html>
